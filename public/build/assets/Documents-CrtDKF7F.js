import{b as we,r as y,o as Ce,L as O,f as G,g as S,h as V,i as w,j as ae,G as W,l as le,I as xe,J as ke,F as Ve,x as Ne,t as U,a6 as $e,n as M,P as se}from"./app-DyjZBxuG.js";import{j as _e}from"./jsuites-ic81uAk1.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const Se={class:"grid grid-rows-[55px,1fr]"},Ae={class:"flex-grow mt-10"},Te={key:0,class:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center"},De={class:"bg-white rounded-xl p-6 w-[360px] text-center shadow-lg"},Fe={class:"w-full h-2 bg-gray-200 rounded overflow-hidden"},Ee={class:"mt-2 text-sm text-gray-600"},Pe={key:0,class:"mt-3 text-red-600 text-sm"},Re={__name:"Documents",setup(Be){const ue=we(),g=y(new Date),z=y(null),b=y([]),A=y([]),h=y(null);let l=null;const T=y(!1),x=y(0),N=y("");let D=null;function ce(o){return new Promise(e=>setTimeout(e,o))}function ie(o,e){const t=[];for(let a=0;a<o.length;a+=e)t.push(o.slice(a,a+e));return t}(async()=>{try{const{data:o}=await M.get("/getRowPage/22");A.value=Array.isArray(o)?o:o.items||[],A.value.length&&!h.value&&(h.value=A.value[0].NumberPage,await F(h.value,g.value))}catch(o){console.error("getRowPage error",o)}})();const F=async(o,e)=>{try{const{data:t}=await M.get(`/selectResultBlogs/${o}/${E(e)}`);b.value=t}catch(t){console.error("selectResultBlogs error",t)}},de=async o=>{if(Number(o)===303){ue.push({name:"gmz3-report",query:{date:E(g.value)}});return}h.value=o,await F(h.value,g.value)};function H(){if(!b.value||typeof b.value!="object")return"";const o=Object.keys(b.value||{});if(!o.length)return"";const e=b.value[o[0]];if(!e)return"";const t=Object.keys(e);if(!t.length)return"";const a=e[t[0]];if(!a)return"";const r=Object.keys(a);if(!r.length)return"";const n=a[r[0]];return!n||!n.length?"":n[0].group_name||""}const L=H();l&&L&&l.setValue("A3",L);const fe={A1:"border-left:2px solid #000;border-right:1px solid #fff;border-top:1px solid #000;border-bottom:1px solid #000;w-200;",A2:"background:yellow",B2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",C2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",D2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",E2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",F2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",G2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",H2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",I2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",A3:"border-right:none;border-left:none;font-weight: bold;",B3:"border-right:none;border-left:none;font-weight: bold;",C3:"border-right:none;border-left:none;font-weight: bold;",A4:"font-weight: bold;",B4:"font-weight: bold;",C4:"color:red;font-weight: bold;"};function E(o){if(!o)return"";const e=new Date(o),t=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=e.getFullYear();return`${t}.${a}.${r}`}Ce(()=>{F(g.value);const o=[[E(g.value),...Array(18).fill("")],Array(300).fill("")];function e(a){let r="",n=a;for(;n>=0;)r=String.fromCharCode(n%26+65)+r,n=Math.floor(n/26)-1;return r}const t=Array.from({length:300},(a,r)=>({title:e(r),width:r===0?150:100}));l=_e(z.value,{data:o,style:fe,columns:t,minDimensions:[150,500],merge:[{row:0,col:0,rowspan:1,colspan:14},{row:1,col:0,rowspan:1,colspan:14}],onchange:(a,r,n,s,c)=>{v(n)}}),l.setValue("A1",E(g.value)),l.setValue("C2","OTK"),l.setValue("D2",""),l.setValue("E2","laboratoriyasi"),l.setValue("G2","tahlili")});function ge(o){if(!o)return"";const e=o.split(":");return e[0]+":"+e[1]}function v(o){let e="",t=o;for(;t>=0;)e=String.fromCharCode(t%26+65)+e,t=Math.floor(t/26)-1;return e}function he(o,e,t,a,r,n="#d10000"){const s=e+a-1,c=t+r-1;let d={};for(let u=e;u<=s;u++)d[`${v(t)}${u+1}`]=`border-left: 2px solid ${n};`,d[`${v(c)}${u+1}`]=`border-right: 2px solid ${n};`;for(let u=t;u<=c;u++){const f=v(u);d[`${f}${e+1}`]=`border-top: 2px solid ${n};`,d[`${f}${s+1}`]=`border-bottom: 2px solid ${n};`}o.setStyle(d)}function Q(o){const e=new Date(o),t=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),r=e.getFullYear();return`${t}.${a}.${r}`}function me(o){const e=String(o).toUpperCase().match(/^([A-Z]+)(\d+)$/);if(!e)return null;const t=e[1],a=parseInt(e[2],10)-1;let r=0;for(let n=0;n<t.length;n++)r=r*26+(t.charCodeAt(n)-64);return{x:r-1,y:a}}function be(){if(!l||!l.getData)return[];const o=l.getData();let e=-1,t=-1;for(let r=0;r<o.length;r++){const n=o[r]||[];for(let s=0;s<n.length;s++){const c=n[s];c!==""&&c!==null&&c!==void 0&&(r>e&&(e=r),s>t&&(t=s))}}if(e<0||t<0)return[];const a=[];for(let r=0;r<=e;r++)for(let n=0;n<=t;n++){const s=l.getValueFromCoords(n,r);if(s===""||s===null||s===void 0)continue;const c=`${v(n)}${r+1}`,d=Number(String(s).replace(",","."));a.push({cell:c,value:Number.isFinite(d)?d:null})}return a}async function K(o,e){var c;const t=be();if(!t.length){T.value=!1,x.value=100;return}T.value=!0,x.value=0,N.value="",D={numberPage:o,dateObj:e};const a=t.length,n=ie(t,200);let s=0;for(let d=0;d<n.length;d++){const u=n[d];try{await M.post("/sheet/values/bulk",{numberPage:Number(o),date:Q(e),items:u}),s+=u.length,x.value=Math.min(100,Math.round(s/a*100)),await se()}catch(f){console.error("bulk save error",((c=f==null?void 0:f.response)==null?void 0:c.data)||f),N.value='Saqlashda xatolik. "Qayta urinish" tugmasini bosing.';return}}x.value=100,await ce(150),T.value=!1}async function pe(){D&&await K(D.numberPage,D.dateObj)}function ve(o){return cellsToCacheByPage[o]||cellsToCacheByPage.default}async function ye(o,e,t){if(!l||!Array.isArray(t)||!t.length)return;const a=[];for(const r of t){const n=me(r);if(!n)continue;const s=l.getValueFromCoords(n.x,n.y),c=Number(s);a.push({cell:r,value:isFinite(c)?c:null})}a.length&&await M.post("/sheet/values/bulk",{numberPage:Number(o),date:Q(e),items:a})}return setTimeout(()=>{const o=Number(h.value);if(!o)return;const e=ve(o);ye(o,g.value,e).catch(t=>console.error("cacheSheetValues error",t))},0),O(g,o=>{h.value&&F(h.value,o)}),O(b,()=>{console.log("Qabul qilingan rowData:",b.value);let o=H();console.log("Aniqlangan groupName:",o),l&&o&&l.setValue("A3",o)}),O(b,async()=>{const o=Object.keys(b.value||{});if(!l||!o.length)return;let e=2,t=0,a=0;o.forEach(r=>{var d;const n=b.value[r],s=Object.keys(n);let c=0;s.forEach(u=>{var ee,te;const f=n[u],P=Object.keys(f),Y=new Set;P.forEach(i=>{(f[i]||[]).forEach(m=>Y.add(m.parameter_name))});const q=Array.from(Y),J=Array.from(new Set(P.map(i=>{var m;return((m=(f[i]||[])[0])==null?void 0:m.time_name)||""}))).sort(),R=q.length+1,Z=J.length+3;c=Math.max(c,Z),l.setValueFromCoords(t,e,((te=(ee=f[P[0]])==null?void 0:ee[0])==null?void 0:te.group_name)||""),l.setValueFromCoords(t,e+1,`${u}-Smena`);const B={};for(let i=0;i<R;i++){const p=`${v(t+i)}${e+1}`;B[p]="background: #c7efc4; font-weight: bold;";const m=`${v(t+i)}${e+2}`;B[m]="background: #cfe2f3; font-weight: bold;";const $=`${v(t+i)}${e+3}`;B[$]="background: #c9b2d6; font-weight: bold;"}setTimeout(()=>l.setStyle(B),10),l.setValueFromCoords(t,e+2,"Vaqt"),q.forEach((i,p)=>{l.setValueFromCoords(t+1+p,e+2,i)});const X=new Map;q.forEach((i,p)=>X.set(i,p)),J.forEach((i,p)=>{const m=e+3+p;l.setValueFromCoords(t,m,ge(i));const $=l.getCellFromCoords(t,m);$&&($.style.backgroundColor="#bbfcc1",$.style.fontWeight="bold");const oe=[];P.forEach(C=>{var _;const j=f[C]||[];((_=j[0])==null?void 0:_.time_name)===i&&oe.push(...j)}),oe.forEach(C=>{const j=C.parameter_name,_=X.get(j);if(_===void 0)return;const ne=t+1+_,I=Number(C.Value);l.setValueFromCoords(ne,m,isNaN(I)?C.Value:I);const re=Number(C.Min),k=l.getCellFromCoords(ne,m);k&&!isNaN(I)&&!isNaN(re)&&I<re&&(k.style.backgroundColor="yellow",k.style.color="red",k.style.fontWeight="bold"),C.WithFormula==="1"&&k&&(k.style.border="1px dashed #444")})}),setTimeout(()=>he(l,e,t,Z,R,"#d10000"),10),a+=1,a%2===0?(e+=c+2,t=0):t+=R+2}),a%2!==0&&(e+=c+2,t=0,a=0),se();try{const u=Number(h.value);u&&K(u,g.value)}catch(u){console.error("cacheWholeSheet error",((d=u==null?void 0:u.response)==null?void 0:d.data)||u)}})}),(o,e)=>{const t=G("VaDateInput"),a=G("VaTab"),r=G("VaTabs");return V(),S("div",Se,[e[3]||(e[3]=w("main",null,null,-1)),w("main",Ae,[ae(t,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=n=>g.value=n),class:"mb-10",onchange:"fetchData(value)"},null,8,["modelValue"]),ae(r,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=n=>h.value=n),class:"mb-6"},{default:le(()=>[(V(!0),S(xe,null,ke(A.value,n=>(V(),Ve(a,{key:n.NumberPage,name:n.NumberPage,onClick:s=>de(n.NumberPage)},{default:le(()=>[Ne(U(n.Name),1)]),_:2},1032,["name","onClick"]))),128))]),_:1},8,["modelValue"]),w("div",{ref_key:"sheetEl",ref:z,style:{width:"100vw",height:"100vh"}},null,512),T.value?(V(),S("div",Te,[w("div",De,[e[2]||(e[2]=w("div",{class:"text-lg font-semibold mb-3"},"Keshga yozilmoqdaâ€¦",-1)),w("div",Fe,[w("div",{class:"h-2 rounded",style:$e({width:x.value+"%",background:"#3b82f6"})},null,4)]),w("div",Ee,U(x.value)+"%",1),N.value?(V(),S("div",Pe,U(N.value),1)):W("",!0),N.value?(V(),S("button",{key:1,class:"mt-4 px-4 py-2 rounded bg-blue-600 text-white",onClick:pe}," Qayta urinish ")):W("",!0)])])):W("",!0)])])}}};export{Re as default};
