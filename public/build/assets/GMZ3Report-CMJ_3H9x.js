import{u as ie,r as A,o as de,K as q,g as ce,h as ue,i as L,j as U,l as fe,x as ge,k as W,z as pe,aj as me,n as V}from"./app-c0G7Ml5G.js";import{j as be}from"./jsuites-BZEcaF7L.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const he={class:"p-3 pt-28"},ye={class:"flex items-center gap-3 mb-3"},D=303,ve={__name:"GMZ3Report",setup(we){const{init:F}=ie(),R=A(null),h=A(new Date);let r=null;const M=A([]),B=A({});let I=!1;const S=A(new Map);let H=!1;const v=A([]),K=n=>{const e=new Date(n);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function z(){try{const{data:n}=await V.get(`/static-with-numberpage/${D}`),e=Array.isArray(n)?n:n.items||[];v.value=e}catch(n){console.error(n),F({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function X(n){const e=new Date(n),a=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),t=e.getFullYear();return`${a}.${s}.${t}`}function N(n){let e="",a=n;for(;a>=0;)e=String.fromCharCode(a%26+65)+e,a=Math.floor(a/26)-1;return e}function O(n){const e=n.match(/^([A-Z]+)(\d+)$/),a=+e[2]-1;let s=0;for(const t of e[1])s=s*26+(t.charCodeAt(0)-64);return{x:s-1,y:a}}function x(n){const[e,a]=n.split(":"),s=O(e),t=O(a);return{row:Math.min(s.y,t.y),col:Math.min(s.x,t.x),rowspan:Math.abs(s.y-t.y)+1,colspan:Math.abs(s.x-t.x)+1}}async function Q(){try{const{data:n}=await V.get("/periodType");M.value=Array.isArray(n)?n:n.items||[]}catch(n){console.error(n),F({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function ee(){const n=new Map((M.value||[]).map(l=>[String(l.id),String(l.name||"").trim()])),e=[...new Set((v.value||[]).map(l=>l==null?void 0:l.period_type_id).filter(l=>l!=null).map(String))],a=l=>{const i=String(l||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(i)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(i)?"Oylik":l?l.charAt(0).toUpperCase()+l.slice(1):""},s=l=>{const i=e.find(c=>new RegExp(l,"i").test(n.get(c)||""));return i?a(n.get(i)):null};let t=s("kun|sutk"),o=s("oy|mes");if(!t&&e.includes("1")&&(t="Kunlik"),!o&&e.includes("2")&&(o="Oylik"),!t||!o){const l=[...e].sort((i,c)=>Number(i)-Number(c));if(!t&&l[0]&&(t=a(n.get(l[0])||"Kunlik")),!o){const i=l.find(c=>c!==l[0])||l[0];o=a(n.get(i)||"Oylik")}}return t===o&&(t==="Kunlik"?o="Oylik":o==="Oylik"?t="Kunlik":(t="Kunlik",o="Oylik")),{dailyLabel:t,monthlyLabel:o}}async function E(){H=!0,S.value.clear(),S.value=new Map;const n=ae(v.value),e=n.reduce((u,m)=>u+m.groups.reduce((f,p)=>f+p.params.length,0),0),a=n.reduce((u,m)=>u+m.groups.filter(f=>!!f.gName).length,0),s=n.length*2,t=7+e+a+s+5,o=150,l=Math.max(t,150),i=Array.from({length:l},()=>Array(o).fill(""));r&&(r.destroy(),r=null),r=be(R.value,{data:i,columns:Array.from({length:o},(u,m)=>({title:N(m),width:m===0?520:m===1?120:110})),minDimensions:[o,l],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[x("A1:F1"),x("A2:F2"),x("B4:B5"),x("C4:E4")],onchange:async(u,m,f,p,w)=>{if(I||H)return;const $=Number(p)+1,k=Number(f),_=`${N(k)}${$}`;if(!(!S.value.get($)||!J(k)))try{typeof w=="string"&&w.trim().startsWith("=")?(await se(_,w.trim()),await new Promise(G=>requestAnimationFrame(G)),await P(_,{toast:!0})):await P(_,{toast:!0})}catch(G){console.error(G),F({message:"Saqlashda xatolik",color:"danger"})}}}),r.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),r.setValue("A2",`${X(h.value)} y.`),r.setValue("A3","—"),r.setValue("A4","Ko'rsatgichlar nomi."),r.setValue("B4","o'lchov birligi");const{dailyLabel:c,monthlyLabel:g}=ee();console.log(c,g),r.setValue("C4",c),r.setValue("C5","reja"),r.setValue("D4",c),r.setValue("D5","fakt/20:08"),r.setValue("E4",c),r.setValue("E5","fakt/08:20"),r.setValue("F4",c),r.setValue("F5","fakt jami"),r.setValue("G4",""),r.setValue("G5","%"),r.setValue("H4",g),r.setValue("H5","reja"),r.setValue("I4",g),r.setValue("I5","fakt"),r.setValue("J4",g),r.setValue("J5","%"),r.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const b={};["A","B","C","D","E","F"].forEach(u=>b[`${u}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(u=>b[`${u}5`]="border:1px solid #bdbdbd;"),r.setStyle(b);function y(u,m){try{typeof r.setMerge=="function"&&r.setMerge(`A${u}`,10,1)}catch{}const f={};for(let p=0;p<=9;p++)f[`${N(p)}${u}`]=m;r.setStyle(f)}let d=7;for(const u of n){r.setValue(`A${d}`,u.fsName),y(d,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),r.setHeight(d-1,28),d++;for(const m of u.groups){m.gName&&(r.setValue(`A${d}`,m.gName),y(d,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),r.setHeight(d-1,26),d++);for(const f of m.params){S.value.set(d,{fsId:f.fsId,groupId:f.groupId,parameterId:f.parameterId}),S.value.set(d,{fsId:f.fsId,groupId:f.groupId,parameterId:f.parameterId}),r.setValue(`A${d}`,f.name),r.setValue(`B${d}`,f.unit);const p={};p[`A${d}`]="border:1px solid #dddddd;padding-left:6px;",p[`B${d}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(w=>{p[`${w}${d}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),r.setStyle(p),r.setHeight(d-1,24),d++}}d++}r.setHeight(0,34),r.setHeight(1,28),r.setHeight(3,28),r.setHeight(4,24),await ne(),await le(),H=!1}async function te(n,e,a){const{data:s}=await V.get("/sheet/value",{params:{numberPage:n,cell:e,date:K(a)}});return Number((s==null?void 0:s.value)??0)}function T(){const n=new Map((M.value||[]).map(o=>[String(o.id),String(o.name||"").trim().toLowerCase()])),e=[...new Set((v.value||[]).map(o=>o==null?void 0:o.period_type_id).filter(o=>o!=null).map(String))],a=o=>e.find(l=>o.some(i=>(n.get(l)||"").includes(i)));let s=a(["kun","sutk"])||(e.includes("1")?"1":null),t=a(["oy","mes"])||(e.includes("2")?"2":null);return!s&&e.length&&(s=e[0]),!t&&e.length&&(t=e.find(o=>o!==s)||e[0]),{dailyId:Number(s),monthlyId:Number(t)}}function C(n){const e=new Date(n);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function j(n){const e=new Date(n),a=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0);return{start:C(a),end:C(s)}}function J(n){const e=N(n);return["C","D","E","F","G"].includes(e)?"daily":["H","I","J"].includes(e)?"monthly":null}async function ne(){const n=v.value||[];if(!n.length)return;const{dailyId:e,monthlyId:a}=T(),s=C(h.value),{start:t,end:o}=j(h.value),l=new Map;for(const[c,g]of S.value.entries())l.set(String(g.parameterId),c);const i=I;I=!0;for(const c of n){const g=String(c.ParameterID||""),b=l.get(g);if(!b)continue;const y=Number(c.period_type_id),d=String(c.period_start_date||""),u=String(c.period_end_date||d||"");if(!(y===e&&d===s&&u===s)&&!(y===a&&d===t&&u===o))continue;const p=c.Comment||(y===e?"daily_plan":"monthly_plan"),w=re(p);w&&r.setValue(`${w}${b}`,c.value)}I=i}function ae(n){const e=new Map,a=new Set;n.forEach(t=>{const o=(t==null?void 0:t.FactoryStructureID)??null,l=(t==null?void 0:t.FSName)||(o!=null?`Struktura #${o}`:"Struktura"),i=(t==null?void 0:t.GroupID)??null,c=(t==null?void 0:t.GName)||(i!=null?`Guruh #${i}`:null),g=(t==null?void 0:t.ParameterID)??(t==null?void 0:t.id)??(t==null?void 0:t.Uuid);if(g&&a.has(`${o}:${i}:${g}`))return;g&&a.add(`${o}:${i}:${g}`);const b=(t==null?void 0:t.PName)||(t==null?void 0:t.Name)||`Param ${g}`,y=(t==null?void 0:t.UName)||"tn.";e.has(o)||e.set(o,{fsId:o,fsName:l,groups:new Map});const d=e.get(o),u=i??"_nogroup";d.groups.has(u)||d.groups.set(u,{groupId:i,gName:c,params:[]}),d.groups.get(u).params.push({name:b,unit:y,fsId:o,groupId:i,parameterId:g})});const s=Array.from(e.values()).sort((t,o)=>String(t.fsId).localeCompare(String(o.fsId),void 0,{numeric:!0}));return s.forEach(t=>{t.groups=Array.from(t.groups.values()).sort((o,l)=>String(o.groupId).localeCompare(String(l.groupId),void 0,{numeric:!0}))}),s}async function Z(n,e){let a=String(n).trim();const s=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,t=/'?(\d+)'?\!([A-Z]+\d+)/g,o=[];a.replace(s,(c,g,b)=>(o.push({page:+g,cell:b}),"")),a.replace(t,(c,g,b)=>(o.push({page:+g,cell:b}),""));const l=await Promise.all(o.map(c=>te(c.page,c.cell,e)));let i=0;return a=a.replace(s,()=>String(l[i++])),a=a.replace(t,()=>String(l[i++])),a.startsWith("=")||(a="="+a),a}function oe(n){switch(n){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function re(n){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[n]||null}async function se(n,e){B.value[n]=e;const a=n.match(/\d+/),s=a?Number(a[0]):null,t=s?S.value.get(s):null;await V.post("/sheet/formula",{numberPage:D,number_page:D,param_id:(t==null?void 0:t.parameterId)||null,cell:n,expr:e,scope:"permanent",date:C(h.value),for_date:null});const o=await Z(e,h.value);I=!0,r.setValue(n,o),I=!1,await new Promise(i=>requestAnimationFrame(i));const l={};l[n]="border:1px dashed #444;font-weight:600;",r.setStyle(l)}async function le(){const{data:n}=await V.get("/sheet/formula",{params:{numberPage:D,date:K(h.value)}});((n==null?void 0:n.items)||n||[]).forEach(e=>{B.value[e.cell]=e.expr});for(const[e,a]of Object.entries(B.value))try{const s=await Z(a,h.value);I=!0,r.setValue(e,s),I=!1;const t={};t[e]="border:1px dashed #444;font-weight:600;",r.setStyle(t),await P(e)}catch(s){console.error("Formula error",e,a,s)}}async function P(n,{toast:e=!1}={}){const a=n.match(/^([A-Z]+)(\d+)$/);if(!a)return;const s=a[1],t=Number(a[2]),o=(k=>{let _=0;for(const Y of k)_=_*26+(Y.charCodeAt(0)-64);return _-1})(s),l=t-1,i=S.value.get(t);if(!i)return;const{dailyId:c,monthlyId:g}=T(),b=J(o),y=b==="daily"?c:g;let d=r.getValueFromCoords(o,l,!0);typeof d=="string"&&(d=d.replace(",","."));const u=parseFloat(d),m=Number.isFinite(u)?u:null;if(m===null)return;let f,p;if(b==="daily"){const k=C(h.value);f=k,p=k}else{const{start:k,end:_}=j(h.value);f=k,p=_}const w=oe(s),$=await V.post("/static-params/upsert",{number_page:D,factory_structure_id:i.fsId,parameter_id:i.parameterId,group_id:i.groupId,period_type_id:y,period_start_date:f,period_end_date:p,value:m,comment:w});e&&$&&$.status>=200&&$.status<300&&F({message:"Maʼlumot saqlandi",color:"success"})}return de(async()=>{await Promise.all([z(),Q()]),E()}),q(h,E),q([v,M],E),(n,e)=>(ue(),ce("div",he,[L("div",ye,[U(W(pe),{preset:"secondary",onClick:e[0]||(e[0]=a=>n.$router.back())},{default:fe(()=>e[2]||(e[2]=[ge("← Orqaga",-1)])),_:1,__:[2]}),U(W(me),{modelValue:h.value,"onUpdate:modelValue":[e[1]||(e[1]=a=>h.value=a),E]},null,8,["modelValue"]),e[3]||(e[3]=L("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),L("div",{ref_key:"sheetEl",ref:R,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{ve as default};
