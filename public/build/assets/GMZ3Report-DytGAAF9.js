import{u as ie,r as A,o as de,K as Y,g as ue,h as ce,i as K,j as q,l as fe,x as ge,k as U,z as pe,aj as me,n as V}from"./app--pccVFgN.js";import{j as be}from"./jsuites-B_NmqyPI.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const he={class:"p-3 pt-28"},ye={class:"flex items-center gap-3 mb-3"},D=303,ve={__name:"GMZ3Report",setup(we){const{init:N}=ie(),L=A(null),h=A(new Date);let r=null;const F=A([]),B=A({});let I=!1;const S=A(new Map);let H=!1;const v=A([]),R=n=>{const e=new Date(n);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function W(){try{const{data:n}=await V.get(`/static-with-numberpage/${D}`),e=Array.isArray(n)?n:n.items||[];v.value=e}catch(n){console.error(n),N({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function X(n){const e=new Date(n),o=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),t=e.getFullYear();return`${o}.${s}.${t}`}function M(n){let e="",o=n;for(;o>=0;)e=String.fromCharCode(o%26+65)+e,o=Math.floor(o/26)-1;return e}function O(n){const e=n.match(/^([A-Z]+)(\d+)$/),o=+e[2]-1;let s=0;for(const t of e[1])s=s*26+(t.charCodeAt(0)-64);return{x:s-1,y:o}}function x(n){const[e,o]=n.split(":"),s=O(e),t=O(o);return{row:Math.min(s.y,t.y),col:Math.min(s.x,t.x),rowspan:Math.abs(s.y-t.y)+1,colspan:Math.abs(s.x-t.x)+1}}async function Q(){try{const{data:n}=await V.get("/periodType");F.value=Array.isArray(n)?n:n.items||[]}catch(n){console.error(n),N({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function ee(){const n=new Map((F.value||[]).map(l=>[String(l.id),String(l.name||"").trim()])),e=[...new Set((v.value||[]).map(l=>l==null?void 0:l.period_type_id).filter(l=>l!=null).map(String))],o=l=>{const i=String(l||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(i)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(i)?"Oylik":l?l.charAt(0).toUpperCase()+l.slice(1):""},s=l=>{const i=e.find(d=>new RegExp(l,"i").test(n.get(d)||""));return i?o(n.get(i)):null};let t=s("kun|sutk"),a=s("oy|mes");if(!t&&e.includes("1")&&(t="Kunlik"),!a&&e.includes("2")&&(a="Oylik"),!t||!a){const l=[...e].sort((i,d)=>Number(i)-Number(d));if(!t&&l[0]&&(t=o(n.get(l[0])||"Kunlik")),!a){const i=l.find(d=>d!==l[0])||l[0];a=o(n.get(i)||"Oylik")}}return t===a&&(t==="Kunlik"?a="Oylik":a==="Oylik"?t="Kunlik":(t="Kunlik",a="Oylik")),{dailyLabel:t,monthlyLabel:a}}async function E(){H=!0,S.value.clear(),S.value=new Map;const n=ae(v.value),e=n.reduce((c,m)=>c+m.groups.reduce((g,p)=>g+p.params.length,0),0),o=n.reduce((c,m)=>c+m.groups.filter(g=>!!g.gName).length,0),s=n.length*2,t=7+e+o+s+5,a=150,l=Math.max(t,150),i=Array.from({length:l},()=>Array(a).fill(""));r&&(r.destroy(),r=null),r=be(L.value,{data:i,columns:Array.from({length:a},(c,m)=>({title:M(m),width:m===0?520:m===1?120:110})),minDimensions:[a,l],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[x("A1:F1"),x("A2:F2"),x("B4:B5"),x("C4:E4")],onchange:async(c,m,g,p,w)=>{if(I||H)return;const $=Number(p)+1,k=Number(g),_=`${M(k)}${$}`;if(!(!S.value.get($)||!J(k)))try{typeof w=="string"&&w.trim().startsWith("=")?(await se(_,w.trim()),await new Promise(G=>requestAnimationFrame(G)),await P(_,{toast:!0})):await P(_,{toast:!0})}catch(G){console.error(G),N({message:"Saqlashda xatolik",color:"danger"})}}}),r.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),r.setValue("A2",`${X(h.value)} y.`),r.setValue("A3","—"),r.setValue("A4","Ko'rsatgichlar nomi."),r.setValue("B4","o'lchov birligi");const{dailyLabel:d,monthlyLabel:f}=ee();console.log(d,f),r.setValue("C4",d),r.setValue("C5","reja"),r.setValue("D4",d),r.setValue("D5","fakt/20:08"),r.setValue("E4",d),r.setValue("E5","fakt/08:20"),r.setValue("F4",d),r.setValue("F5","fakt jami"),r.setValue("G4",""),r.setValue("G5","%"),r.setValue("H4",f),r.setValue("H5","reja"),r.setValue("I4",f),r.setValue("I5","fakt"),r.setValue("J4",f),r.setValue("J5","%"),r.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const b={};["A","B","C","D","E","F"].forEach(c=>b[`${c}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(c=>b[`${c}5`]="border:1px solid #bdbdbd;"),r.setStyle(b);function y(c,m){try{typeof r.setMerge=="function"&&r.setMerge(`A${c}`,10,1)}catch{}const g={};for(let p=0;p<=9;p++)g[`${M(p)}${c}`]=m;r.setStyle(g)}let u=7;for(const c of n){r.setValue(`A${u}`,c.fsName),y(u,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),r.setHeight(u-1,28),u++;for(const m of c.groups){m.gName&&(r.setValue(`A${u}`,m.gName),y(u,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),r.setHeight(u-1,26),u++);for(const g of m.params){S.value.set(u,{fsId:g.fsId,groupId:g.groupId,parameterId:g.parameterId}),S.value.set(u,{fsId:g.fsId,groupId:g.groupId,parameterId:g.parameterId}),r.setValue(`A${u}`,g.name),r.setValue(`B${u}`,g.unit);const p={};p[`A${u}`]="border:1px solid #dddddd;padding-left:6px;",p[`B${u}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(w=>{p[`${w}${u}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),r.setStyle(p),r.setHeight(u-1,24),u++}}u++}r.setHeight(0,34),r.setHeight(1,28),r.setHeight(3,28),r.setHeight(4,24),await ne(),await le(),H=!1}async function te(n,e,o){const{data:s}=await V.get("/sheet/value",{params:{numberPage:n,cell:e,date:R(o)}});return Number((s==null?void 0:s.value)??0)}function T(){const n=new Map((F.value||[]).map(a=>[String(a.id),String(a.name||"").trim().toLowerCase()])),e=[...new Set((v.value||[]).map(a=>a==null?void 0:a.period_type_id).filter(a=>a!=null).map(String))],o=a=>e.find(l=>a.some(i=>(n.get(l)||"").includes(i)));let s=o(["kun","sutk"])||(e.includes("1")?"1":null),t=o(["oy","mes"])||(e.includes("2")?"2":null);return!s&&e.length&&(s=e[0]),!t&&e.length&&(t=e.find(a=>a!==s)||e[0]),{dailyId:Number(s),monthlyId:Number(t)}}function C(n){const e=new Date(n);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function j(n){const e=new Date(n),o=new Date(e.getFullYear(),e.getMonth(),1),s=new Date(e.getFullYear(),e.getMonth()+1,0);return{start:C(o),end:C(s)}}function J(n){const e=M(n);return["C","D","E","F","G"].includes(e)?"daily":["H","I","J"].includes(e)?"monthly":null}async function ne(){const n=v.value||[];if(!n.length)return;const{dailyId:e,monthlyId:o}=T(),s=C(h.value),{start:t,end:a}=j(h.value),l=new Map;for(const[d,f]of S.value.entries())l.set(String(f.parameterId),d);const i=I;I=!0;for(const d of n){const f=String(d.ParameterID||""),b=l.get(f);if(!b)continue;const y=Number(d.period_type_id),u=String(d.period_start_date||""),c=String(d.period_end_date||u||"");if(!(y===e&&u===s&&c===s)&&!(y===o&&u===t&&c===a))continue;const p=d.Comment||(y===e?"daily_plan":"monthly_plan"),w=re(p);w&&r.setValue(`${w}${b}`,d.value)}I=i}function ae(n){const e=new Map,o=new Set;n.forEach(t=>{const a=(t==null?void 0:t.FactoryStructureID)??null,l=(t==null?void 0:t.FSName)||(a!=null?`Struktura #${a}`:"Struktura"),i=(t==null?void 0:t.GroupID)??null,d=i!=null?(t==null?void 0:t.GName)||`Guruh #${i}`:null,f=(t==null?void 0:t.ParameterID)??(t==null?void 0:t.id)??(t==null?void 0:t.Uuid);if(f&&o.has(`${a}:${i}:${f}`))return;f&&o.add(`${a}:${i}:${f}`);const b=(t==null?void 0:t.PName)||(t==null?void 0:t.Name)||`Param ${f}`,y=(t==null?void 0:t.UName)||"tn.";e.has(a)||e.set(a,{fsId:a,fsName:l,groups:new Map});const u=e.get(a),c=i==null?"zzz_nogroup":`g_${i}`;u.groups.has(c)||u.groups.set(c,{groupId:i,gName:d,params:[]}),u.groups.get(c).params.push({name:b,unit:y,fsId:a,groupId:i,parameterId:f})});const s=Array.from(e.values()).sort((t,a)=>String(t.fsId).localeCompare(String(a.fsId),void 0,{numeric:!0}));return s.forEach(t=>{t.groups=Array.from(t.groups.values()).sort((a,l)=>{const i=a.groupId==null,d=l.groupId==null;if(i&&!d)return 1;if(!i&&d)return-1;const f=a.gName??a.groupId??"",b=l.gName??l.groupId??"";return String(f).localeCompare(String(b),void 0,{numeric:!0})})}),s}async function Z(n,e){let o=String(n).trim();const s=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,t=/'?(\d+)'?\!([A-Z]+\d+)/g,a=[];o.replace(s,(d,f,b)=>(a.push({page:+f,cell:b}),"")),o.replace(t,(d,f,b)=>(a.push({page:+f,cell:b}),""));const l=await Promise.all(a.map(d=>te(d.page,d.cell,e)));let i=0;return o=o.replace(s,()=>String(l[i++])),o=o.replace(t,()=>String(l[i++])),o.startsWith("=")||(o="="+o),o}function oe(n){switch(n){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function re(n){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[n]||null}async function se(n,e){B.value[n]=e;const o=n.match(/\d+/),s=o?Number(o[0]):null,t=s?S.value.get(s):null;await V.post("/sheet/formula",{numberPage:D,number_page:D,param_id:(t==null?void 0:t.parameterId)||null,cell:n,expr:e,scope:"permanent",date:C(h.value),for_date:null});const a=await Z(e,h.value);I=!0,r.setValue(n,a),I=!1,await new Promise(i=>requestAnimationFrame(i));const l={};l[n]="border:1px dashed #444;font-weight:600;",r.setStyle(l)}async function le(){const{data:n}=await V.get("/sheet/formula",{params:{numberPage:D,date:R(h.value)}});((n==null?void 0:n.items)||n||[]).forEach(e=>{B.value[e.cell]=e.expr});for(const[e,o]of Object.entries(B.value))try{const s=await Z(o,h.value);I=!0,r.setValue(e,s),I=!1;const t={};t[e]="border:1px dashed #444;font-weight:600;",r.setStyle(t),await P(e)}catch(s){console.error("Formula error",e,o,s)}}async function P(n,{toast:e=!1}={}){const o=n.match(/^([A-Z]+)(\d+)$/);if(!o)return;const s=o[1],t=Number(o[2]),a=(k=>{let _=0;for(const z of k)_=_*26+(z.charCodeAt(0)-64);return _-1})(s),l=t-1,i=S.value.get(t);if(!i)return;const{dailyId:d,monthlyId:f}=T(),b=J(a),y=b==="daily"?d:f;let u=r.getValueFromCoords(a,l,!0);typeof u=="string"&&(u=u.replace(",","."));const c=parseFloat(u),m=Number.isFinite(c)?c:null;if(m===null)return;let g,p;if(b==="daily"){const k=C(h.value);g=k,p=k}else{const{start:k,end:_}=j(h.value);g=k,p=_}const w=oe(s),$=await V.post("/static-params/upsert",{number_page:D,factory_structure_id:i.fsId,parameter_id:i.parameterId,group_id:i.groupId,period_type_id:y,period_start_date:g,period_end_date:p,value:m,comment:w});e&&$&&$.status>=200&&$.status<300&&N({message:"Maʼlumot saqlandi",color:"success"})}return de(async()=>{await Promise.all([W(),Q()]),E()}),Y(h,E),Y([v,F],E),(n,e)=>(ce(),ue("div",he,[K("div",ye,[q(U(pe),{preset:"secondary",onClick:e[0]||(e[0]=o=>n.$router.back())},{default:fe(()=>e[2]||(e[2]=[ge("← Orqaga",-1)])),_:1,__:[2]}),q(U(me),{modelValue:h.value,"onUpdate:modelValue":[e[1]||(e[1]=o=>h.value=o),E]},null,8,["modelValue"]),e[3]||(e[3]=K("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),K("div",{ref_key:"sheetEl",ref:L,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{ve as default};
