import{c as X,r as n,d as Y,v as Z,I as ee,y as ae,J as te,f as V,o as le,g as re,h as T,j as y,i as ne,l as f}from"./app-4d998b01.js";/* empty css                   */import{f as D}from"./format-45c98358.js";const se={class:"grid grid-rows-[55px,1fr]"},oe=T("main",null,null,-1),de={class:"flex flex-col"},ce={class:"m-2"},ue="yyyy-MM-dd",ge={__name:"ParametrValue",setup(ie){const{t,locale:S}=X(),O=n([]),o=n(null),w=n({}),x=n([]),v=n(new Date);n(null),n(null);const d=n(null),B=store.state.user.id,E=n([]),g=Y({Change:"1"}),N=n([{headerName:t("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center"},{headerName:t("table.change"),field:"Change",width:80,headerClass:"header-center"},{headerName:t("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center"},{headerName:t("table.parameters"),field:Z(()=>S.value==="ru"?"PNameRus":"PName"),flex:1,headerClass:"header-center"},{headerName:t("table.graphictimes"),headerClass:"header-center",children:[{headerName:t("table.startingTime"),field:"STime",width:120,valueFormatter:e=>D(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center"},{headerName:t("table.endingTime"),field:"ETime",width:120,valueFormatter:e=>D(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center"}]},{headerName:t("table.interval"),headerClass:"header-center",children:[{headerName:t("table.min"),field:"Min",width:100,headerClass:"header-center"},{headerName:t("table.max"),field:"Max",width:100,headerClass:"header-center"}]},{headerName:t("table.value"),field:"Value",flex:1,editable:!0,cellEditor:"agNumberCellEditor",cellClassRules:{"cell-green":e=>e.data&&e.data.Value===w.value[e.data.id],"cell-yellow":e=>e.data&&e.data.Value!==w.value[e.data.id]&&w.value[e.data.id]===void 0},cellStyle:{"font-size":"16px","text-align":"center"},headerClass:"header-center"},{headerName:t("table.comment"),field:"Comment",flex:1,editable:!0,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]),$=async()=>{try{const e=await f.get("/changes");x.value=e.data.map(a=>({value:a.Change,text:a.Change}))}catch(e){console.error("Error fetching graphics data:",e)}},H={sortable:!0,filter:!0,resizable:!0},M=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",L={columnDefs:N.value,getRowClass:M,headerHeight:43},c=async()=>{try{const e=g.Change,a=D(v.value,ue),[l,m]=await f.all([f.get(`/get-params-for-user/${store.state.user.structure_id}/${e}/${a}`),f.get(`/vparams/${store.state.user.structure_id}`)]),h=l.data.map(r=>`${r.ParametersID}_${r.GTid}`),s=E.value.map(r=>`${r.ParametersID}_${r.GTid}`),G=new Set(h),P=new Set(s),K=G.difference(P),Q=P.difference(G),b=[...K].concat([...Q]).map(r=>l.data.find(C=>r==`${C.ParametersID}_${C.GTid}`)),W=m.data;b.forEach((r,C)=>{const R=W.find(F=>F.TimeID==r.GTid&&F.ParametersID==r.ParametersID);R&&(b[C]={...r,...R})}),o.value.applyTransaction({add:b,addIndex:0}),E.value=l.data}catch(e){console.error("Error fetching data:",e)}},U=async e=>{const{data:a,colDef:l,newValue:m,oldValue:h}=e;if(m!==h)try{await k(a);const s=e.rowIndex;o.value&&o.value.ensureIndexVisible(s,"bottom")}catch(s){console.error("Error saving data",s)}};console.log(store.state.user.id);const k=async e=>{try{const a=await f.post("/vparams",{...e,userId:B});return z(),c(),a}catch(a){console.error("Error saving data",a)}},z=()=>{o.value&&o.value.clearFocusedCell()},j=()=>{p.value&&o.value&&(o.value.stopEditing(),p.value=!1,c())};let u=null,i=null,p=n(!1);const A=e=>{const{column:a}=e;if(a){const l=a.getColId();l==="Value"||l==="Comment"?(_(),p.value=!0,d.value&&clearTimeout(d.value),d.value=setTimeout(j,3e4)):I()}},J=e=>{const{column:a}=e;if(a){const l=a.getColId();(l==="Value"||l==="Comment")&&(_(),p.value=!1,d.value&&(clearTimeout(d.value),d.value=null))}},I=()=>{u||(u=setInterval(c,5e3)),i||(i=setInterval($,5e3))},_=()=>{u&&(clearInterval(u),u=null),i&&(clearInterval(i),i=null)},q=e=>{o.value=e.api,e.api.addEventListener("cellFocused",A),e.api.addEventListener("cellBlurred",J),I()};return ee([()=>g.Change,()=>v.value],c),ae(()=>{c(),$(),I()}),te(()=>{_()}),(e,a)=>{const l=V("VaSelect"),m=V("VaDateInput"),h=V("ag-grid-vue");return le(),re("div",se,[oe,T("main",de,[T("div",ce,[y(l,{modelValue:g.Change,"onUpdate:modelValue":a[0]||(a[0]=s=>g.Change=s),"value-by":"value",class:"mr-2",label:ne(t)("menu.changes"),options:x.value,clearable:""},null,8,["modelValue","label","options"]),y(m,{modelValue:v.value,"onUpdate:modelValue":a[1]||(a[1]=s=>v.value=s),label:"Day"},null,8,["modelValue"])]),y(h,{rowData:O.value,columnDefs:N.value,defaultColDef:H,gridOptions:L,animateRows:"true",class:"ag-theme-material h-full",onGridReady:q,onCellValueChanged:U},null,8,["rowData","columnDefs"])])])}}};export{ge as default};
