import{b as be,c as Ce,r as n,s as G,D as c,d as K,K as D,o as Ne,L as Ve,f as U,g as q,h as x,i as C,F as H,G as Ie,j as h,l as R,k as N,m as De,z as O,I as xe,J as Ee,x as Fe,t as Te,M as ke,n as f}from"./app-BnZHz_BC.js";/* empty css                   */import{_ as Se}from"./EditValue-BF0CU7sG.js";import{V as Re}from"./VueShiftCalendar-BSucxU8d.js";import{f as V}from"./format-D9pTN3Kd.js";const _e={class:"grid grid-rows-[55px,1fr]"},Ae={class:"flex flex-col"},Me={class:"m-2 flex pt-3"},Pe={class:"flex justify-end"},$e=8*60,Le=19*60+59,He={__name:"ParametrValue",props:{id:Number},setup(z){const E=z,W=be(),{t:o,locale:j}=Ce(),F=n([]),i=n(null),v=n({}),J=n([]),u=n({smena:null,day:null}),_=G(()=>u.value.day?`${u.value.day} - ${u.value.smena}`:"");n(null);const A=n(null);n(null);const M=n(null);n(null);const g=n(null),Q=c.state.user.id;c.state.user.structure_id;const t=n("1");n([]);const X=n([]),m=n([]),Y=K({ParametersID:"",Change:"",Name:"",ShortName:"",Comment:"",GTime:"",Value:"",BlogsID:c.state.user.structure_id,SourceID:"",userId:c.state.user.id}),Z=K({id:"",Comment:"",Value:"",userId:c.state.user.id}),P=n([{headerName:o("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0,cellClassRules:{"cell-green":e=>{var a;return e.data&&e.data.Value===((a=v.value)==null?void 0:a[e.data.id])},"cell-yellow":e=>{var a,l;return e.data&&e.data.Value!==((a=v.value)==null?void 0:a[e.data.id])&&((l=v.value)==null?void 0:l[e.data.id])===void 0&&e.data.WithFormula!=="1"},"cell-pink":e=>e.data&&e.data.WithFormula==="1"}},{headerName:o("table.change"),field:"Change",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.parameters"),field:G(()=>j.value==="ru"?"PNameRus":"PName"),flex:1,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.graphictimes"),headerClass:"header-center",children:[{headerName:o("table.startingTime"),field:"STime",width:120,valueFormatter:e=>V(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.endingTime"),field:"ETime",width:120,valueFormatter:e=>V(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:o("table.interval"),headerClass:"header-center",children:[{headerName:o("table.min"),field:"Min",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.max"),field:"Max",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:o("table.value"),field:"Value",width:150,editable:e=>e.data&&e.data.WithFormula!=="1",suppressNavigable:!1,cellEditor:"agNumberCellEditor",cellEditorPopup:!1,suppressNavigable:!1,cellClassRules:{"cell-green":e=>{var a;return e.data&&e.data.Value===((a=v.value)==null?void 0:a[e.data.id])},"cell-yellow":e=>{var a,l;return e.data&&e.data.Value!==((a=v.value)==null?void 0:a[e.data.id])&&((l=v.value)==null?void 0:l[e.data.id])===void 0&&e.data.WithFormula!=="1"},"cell-pink":e=>e.data&&e.data.WithFormula==="1"},cellStyle:e=>({"font-size":"16px","text-align":"center"}),headerClass:"header-center"},{headerName:o("table.comment"),field:"Comment",flex:1,editable:!0,suppressNavigable:!1,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]);D(m,e=>{e.length>0&&(t.value=e[0].NumberPage)},{immediate:!0}),D(u,e=>{p(t.value)},{deep:!0});const ee=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(t.value)>1?t.value=String(parseInt(t.value)-1):t.value=String(m.value.length):parseInt(t.value)<m.value.length?t.value=String(parseInt(t.value)+1):t.value="1")},ae=e=>{(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight")&&(e.preventDefault(),document.activeElement.classList.contains("ag-cell")&&i.navigateToNextCell({key:e.key}))},te=()=>{window.addEventListener("keydown",e=>{e.key===" "&&le(e),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&ae(e)})},le=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(t.value)>1?t.value=String(parseInt(t.value)-1):t.value=String(m.value.length):parseInt(t.value)<m.value.length?t.value=String(parseInt(t.value)+1):t.value="1")};function re(){const e=M.value;document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}const $=async()=>{try{const e=await f.get("/changes"),a=await f.get(`/pages-select/${E.id}`);m.value=a.data;const l=await f.get(`/paramWithId/${E.id}`);J.value=e.data.map(s=>({value:s.Change,text:s.Change})),X.value=l.data.map(s=>({value:s.Pid,text:s.PName}))}catch(e){console.error("Error fetching graphics data:",e)}},se={sortable:!0,filter:!0,resizable:!0},ne=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",ue={columnDefs:P.value,suppressScrollOnNewData:!0,getRowClass:ne,headerHeight:27,rowHeight:30,navigateToNextCell:e=>{const{key:a}=e.event;return a==="ArrowUp"||a==="ArrowDown"||a==="ArrowLeft"||a==="ArrowRight"?!0:e.previousCellDef}},oe=e=>{},ie=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},de=()=>{const e=ie();return e>=$e&&e<=Le?1:2},ce=()=>{W.push("/vparamsget")};Y.Change=de();async function p(e){try{const a=u.value.day,l=u.value.smena,[s,r]=await f.all([f.get(`/get-params-for-user/${E.id}/${l}/${a}/${e}`),f.get(`/vparams-value/${c.state.user.structure_id}/${a}/${l}`)]),d=Array.isArray(s.data)?s.data:[],S=Array.isArray(r.data)?r.data:[];d.forEach((b,we)=>{const L=S.find(B=>B.TimeStr==b.GTName&&B.ParametersID==b.ParametersID);L&&(d[we]={...b,...L})}),F.value=Array.isArray(d)?d:[]}catch(a){console.error("Error fetching data:",a),F.value=[]}}const me=async e=>{const{data:a,colDef:l,newValue:s,oldValue:r}=e;if(s!==r)try{await fe(a,t.value);const d=e.rowIndex,S=i.value.getDisplayedRowCount();if(i.value&&i.value.ensureIndexVisible(d,"bottom"),d<S-1){i.value.stopEditing();const b=l.field==="Value"?"Value":"Comment";i.value.setFocusedCell(d+1,b)}}catch(d){console.error("Error saving data",d)}},fe=async(e,a)=>{const l=u.value.smena,s=u.value.day;try{const r=await f.post("/vparams",{...e,userId:Q,change:l,daySelect:s});return ve(),await p(a),r}catch(r){console.error("Error saving data",r)}},ve=()=>{i.value&&i.value.clearFocusedCell()},ge=()=>{I.value&&i.value&&(i.value.stopEditing(),I.value=!1)};let y=null,w=null,I=n(!1);const he=e=>{const{column:a}=e;if(a){const l=a.getColId();l==="Value"||l==="Comment"?(k(),I.value=!0,g.value&&clearTimeout(g.value),g.value=setTimeout(ge,6e4)):T()}},pe=e=>{const{column:a}=e;if(a){const l=a.getColId();(l==="Value"||l==="Comment")&&(k(),I.value=!1,g.value&&(clearTimeout(g.value),g.value=null))}},T=()=>{y||(c.state.newValue=c.state.newValue||1,y=setInterval(()=>p(c.state.newValue),6e4)),w||(w=setInterval($,6e4))},k=()=>{y&&(clearInterval(y),y=null),w&&(clearInterval(w),w=null)},ye=e=>{i.value=e.api,e.api.addEventListener("cellFocused",he),e.api.addEventListener("cellBlurred",pe),T()};return D(t,e=>{p(e)}),Ne(()=>{const e=new Date,a=e.getHours(),l=e.getMinutes();if(a>=8&&a<20||a===19&&l<=59)u.value.smena=1,u.value.day=V(e,"yyyy-MM-dd");else if(u.value.smena=2,a<8){const s=new Date(e);s.setDate(e.getDate()-1),u.value.day=V(s,"yyyy-MM-dd")}else u.value.day=V(e,"yyyy-MM-dd");p(t.value),$(),T(),te()}),D(m,e=>{e.length>0&&(t.value=e[0].NumberPage)},{immediate:!0}),Ve(()=>{k()}),(e,a)=>{const l=U("VaTab"),s=U("ag-grid-vue");return x(),q("div",_e,[a[3]||(a[3]=C("main",null,null,-1)),C("main",Ae,[C("div",Me,[h(N(Re),{modelValue:u.value,"onUpdate:modelValue":a[1]||(a[1]=r=>u.value=r),"with-slot":!0},{default:R(()=>[h(N(De),{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=r=>_.value=r),label:"Smena",readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),C("div",Pe,[h(N(O),{onClick:re,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"fullscreen"}),h(N(O),{onClick:ce,class:"btn btn-primary items-center justify-center mt-3 ml-3",icon:"grade"})])]),C("div",{ref_key:"gridContainer",ref:M,class:"ag-grid-container h-full"},[h(N(ke),{modelValue:t.value,"onUpdate:modelValue":a[2]||(a[2]=r=>t.value=r),stateful:"",grow:"",onKeydown:ee,tabindex:"0"},{tabs:R(()=>[(x(!0),q(xe,null,Ee(m.value,r=>(x(),H(l,{key:r.NumberPage,name:r.NumberPage},{default:R(()=>[Fe(Te(r.Name),1)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),h(s,{rowData:F.value,columnDefs:P.value,defaultColDef:se,gridOptions:ue,animateRows:"true",class:"ag-theme-material h-full",onGridReady:ye,onCellValueChanged:me},null,8,["rowData","columnDefs"])],512),A.value?(x(),H(Se,{key:0,showModalEdit:A.value,resultEdit:Z,onUpdate:oe},null,8,["showModalEdit","resultEdit"])):Ie("",!0)])])}}};export{He as default};
