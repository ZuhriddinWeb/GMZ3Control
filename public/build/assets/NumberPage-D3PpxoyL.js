import{u as useToast,c as useI18n,r as ref,E as inject,f as resolveComponent,g as createElementBlock,h as openBlock,j as createVNode,k as unref,z as VaButton,l as withCtx,i as createBaseVNode,t as toDisplayString,n as axios,d as reactive,L as watch,V as VaForm,m as VaInput,x as createTextVNode,F as createBlock,G as createCommentVNode,M as VaModal,_ as _export_sfc,s as computed,o as onMounted,I as Fragment,J as renderList,N as VaSelect,O as VaTextarea,P as nextTick,a as useStore,H as provide}from"./app-A8jI9ma8.js";/* empty css                   */import{D as DxDataGrid,a as DxSelection,b as DxColumn}from"./data-grid-CamjrwSL.js";import{a as anime}from"./anime.es-BNELU3II.js";const _hoisted_1$6={class:"h-full w-full text-center content-center"},_hoisted_2$6={class:"va-h3"},_sfc_main$6={__name:"DeleteBlog",props:["params"],setup(o){const{init:e}=useToast(),{t:a}=useI18n(),l=ref(!1),r=o,n=inject("ondeleted"),p=async()=>{try{const{data:v}=await axios.delete(`/pages/${r.params.data.id}`);v.status===200?(n(r.params.data),l.value=!1,e({message:a("login.successMessage"),color:"success"})):console.error("Error deleting data:",v.message)}catch(v){console.error("Error deleting data:",v)}};return(v,d)=>{const b=resolveComponent("VaModal");return openBlock(),createElementBlock("main",_hoisted_1$6,[createVNode(unref(VaButton),{round:"",icon:"delete",preset:"primary",class:"mt-1",onClick:d[0]||(d[0]=c=>l.value=!0)}),createVNode(b,{modelValue:l.value,"onUpdate:modelValue":d[1]||(d[1]=c=>l.value=c),"ok-text":unref(a)("modals.apply"),"cancel-text":unref(a)("modals.cancel"),onClose:d[2]||(d[2]=c=>l.value=!1),onOk:p,"close-button":""},{default:withCtx(()=>[createBaseVNode("h3",_hoisted_2$6,toDisplayString(unref(a)("modals.title")),1),createBaseVNode("p",null,toDisplayString(unref(a)("modals.message")),1)]),_:1},8,["modelValue","ok-text","cancel-text"])])}}},_hoisted_1$5={class:"h-full w-full text-center content-center"},_hoisted_2$5={class:"grid grid-cols-1 md:grid-cols-1 gap-2 items-end w-full"},_sfc_main$5={__name:"EditBlog",props:["params"],setup(o){const{init:e}=useToast(),a=o,l=ref(!1),r=inject("onupdated"),n=ref([]),{t:p,locale:v}=useI18n(),d=reactive({StructureID:"",Name:"",NameRus:"",NumberPage:"",Comment:"",id:a.params.data.id}),b=async()=>{try{const B=await axios.get("/structure");n.value=B.data.map(S=>({value:S.id,text:v.value==="uz"?S.Name:S.NameRus}));const m=await axios.get(`pages/${a.params.data.id}`);d.StructureID=+m.data.StructureID,d.Name=m.data.Name,d.ShortName=m.data.ShortName,d.NumberPage=m.data.NumberPage,d.Comment=m.data.Comment}catch(B){console.error("Error fetching graphics data:",B)}},c=async()=>{try{const{data:B}=await axios.put("/pages",d);B.status===200?(r(a.params.node,B.unit),l.value=!1,e({message:p("login.successMessage"),color:"success"})):console.error("Error saving data:",B.message)}catch(B){console.error("Error saving data:",B)}};return watch(()=>d.StructureID,B=>{}),(B,m)=>{const S=resolveComponent("VaSelect"),x=resolveComponent("VaTextarea"),h=resolveComponent("VaModal");return openBlock(),createElementBlock("main",_hoisted_1$5,[createVNode(unref(VaButton),{round:"",icon:"edit",preset:"primary",class:"mt-1",onClick:m[0]||(m[0]=g=>(l.value=!0,b))}),createVNode(h,{modelValue:l.value,"onUpdate:modelValue":m[6]||(m[6]=g=>l.value=g),"ok-text":unref(p)("modals.apply"),"cancel-text":unref(p)("modals.cancel"),onOk:c,onClose:m[7]||(m[7]=g=>l.value=!1),"close-button":""},{default:withCtx(()=>[createBaseVNode("h3",{class:"va-h3",onVnodeMounted:b},toDisplayString(unref(p)("modals.editFactory")),513),createBaseVNode("div",null,[createVNode(unref(VaForm),{ref:"formRef",class:"flex flex-col items-baseline gap-1"},{default:withCtx(()=>[createBaseVNode("div",_hoisted_2$5,[createVNode(S,{modelValue:d.StructureID,"onUpdate:modelValue":m[1]||(m[1]=g=>d.StructureID=g),"value-by":"value",class:"mb-1",label:unref(p)("form.structureName"),options:n.value,clearable:""},null,8,["modelValue","label","options"])]),createVNode(unref(VaInput),{class:"w-full",modelValue:d.NumberPage,"onUpdate:modelValue":m[2]||(m[2]=g=>d.NumberPage=g),type:"number",rules:[g=>g&&g.length>0||unref(p)("validation.requiredField")],label:unref(p)("form.numberpage")},null,8,["modelValue","rules","label"]),createVNode(unref(VaInput),{class:"w-full",modelValue:d.Name,"onUpdate:modelValue":m[3]||(m[3]=g=>d.Name=g),rules:[g=>g&&g.length>0||unref(p)("validation.requiredField")],label:unref(p)("form.name")},null,8,["modelValue","rules","label"]),createVNode(unref(VaInput),{class:"w-full",modelValue:d.NameRus,"onUpdate:modelValue":m[4]||(m[4]=g=>d.NameRus=g),rules:[g=>g&&g.length>0||unref(p)("validation.requiredField")],label:unref(p)("form.nameRus")},null,8,["modelValue","rules","label"]),createVNode(x,{class:"w-full",modelValue:d.Comment,"onUpdate:modelValue":m[5]||(m[5]=g=>d.Comment=g),"max-length":"125",label:unref(p)("form.comment")},null,8,["modelValue","label"])]),_:1},512)])]),_:1},8,["modelValue","ok-text","cancel-text"])])}}},_hoisted_1$4={class:"h-full w-full"},_hoisted_2$4={class:"va-h3 mb-4"},_sfc_main$4={__name:"AddForDocuments",props:["params"],setup(o){const{t:e}=useI18n(),{init:a}=useToast(),l=o,r=inject("onupdated"),n=ref(!1),p=ref([]),v=ref([]),d={visible:!0,showInfo:!0,showPageSizeSelector:!0,allowedPageSizes:[10,20,50]},b=async()=>{n.value=!0,v.value=[];try{const{data:x}=await axios.get(`/addfordoc/${l.params.data.NumberPage}`);p.value=B(x.tree),v.value=c(x.selected??[])}catch(x){console.error(x),a({message:"Maʼlumotni olishda xatolik",color:"danger"})}};function c(x){return x.flat(3)}function B(x){const h=[];return x.forEach(g=>{var I;const T=g.key,D=g.title,C=parseInt(T.split("-")[1]);(I=g.children)==null||I.forEach(i=>{var $;const u=i.title,N=i.key,y=parseInt(N.split("-")[2]);($=i.children)==null||$.forEach(k=>{var P;const s=k.title,f=k.key,_=parseInt(f.split("-")[3]);(P=k.children)!=null&&P.length&&k.children.forEach(w=>{h.push({rowId:w.ParameterID??`param-${w.key}`,sexName:D,sexId:C,pageName:u,pageId:y,groupName:s,groupId:_,paramName:w.title,ParameterID:w.ParameterID})})})})}),h}const m=({selectedRowKeys:x})=>{v.value=x},S=async()=>{const x=p.value.filter(C=>v.value.includes(C.rowId)),h=[...new Set(x.map(C=>C.sexId))],g=h.map(C=>{const I=x.filter(i=>i.sexId===C).map(i=>i.pageId);return[...new Set(I)]}),T=h.map(C=>{const I=x.filter(u=>u.sexId===C);return[...new Set(I.map(u=>u.pageId))].map(u=>{const N=I.filter(y=>y.pageId===u).map(y=>y.groupId);return[...new Set(N)]})}),D=h.map(C=>{const I=x.filter(u=>u.sexId===C);return[...new Set(I.map(u=>u.pageId))].map(u=>{const N=I.filter($=>$.pageId===u);return[...new Set(N.map($=>$.groupId))].map($=>N.filter(s=>s.groupId===$).map(s=>s.ParameterID).filter(s=>s))})});try{const{data:C}=await axios.post("/addfordoc",{doc_id:l.params.data.NumberPage,FactoryStructureID:h,NumberPageBlogs:g,GroupBlogs:T,ParameterBlogs:D});if(console.log(C),C.status===200)r==null||r(),n.value=!1,a({message:e("login.successMessage"),color:"success"});else throw new Error(C.message||"Unknown error")}catch(C){console.error(C),a({message:e("errors.saveFailed"),color:"danger"})}};return(x,h)=>(openBlock(),createElementBlock("main",_hoisted_1$4,[createVNode(unref(VaButton),{icon:"design_services",round:"",preset:"primary",onClick:b}),createVNode(unref(VaModal),{modelValue:n.value,"onUpdate:modelValue":h[0]||(h[0]=g=>n.value=g),"ok-text":unref(e)("modals.apply"),"cancel-text":unref(e)("modals.cancel"),onOk:S,onClose:h[1]||(h[1]=g=>n.value=!1),"close-button":"","max-width":"1000px"},{default:withCtx(()=>[createBaseVNode("h3",_hoisted_2$4,toDisplayString(unref(e)("modals.editFactory")),1),createTextVNode(toDisplayString(l.params.data.NumberPage)+" ",1),p.value.length?(openBlock(),createBlock(unref(DxDataGrid),{key:0,"data-source":p.value,"key-expr":"rowId","selected-row-keys":v.value,onSelectionChanged:m,"show-borders":"","row-alternation-enabled":"","column-auto-width":"","word-wrap-enabled":"",pager:d},{default:withCtx(()=>[createVNode(unref(DxSelection),{mode:"multiple","show-check-boxes-mode":"always"}),createVNode(unref(DxColumn),{"data-field":"sexName",caption:unref(e)("form.structureName"),"group-index":0},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"pageName",caption:unref(e)("form.numberpage"),"group-index":1},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"groupName",caption:unref(e)("menu.groups"),"group-index":2},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"paramName",caption:unref(e)("form.name")},null,8,["caption"])]),_:1},8,["data-source","selected-row-keys"])):createCommentVNode("",!0)]),_:1},8,["modelValue","ok-text","cancel-text"])]))}},_hoisted_1$3={class:"flex gap-4"},_hoisted_2$3={class:"calculator"},_hoisted_3$3={class:"answer"},_hoisted_4$3={class:"display"},_hoisted_5$2={class:"flex-1 min-w-[420px]"},_hoisted_6$2={class:"rounded border p-2 mb-3"},_hoisted_7$1={class:"flex flex-wrap items-center gap-2 mb-2"},_hoisted_8$1={class:"flex items-center gap-2"},_hoisted_9$1={class:"text-xs text-gray-500 ml-2"},_hoisted_10$1={class:"mb-3 flex flex-wrap gap-2"},_hoisted_11$1={key:0,class:"mb-3 flex flex-wrap gap-2"},_hoisted_12$1={key:1,class:"mb-3 flex flex-wrap gap-2"},_hoisted_13$1={class:"border rounded p-2 min-h-[160px]"},_hoisted_14$1={key:0,class:"flex flex-wrap gap-2"},_hoisted_15$1={key:1,class:"text-gray-500 text-sm"},_hoisted_16$1={class:"mt-4"},_hoisted_17={key:0,class:"mb-2 flex flex-wrap gap-2"},_hoisted_18={key:1,class:"text-gray-500 text-sm"},_hoisted_19={class:"border rounded p-2 min-h-[120px]"},_hoisted_20={key:0,class:"flex flex-wrap gap-2"},_hoisted_21={key:0,class:"ml-1 text-xs opacity-70"},_hoisted_22={key:1,class:"ml-1 text-xs opacity-70"},_hoisted_23={key:1,class:"text-gray-500 text-sm"},_sfc_main$3={__name:"FormulaModal",props:{parameter:{type:[Number,String],required:!0},modelValue:{type:Boolean,default:!1},docId:{type:[Number],required:!0}},emits:["update:modelValue","save"],setup(__props,{emit:__emit}){const{locale,t}=useI18n(),staticItems=ref([]),props=__props,emit=__emit,openLocal=computed({get:()=>props.modelValue,set:o=>emit("update:modelValue",o)}),{init}=useToast(),items=ref([]),aggOptions=[{value:"RAW",label:"Asosiy"},{value:"HOUR",label:"Soatlik"},{value:"SHIFT",label:"Smenalik"},{value:"DAY",label:"Kunlik"},{value:"WEEK",label:"Haftalik"},{value:"MONTH",label:"Oylik"},{value:"YEAR",label:"Yillik"}],funcOptions=[{text:"Qiymat (joriy)",value:"VALUE"},{text:"O‘rtacha",value:"AVG"},{text:"Yig‘indi",value:"SUM"},{text:"Min",value:"MIN"},{text:"Max",value:"MAX"}],scopeOptions=[{text:"Joriy davr",value:"CURRENT"},{text:"Oldingi davr(lar)",value:"PREV"},{text:"Sirpanma oynaviy",value:"ROLLING"}],applyMode=ref("global"),agg=reactive({agg:"DAY",func:"VALUE",scope:"CURRENT",n:1}),aggSummary=computed(()=>{var a,l;const o=((a=aggOptions.find(r=>r.value===agg.agg))==null?void 0:a.label)??agg.agg,e=((l=funcOptions.find(r=>r.value===agg.func))==null?void 0:l.text)??agg.func;return agg.scope==="CURRENT"?`${o}, ${e}, joriy davr`:agg.scope==="PREV"?`${o}, ${e}, oldingi ${agg.n} davr`:`${o}, ${e}, oxirgi ${agg.n} davr (rolling)`});function appendParam(o){var d,b;const e=typeof agg.func=="object"?agg.func.value:agg.func,a=typeof agg.scope=="object"?agg.scope.value:agg.scope,l=[`Pid=${o.id}`,`agg=${agg.agg}`,`func=${e}`,`scope=${a}`];agg.scope!=="CURRENT"&&l.push(`n=${Number(agg.n)||1}`);const r=l.join("|");result.Calculate.push(r);const n=((d=aggOptions.find(c=>c.value===agg.agg))==null?void 0:d.label)||agg.agg,p=((b=funcOptions.find(c=>c.value===e))==null?void 0:b.text)||e;let v="joriy";a==="PREV"&&(v=`oldingi ${agg.n}`),a==="ROLLING"&&(v=`oxirgi ${agg.n}`),current.value+=`[${o.name||o.id}] ⟨${n} • ${p} • ${v}⟩`}const sel=reactive({sex:0,page:0,group:0}),pages=computed(()=>{var o,e;return((e=(o=items.value)==null?void 0:o[sel.sex])==null?void 0:e.pages)??[]}),groups=computed(()=>{var o,e;return((e=(o=pages.value)==null?void 0:o[sel.page])==null?void 0:e.groups)??[]}),parameters=computed(()=>{var o,e;return((e=(o=groups.value)==null?void 0:o[sel.group])==null?void 0:e.parameters)??[]}),logList=ref(""),current=ref(""),answer=ref(""),operatorClicked=ref(!0),result=reactive({Calculate:[],Comment:""});function anim(o){anime.timeline({targets:`#${o}`,duration:220,easing:"easeInOutCubic"}).add({backgroundColor:"#c1e3ff"}).add({backgroundColor:"#f4faff"})}function append(o){operatorClicked.value&&(current.value="",operatorClicked.value=!1),anim(typeof o=="string"?`n${o}`:"nX"),result.Calculate.push(String(o)),current.value+=String(o)}function addOp(o,e){anim(e),operatorClicked.value||(logList.value+=`${current.value} ${o} `,current.value="",operatorClicked.value=!0,result.Calculate.push(o))}const clear=()=>{addOp("","clear"),logList.value="",current.value="",answer.value="",result.Calculate=[],operatorClicked.value=!1},sign=()=>addOp("±","sign"),percent=()=>addOp("%","percent"),dot=()=>{current.value.includes(".")||append(".")},plus=()=>addOp("+","plus"),minus=()=>addOp("-","minus"),times=()=>addOp("*","times"),divide=()=>addOp("/","divide"),equal=()=>{addOp("=","equal");const expr=result.Calculate.map(o=>o.startsWith("Pid=")||o.startsWith("Static=")?"1":o).join("");try{answer.value=eval(expr)}catch{answer.value="Error"}};function selectSex(o){sel.sex=o,sel.page=0,sel.group=0}function selectPage(o){sel.page=o,sel.group=0}function selectGroup(o){sel.group=o}const loadedOnce=ref(!1),loading=ref(!1);async function loadTree(){var o;if(!loading.value){loading.value=!0;try{const e=((o=props.parameter)==null?void 0:o.id)??props.parameter,{data:a}=await axios.get(`/calculator-structure/${e}`);items.value=Array.isArray(a.items)?a.items:[],loadedOnce.value=!0}catch(e){console.error(e),init({message:"Strukturani yuklashda xatolik",color:"danger"})}finally{loading.value=!1}}}const staticParams=computed(()=>{const o=new Set,e=[];for(const a of staticItems.value)a!=null&&a.id&&(o.has(a.id)||(o.add(a.id),e.push(a)));return e}),periodTypes=ref([]),activeStaticPeriodId=ref(null),filteredStaticParams=computed(()=>activeStaticPeriodId.value?staticParams.value.filter(o=>String(o.period_type_id)===String(activeStaticPeriodId.value)):[]);function appendStatic(o){result.Calculate.push(`Static=${o.id}`);const e=o.PName||o.name||o.id,a=o.UName?` • ${o.UName}`:"",l=o.PTName?` • ${o.PTName}`:"";current.value+=`[S:${e}${a}${l}] `;try{anim("nX")}catch{}}async function fetchStaticParams(){try{const{data:o}=await axios.get("/static");staticItems.value=Array.isArray(o)?o:o.items||[]}catch(o){console.error(o),init({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}async function fetchPeriodTypes(){try{const{data:o}=await axios.get("/periodType");periodTypes.value=Array.isArray(o)?o:o.items||[],!activeStaticPeriodId.value&&periodTypes.value.length&&(activeStaticPeriodId.value=periodTypes.value[0].id)}catch(o){console.error(o),init({message:"Period turlarini yuklashda xatolik",color:"danger"})}}async function emitSave(){var e,a,l,r;const o={page_id_blog:props.parameter.id,doc_id:props.docId,param_id:(e=props.parameter)==null?void 0:e.ParameterID,sex_id:(a=props.parameter)==null?void 0:a.sexId,page_id:(l=props.parameter)==null?void 0:l.pageId,group_id:(r=props.parameter)==null?void 0:r.groupId,tokens:[...result.Calculate],comment:result.Comment||null};try{const{data:n}=await axios.post("/svodkaFormula",o);n.status===200?(loadTree(),init({message:t("login.successMessage"),color:"success"})):console.error("Error saving data:",n.message)}catch(n){console.error("Error saving data:",n)}try{const{data:n}=await axios.get(`/calculator-structure/${props.parameter.id}`);items.value=Array.isArray(n.items)?n.items:[]}catch(n){console.error(n),init({message:"Strukturani yuklashda xatolik",color:"danger"})}emit("save",o),openLocal.value=!1}return onMounted(async()=>{await Promise.all([loadTree(),fetchStaticParams(),fetchPeriodTypes()])}),watch(openLocal,async o=>{o&&!loadedOnce.value&&(await loadTree(),await fetchStaticParams(),await fetchPeriodTypes())}),watch(()=>{var o;return[props.docId,((o=props.parameter)==null?void 0:o.id)??props.parameter]},()=>{loadedOnce.value=!1}),(o,e)=>(openBlock(),createBlock(unref(VaModal),{modelValue:openLocal.value,"onUpdate:modelValue":e[18]||(e[18]=a=>openLocal.value=a),fullscreen:"",title:"Yangi formula yaratish","ok-text":"Tasdiqlash","cancel-text":"Bekor qilish",onOk:emitSave,"close-button":""},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1$3,[createBaseVNode("div",_hoisted_2$3,[createBaseVNode("div",_hoisted_3$3,toDisplayString(answer.value),1),createBaseVNode("div",_hoisted_4$3,toDisplayString(logList.value+current.value),1),createBaseVNode("div",{onClick:clear,id:"clear",class:"btn operator"},"C"),createBaseVNode("div",{onClick:sign,id:"sign",class:"btn operator"},"+/-"),createBaseVNode("div",{onClick:percent,id:"percent",class:"btn operator"},"%"),createBaseVNode("div",{onClick:divide,id:"divide",class:"btn operator"},"/"),createBaseVNode("div",{onClick:e[0]||(e[0]=a=>append("7")),id:"n7",class:"btn"},"7"),createBaseVNode("div",{onClick:e[1]||(e[1]=a=>append("8")),id:"n8",class:"btn"},"8"),createBaseVNode("div",{onClick:e[2]||(e[2]=a=>append("9")),id:"n9",class:"btn"},"9"),createBaseVNode("div",{onClick:times,id:"times",class:"btn operator"},"*"),createBaseVNode("div",{onClick:e[3]||(e[3]=a=>append("4")),id:"n4",class:"btn"},"4"),createBaseVNode("div",{onClick:e[4]||(e[4]=a=>append("5")),id:"n5",class:"btn"},"5"),createBaseVNode("div",{onClick:e[5]||(e[5]=a=>append("6")),id:"n6",class:"btn"},"6"),createBaseVNode("div",{onClick:minus,id:"minus",class:"btn operator"},"-"),createBaseVNode("div",{onClick:e[6]||(e[6]=a=>append("1")),id:"n1",class:"btn"},"1"),createBaseVNode("div",{onClick:e[7]||(e[7]=a=>append("2")),id:"n2",class:"btn"},"2"),createBaseVNode("div",{onClick:e[8]||(e[8]=a=>append("3")),id:"n3",class:"btn"},"3"),createBaseVNode("div",{onClick:plus,id:"plus",class:"btn operator"},"+"),createBaseVNode("div",{onClick:e[9]||(e[9]=a=>append("0")),id:"n0",class:"zero"},"0"),createBaseVNode("div",{onClick:dot,id:"dot",class:"btn"},"."),createBaseVNode("div",{onClick:equal,id:"equal",class:"btn operator"},"="),createBaseVNode("div",{onClick:e[10]||(e[10]=a=>append("(")),id:"lb",class:"btn p-4"},"("),createBaseVNode("div",{onClick:e[11]||(e[11]=a=>append(")")),id:"rb",class:"btn p-4"},")")]),createBaseVNode("div",_hoisted_5$2,[e[27]||(e[27]=createBaseVNode("div",{class:"mb-2 text-xs text-gray-500"},"Sex → Sahifa → Guruh",-1)),createBaseVNode("div",_hoisted_6$2,[e[25]||(e[25]=createBaseVNode("div",{class:"mb-2 text-xs text-gray-500"},"Agregatsiya va oynaviy qoida",-1)),createBaseVNode("div",_hoisted_7$1,[e[19]||(e[19]=createBaseVNode("span",{class:"text-xs text-gray-500"},"Davr:",-1)),(openBlock(),createElementBlock(Fragment,null,renderList(aggOptions,a=>createVNode(unref(VaButton),{key:a.value,size:"small",color:a.value===agg.agg?"primary":"secondary",onClick:l=>agg.agg=a.value},{default:withCtx(()=>[createTextVNode(toDisplayString(a.label),1)]),_:2},1032,["color","onClick"])),64)),e[20]||(e[20]=createBaseVNode("span",{class:"ml-3 text-xs text-gray-500"},"Funktsiya:",-1)),createVNode(unref(VaSelect),{modelValue:agg.func,"onUpdate:modelValue":e[12]||(e[12]=a=>agg.func=a),options:funcOptions,"value-by":"value","text-by":"text",class:"min-w-[140px]"},null,8,["modelValue"]),e[21]||(e[21]=createBaseVNode("span",{class:"ml-3 text-xs text-gray-500"},"Qamrov:",-1)),createVNode(unref(VaSelect),{modelValue:agg.scope,"onUpdate:modelValue":e[13]||(e[13]=a=>agg.scope=a),options:scopeOptions,"value-by":"value","text-by":"text",class:"min-w-[140px]"},null,8,["modelValue"]),agg.scope!=="CURRENT"?(openBlock(),createBlock(unref(VaInput),{key:0,modelValue:agg.n,"onUpdate:modelValue":e[14]||(e[14]=a=>agg.n=a),modelModifiers:{number:!0},type:"number",min:"1",class:"w-20",label:agg.scope==="PREV"?"nechta orqaga":"oyna hajmi"},null,8,["modelValue","label"])):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_8$1,[e[24]||(e[24]=createBaseVNode("span",{class:"text-xs text-gray-500"},"Qo'llash:",-1)),createVNode(unref(VaButton),{size:"small",color:applyMode.value==="global"?"primary":"secondary",onClick:e[15]||(e[15]=a=>applyMode.value="global")},{default:withCtx(()=>e[22]||(e[22]=[createTextVNode("Global",-1)])),_:1,__:[22]},8,["color"]),createVNode(unref(VaButton),{size:"small",color:applyMode.value==="next"?"primary":"secondary",onClick:e[16]||(e[16]=a=>applyMode.value="next")},{default:withCtx(()=>e[23]||(e[23]=[createTextVNode(" Keyingi parametr",-1)])),_:1,__:[23]},8,["color"]),createBaseVNode("span",_hoisted_9$1,toDisplayString(aggSummary.value),1)])]),createBaseVNode("div",_hoisted_10$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(items.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`sex-${a.sexId}`,size:"small",color:l===sel.sex?"primary":"secondary",onClick:r=>selectSex(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.sexName||`Sex #${a.sexId}`),1)]),_:2},1032,["color","onClick"]))),128))]),pages.value.length?(openBlock(),createElementBlock("div",_hoisted_11$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(pages.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`page-${a.pageId}`,size:"small",color:l===sel.page?"primary":"secondary",onClick:r=>selectPage(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.pageName||`Sahifa ${a.pageId}`),1)]),_:2},1032,["color","onClick"]))),128))])):createCommentVNode("",!0),groups.value.length?(openBlock(),createElementBlock("div",_hoisted_12$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(groups.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`grp-${a.groupId}`,size:"small",color:l===sel.group?"primary":"secondary",onClick:r=>selectGroup(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.groupName||`Guruh #${a.groupId}`),1)]),_:2},1032,["color","onClick"]))),128))])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_13$1,[parameters.value.length?(openBlock(),createElementBlock("div",_hoisted_14$1,[(openBlock(!0),createElementBlock(Fragment,null,renderList(parameters.value,a=>(openBlock(),createBlock(unref(VaButton),{key:`param-${a.id}`,color:"warning","text-color":"black",style:{borderRadius:"0"},onClick:l=>appendParam(a)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.name||a.id),1)]),_:2},1032,["onClick"]))),128))])):(openBlock(),createElementBlock("div",_hoisted_15$1,"Parametrlar topilmadi"))]),createBaseVNode("div",_hoisted_16$1,[e[26]||(e[26]=createBaseVNode("div",{class:"mb-2 text-xs text-gray-500"},"Static",-1)),periodTypes.value.length?(openBlock(),createElementBlock("div",_hoisted_17,[(openBlock(!0),createElementBlock(Fragment,null,renderList(periodTypes.value,a=>(openBlock(),createBlock(unref(VaButton),{key:`pt-${a.id}`,size:"small",color:a.id===activeStaticPeriodId.value?"primary":"secondary",onClick:l=>activeStaticPeriodId.value=a.id},{default:withCtx(()=>[createTextVNode(toDisplayString(a.name),1)]),_:2},1032,["color","onClick"]))),128))])):(openBlock(),createElementBlock("div",_hoisted_18,"Period turlari topilmadi")),createBaseVNode("div",_hoisted_19,[filteredStaticParams.value.length?(openBlock(),createElementBlock("div",_hoisted_20,[(openBlock(!0),createElementBlock(Fragment,null,renderList(filteredStaticParams.value,a=>(openBlock(),createBlock(unref(VaButton),{key:`static-${a.id}`,color:"secondary",style:{borderRadius:"0"},onClick:l=>appendStatic(a)},{default:withCtx(()=>[createTextVNode(" S: "+toDisplayString(a.PName||a.name||a.id)+" ",1),a.UName?(openBlock(),createElementBlock("span",_hoisted_21,"("+toDisplayString(a.UName)+")",1)):createCommentVNode("",!0),a.PTName?(openBlock(),createElementBlock("span",_hoisted_22,"["+toDisplayString(a.PTName)+"]",1)):createCommentVNode("",!0)]),_:2},1032,["onClick"]))),128))])):(openBlock(),createElementBlock("div",_hoisted_23,"Tanlangan period uchun static parametr topilmadi"))])])])]),createVNode(unref(VaTextarea),{class:"w-full mt-3",modelValue:result.Comment,"onUpdate:modelValue":e[17]||(e[17]=a=>result.Comment=a),"max-length":125,label:"Izoh"},null,8,["modelValue"])]),_:1},8,["modelValue"]))}},FormulaModal=_export_sfc(_sfc_main$3,[["__scopeId","data-v-cd8c941b"]]),_hoisted_1$2={class:"flex gap-4"},_hoisted_2$2={class:"calculator"},_hoisted_3$2={class:"answer"},_hoisted_4$2={class:"display"},_hoisted_5$1={class:"display-text"},_hoisted_6$1={class:"flex-1 min-w-[420px]"},_hoisted_7={class:"rounded border p-2 mb-3"},_hoisted_8={class:"flex flex-wrap items-center gap-2 mb-2"},_hoisted_9={class:"flex items-center gap-2"},_hoisted_10={class:"text-xs text-gray-500 ml-2"},_hoisted_11={class:"mb-3 flex flex-wrap gap-2"},_hoisted_12={key:0,class:"mb-3 flex flex-wrap gap-2"},_hoisted_13={key:1,class:"mb-3 flex flex-wrap gap-2"},_hoisted_14={class:"border rounded p-2 min-h-[160px]"},_hoisted_15={key:0,class:"flex flex-wrap gap-2"},_hoisted_16={key:1,class:"text-gray-500 text-sm"},_sfc_main$2={__name:"FormulaModalEdit",props:{parameter:{type:[Object,Number,String],required:!0},modelValue:{type:Boolean,default:!1},docId:{type:[Number,String],required:!0}},emits:["update:modelValue","save"],setup(__props,{emit:__emit}){const{t}=useI18n(),props=__props,emit=__emit,openLocal=computed({get:()=>props.modelValue,set:o=>emit("update:modelValue",o)}),{init}=useToast(),items=ref([]),loadedOnce=ref(!1),loadingTree=ref(!1),loadingFormula=ref(!1),formulaId=ref(null),logList=ref(""),current=ref(""),answer=ref(""),operatorClicked=ref(!0),result=reactive({Calculate:[],Comment:""});async function loadTree(){if(!loadingTree.value){loadingTree.value=!0;try{const o=typeof props.parameter=="object"?props.parameter.id??props.parameter.page_id_blog:props.parameter,{data:e}=await axios.get(`/calculator-structure/${o}`);items.value=Array.isArray(e.items)?e.items:[],loadedOnce.value=!0}catch(o){console.error(o),init({message:"Strukturani yuklashda xatolik",color:"danger"})}finally{loadingTree.value=!1}}}function findParamNameById(o){for(const e of items.value||[])for(const a of e.pages||[])for(const l of a.groups||[])for(const r of l.parameters||[])if(String(r.id)===String(o))return r.name||o;return o}const aggOptions=[{value:"RAW",label:"Asosiy"},{value:"HOUR",label:"Soatlik"},{value:"SHIFT",label:"Smenalik"},{value:"DAY",label:"Kunlik"},{value:"WEEK",label:"Haftalik"},{value:"MONTH",label:"Oylik"},{value:"YEAR",label:"Yillik"}],funcOptions=[{text:"Qiymat (joriy)",value:"VALUE"},{text:"O‘rtacha",value:"AVG"},{text:"Yig‘indi",value:"SUM"},{text:"Min",value:"MIN"},{text:"Max",value:"MAX"}],scopeOptions=[{text:"Joriy davr",value:"CURRENT"},{text:"Oldingi davr(lar)",value:"PREV"},{text:"Sirpanma oynaviy",value:"ROLLING"}],applyMode=ref("global"),agg=reactive({agg:"DAY",func:"VALUE",scope:"CURRENT",n:1}),aggSummary=computed(()=>{var a,l;const o=((a=aggOptions.find(r=>r.value===agg.agg))==null?void 0:a.label)??agg.agg,e=((l=funcOptions.find(r=>r.value===agg.func))==null?void 0:l.text)??agg.func;return agg.scope==="CURRENT"?`${o}, ${e}, joriy davr`:agg.scope==="PREV"?`${o}, ${e}, oldingi ${agg.n} davr`:`${o}, ${e}, oxirgi ${agg.n} davr (rolling)`});function appendParam(o){var d,b;const e=typeof agg.func=="object"?agg.func.value:agg.func,a=typeof agg.scope=="object"?agg.scope.value:agg.scope,l=[`Pid=${o.id}`,`agg=${agg.agg}`,`func=${e}`,`scope=${a}`];agg.scope!=="CURRENT"&&l.push(`n=${Number(agg.n)||1}`);const r=l.join("|");result.Calculate.push(r);const n=((d=aggOptions.find(c=>c.value===agg.agg))==null?void 0:d.label)||agg.agg,p=((b=funcOptions.find(c=>c.value===e))==null?void 0:b.text)||e;let v="joriy";a==="PREV"&&(v=`oldingi ${agg.n}`),a==="ROLLING"&&(v=`oxirgi ${agg.n}`),current.value+=`[${o.name||o.id}] ⟨${n} • ${p} • ${v}⟩`}const sel=reactive({sex:0,page:0,group:0}),pages=computed(()=>{var o,e;return((e=(o=items.value)==null?void 0:o[sel.sex])==null?void 0:e.pages)??[]}),groups=computed(()=>{var o,e;return((e=(o=pages.value)==null?void 0:o[sel.page])==null?void 0:e.groups)??[]}),parameters=computed(()=>{var o,e;return((e=(o=groups.value)==null?void 0:o[sel.group])==null?void 0:e.parameters)??[]});function anim(o){anime.timeline({targets:`#${o}`,duration:220,easing:"easeInOutCubic"}).add({backgroundColor:"#c1e3ff"}).add({backgroundColor:"#f4faff"})}function append(o){operatorClicked.value&&(current.value="",operatorClicked.value=!1),anim(typeof o=="string"?`n${o}`:"nX"),result.Calculate.push(String(o)),current.value+=String(o)}function addOp(o,e){anim(e),operatorClicked.value||(logList.value+=`${current.value} ${o} `,current.value="",operatorClicked.value=!0,result.Calculate.push(o))}const clear=()=>{addOp("","clear"),logList.value="",current.value="",answer.value="",result.Calculate=[],operatorClicked.value=!1},sign=()=>addOp("±","sign"),percent=()=>addOp("%","percent"),dot=()=>{current.value.includes(".")||append(".")},plus=()=>addOp("+","plus"),minus=()=>addOp("-","minus"),times=()=>addOp("*","times"),divide=()=>addOp("/","divide"),equal=()=>{addOp("=","equal");const expr=result.Calculate.map(o=>o.startsWith("Pid=")||o.startsWith("Static=")?"1":o).join("");try{answer.value=eval(expr)}catch{answer.value="Error"}};function selectSex(o){sel.sex=o,sel.page=0,sel.group=0}function selectPage(o){sel.page=o,sel.group=0}function selectGroup(o){sel.group=o}console.log(props),ref(!1);async function loadExistingFormula(){if(!loadingFormula.value){loadingFormula.value=!0;try{await loadTree();const o=typeof props.parameter=="object"?props.parameter.ParameterID:null;if(!o){console.warn("⚠️ parameter.ParameterID yo‘q"),loadingFormula.value=!1;return}const{data:e}=await axios.get(`/svodkaFormulaEdit/${o}`);e&&(formulaId.value=e.id??null,result.Calculate=Array.isArray(e.tokens)?[...e.tokens]:[],result.Comment=e.comment??"",current.value="",logList.value=prettyFromTokens(result.Calculate),operatorClicked.value=!0)}catch(o){console.warn("❌ Formula topilmadi yoki yuklab bo‘lmadi",o)}finally{loadingFormula.value=!1}}}function tokenToText(o){var b,c,B,m,S;if(typeof o!="string"||!o.startsWith("Pid="))return String(o);const e=o.split("|"),a=(b=e.find(x=>x.startsWith("Pid=")))==null?void 0:b.split("=")[1],l=(c=e.find(x=>x.startsWith("agg=")))==null?void 0:c.split("=")[1],r=(B=e.find(x=>x.startsWith("func=")))==null?void 0:B.split("=")[1],n=(m=e.find(x=>x.startsWith("scope=")))==null?void 0:m.split("=")[1],p=(S=e.find(x=>x.startsWith("n=")))==null?void 0:S.split("=")[1],v=findParamNameById(a)||a,d=n==="PREV"?`oldingi ${p}`:n==="ROLLING"?`oxirgi ${p}`:"joriy";return`[${v}] ⟨${l??""} • ${r??""} • ${d}⟩`}function prettyFromTokens(o=[]){return o.map(tokenToText).join(" ")}async function emitSave(){var e,a,l,r;const o={page_id_blog:typeof props.parameter=="object"?props.parameter.id:props.parameter,doc_id:props.docId,param_id:typeof props.parameter=="object"?(e=props.parameter)==null?void 0:e.ParameterID:null,sex_id:(a=props.parameter)==null?void 0:a.sexId,page_id:(l=props.parameter)==null?void 0:l.pageId,group_id:(r=props.parameter)==null?void 0:r.groupId,tokens:[...result.Calculate],comment:result.Comment||null};try{const{data:n}=await axios.post("/svodkaFormula",o);(n==null?void 0:n.status)===200?(init({message:t("login.successMessage"),color:"success"}),emit("save",o),openLocal.value=!1):(console.error("Save error:",n),init({message:t("errors.saveFailed"),color:"danger"}))}catch(n){console.error(n),init({message:t("errors.saveFailed"),color:"danger"})}}return watch(()=>props.modelValue,async o=>{o&&(await nextTick(),loadedOnce.value||await loadTree(),await loadExistingFormula())}),watch(()=>{var o;return[((o=props.parameter)==null?void 0:o.id)??props.parameter,props.docId]},()=>{loadedOnce.value=!1}),onMounted(async()=>{props.modelValue&&(await nextTick(),loadedOnce.value||await loadTree(),await loadExistingFormula())}),(o,e)=>(openBlock(),createBlock(unref(VaModal),{modelValue:openLocal.value,"onUpdate:modelValue":e[18]||(e[18]=a=>openLocal.value=a),fullscreen:"",title:"Formulani tahrirlash","ok-text":"Saqlash","cancel-text":"Bekor qilish",onOk:emitSave,"close-button":""},{default:withCtx(()=>[createBaseVNode("div",_hoisted_1$2,[createBaseVNode("div",_hoisted_2$2,[createBaseVNode("div",_hoisted_3$2,toDisplayString(answer.value),1),createBaseVNode("div",_hoisted_4$2,[createBaseVNode("div",_hoisted_5$1,toDisplayString(logList.value)+toDisplayString(current.value),1)]),createBaseVNode("div",{onClick:clear,id:"clear",class:"btn operator"},"C"),createBaseVNode("div",{onClick:sign,id:"sign",class:"btn operator"},"+/-"),createBaseVNode("div",{onClick:percent,id:"percent",class:"btn operator"},"%"),createBaseVNode("div",{onClick:divide,id:"divide",class:"btn operator"},"/"),createBaseVNode("div",{onClick:e[0]||(e[0]=a=>append("7")),id:"n7",class:"btn"},"7"),createBaseVNode("div",{onClick:e[1]||(e[1]=a=>append("8")),id:"n8",class:"btn"},"8"),createBaseVNode("div",{onClick:e[2]||(e[2]=a=>append("9")),id:"n9",class:"btn"},"9"),createBaseVNode("div",{onClick:times,id:"times",class:"btn operator"},"*"),createBaseVNode("div",{onClick:e[3]||(e[3]=a=>append("4")),id:"n4",class:"btn"},"4"),createBaseVNode("div",{onClick:e[4]||(e[4]=a=>append("5")),id:"n5",class:"btn"},"5"),createBaseVNode("div",{onClick:e[5]||(e[5]=a=>append("6")),id:"n6",class:"btn"},"6"),createBaseVNode("div",{onClick:minus,id:"minus",class:"btn operator"},"-"),createBaseVNode("div",{onClick:e[6]||(e[6]=a=>append("1")),id:"n1",class:"btn"},"1"),createBaseVNode("div",{onClick:e[7]||(e[7]=a=>append("2")),id:"n2",class:"btn"},"2"),createBaseVNode("div",{onClick:e[8]||(e[8]=a=>append("3")),id:"n3",class:"btn"},"3"),createBaseVNode("div",{onClick:plus,id:"plus",class:"btn operator"},"+"),createBaseVNode("div",{onClick:e[9]||(e[9]=a=>append("0")),id:"n0",class:"zero"},"0"),createBaseVNode("div",{onClick:dot,id:"dot",class:"btn"},"."),createBaseVNode("div",{onClick:equal,id:"equal",class:"btn operator"},"="),createBaseVNode("div",{onClick:e[10]||(e[10]=a=>append("(")),id:"lb",class:"btn p-4"},"("),createBaseVNode("div",{onClick:e[11]||(e[11]=a=>append(")")),id:"rb",class:"btn p-4"},")")]),createBaseVNode("div",_hoisted_6$1,[e[26]||(e[26]=createBaseVNode("div",{class:"mb-2 text-xs text-gray-500"},"Sex → Sahifa → Guruh",-1)),createBaseVNode("div",_hoisted_7,[e[25]||(e[25]=createBaseVNode("div",{class:"mb-2 text-xs text-gray-500"},"Agregatsiya va oynaviy qoida",-1)),createBaseVNode("div",_hoisted_8,[e[19]||(e[19]=createBaseVNode("span",{class:"text-xs text-gray-500"},"Davr:",-1)),(openBlock(),createElementBlock(Fragment,null,renderList(aggOptions,a=>createVNode(unref(VaButton),{key:a.value,size:"small",color:a.value===agg.agg?"primary":"secondary",onClick:l=>agg.agg=a.value},{default:withCtx(()=>[createTextVNode(toDisplayString(a.label),1)]),_:2},1032,["color","onClick"])),64)),e[20]||(e[20]=createBaseVNode("span",{class:"ml-3 text-xs text-gray-500"},"Funktsiya:",-1)),createVNode(unref(VaSelect),{modelValue:agg.func,"onUpdate:modelValue":e[12]||(e[12]=a=>agg.func=a),options:funcOptions,"value-by":"value","text-by":"text",class:"min-w-[140px]"},null,8,["modelValue"]),e[21]||(e[21]=createBaseVNode("span",{class:"ml-3 text-xs text-gray-500"},"Qamrov:",-1)),createVNode(unref(VaSelect),{modelValue:agg.scope,"onUpdate:modelValue":e[13]||(e[13]=a=>agg.scope=a),options:scopeOptions,"value-by":"value","text-by":"text",class:"min-w-[140px]"},null,8,["modelValue"]),agg.scope!=="CURRENT"?(openBlock(),createBlock(unref(VaInput),{key:0,modelValue:agg.n,"onUpdate:modelValue":e[14]||(e[14]=a=>agg.n=a),modelModifiers:{number:!0},type:"number",min:"1",class:"w-20",label:agg.scope==="PREV"?"nechta orqaga":"oyna hajmi"},null,8,["modelValue","label"])):createCommentVNode("",!0)]),createBaseVNode("div",_hoisted_9,[e[24]||(e[24]=createBaseVNode("span",{class:"text-xs text-gray-500"},"Qo'llash:",-1)),createVNode(unref(VaButton),{size:"small",color:applyMode.value==="global"?"primary":"secondary",onClick:e[15]||(e[15]=a=>applyMode.value="global")},{default:withCtx(()=>e[22]||(e[22]=[createTextVNode("Global",-1)])),_:1,__:[22]},8,["color"]),createVNode(unref(VaButton),{size:"small",color:applyMode.value==="next"?"primary":"secondary",onClick:e[16]||(e[16]=a=>applyMode.value="next")},{default:withCtx(()=>e[23]||(e[23]=[createTextVNode(" Keyingi parametr",-1)])),_:1,__:[23]},8,["color"]),createBaseVNode("span",_hoisted_10,toDisplayString(aggSummary.value),1)])]),createBaseVNode("div",_hoisted_11,[(openBlock(!0),createElementBlock(Fragment,null,renderList(items.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`sex-${a.sexId}`,size:"small",color:l===sel.sex?"primary":"secondary",onClick:r=>selectSex(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.sexName||`Sex #${a.sexId}`),1)]),_:2},1032,["color","onClick"]))),128))]),pages.value.length?(openBlock(),createElementBlock("div",_hoisted_12,[(openBlock(!0),createElementBlock(Fragment,null,renderList(pages.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`page-${a.pageId}`,size:"small",color:l===sel.page?"primary":"secondary",onClick:r=>selectPage(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.pageName||`Sahifa ${a.pageId}`),1)]),_:2},1032,["color","onClick"]))),128))])):createCommentVNode("",!0),groups.value.length?(openBlock(),createElementBlock("div",_hoisted_13,[(openBlock(!0),createElementBlock(Fragment,null,renderList(groups.value,(a,l)=>(openBlock(),createBlock(unref(VaButton),{key:`grp-${a.groupId}`,size:"small",color:l===sel.group?"primary":"secondary",onClick:r=>selectGroup(l)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.groupName||`Guruh #${a.groupId}`),1)]),_:2},1032,["color","onClick"]))),128))])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_14,[parameters.value.length?(openBlock(),createElementBlock("div",_hoisted_15,[(openBlock(!0),createElementBlock(Fragment,null,renderList(parameters.value,a=>(openBlock(),createBlock(unref(VaButton),{key:`param-${a.id}`,color:"warning","text-color":"black",style:{borderRadius:"0"},onClick:l=>appendParam(a)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.name||a.id),1)]),_:2},1032,["onClick"]))),128))])):(openBlock(),createElementBlock("div",_hoisted_16,"Parametrlar topilmadi"))])])]),createVNode(unref(VaTextarea),{class:"w-full mt-3",modelValue:result.Comment,"onUpdate:modelValue":e[17]||(e[17]=a=>result.Comment=a),"max-length":125,label:"Izoh"},null,8,["modelValue"])]),_:1},8,["modelValue"]))}},FormulaModalEdit=_export_sfc(_sfc_main$2,[["__scopeId","data-v-00bb6afd"]]),_hoisted_1$1={class:"h-full w-full"},_hoisted_2$1={class:"va-h3 mb-4"},_hoisted_3$1={class:"flex items-center justify-between w-full"},_hoisted_4$1={class:"flex items-center w-5/6"},_hoisted_5={key:0,class:"text-green-600"},_hoisted_6={class:"flex justify-between items-center w-1/6"},_sfc_main$1={__name:"ParamsControl",props:["params"],setup(o){const{t:e}=useI18n(),{init:a}=useToast(),l=o,r=inject("onupdated"),n=ref(!1),p=ref([]),v=ref([]),d={visible:!0,showInfo:!0,showPageSizeSelector:!0,allowedPageSizes:[10,20,50]},b=ref(!1),c=ref(!1);ref(!1);const B=ref(null),m=ref("");function S(i,u){B.value={...i,id:u},m.value="",b.value=!0}async function x(i,u){B.value={...i,id:u,ParameterID:i.ParameterID||i.param_id||null},c.value=!0}const h=async()=>{n.value=!0,v.value=[];try{const{data:i}=await axios.get(`/addfordocSelect/${l.params.data.NumberPage}`);p.value=D(i.tree),v.value=T(i.selected)}catch(i){console.error(i),a({message:"Maʼlumotni olishda xatolik",color:"danger"})}};async function g(i){const u=i.ParameterID;if(u&&confirm("Formulani o‘chirmoqchimisiz?"))try{await axios.delete(`/svodkaFormula/${u}`),a({message:e("common.deleted"),color:"success"}),p.value=p.value.map(N=>N.rowId===i.rowId?{...N,hasFormula:!1,formulaId:null}:N)}catch(N){console.error(N),a({message:e("errors.saveFailed"),color:"danger"})}}function T(i){return Array.isArray(i)?i.flat(5).filter(Boolean):[]}function D(i){const u=[];return Array.isArray(i)&&i.forEach(N=>{var k;const y=parseInt(String(N.key).split("-")[1]),$=N.title;(k=N.children)==null||k.forEach(s=>{var P;const f=parseInt(String(s.key).split("-")[2]),_=s.title;(P=s.children)==null||P.forEach(w=>{var E;const V=parseInt(String(w.key).split("-")[3]),R=w.title;(E=w.children)==null||E.forEach(O=>{u.push({rowId:O.ParameterID??`param-${O.key}`,sexName:$,sexId:y,pageName:_,pageId:f,groupName:R,groupId:V,paramName:O.title,ParameterID:O.ParameterID})})})})}),u}const C=({selectedRowKeys:i})=>{v.value=i},I=async()=>{const i=p.value.filter(k=>v.value.includes(k.rowId)),u=[...new Set(i.map(k=>k.sexId))],N=u.map(k=>{const s=i.filter(f=>f.sexId===k).map(f=>f.pageId);return[...new Set(s)]}),y=u.map(k=>{const s=i.filter(_=>_.sexId===k);return[...new Set(s.map(_=>_.pageId))].map(_=>{const P=s.filter(w=>w.pageId===_).map(w=>w.groupId);return[...new Set(P)]})}),$=u.map(k=>{const s=i.filter(_=>_.sexId===k);return[...new Set(s.map(_=>_.pageId))].map(_=>{const P=s.filter(V=>V.pageId===_);return[...new Set(P.map(V=>V.groupId))].map(V=>P.filter(E=>E.groupId===V).map(E=>E.ParameterID).filter(Boolean))})});try{const{data:k}=await axios.post("/addfordoc",{doc_id:l.params.data.id,FactoryStructureID:u,NumberPageBlogs:N,GroupBlogs:y,ParameterBlogs:$});if(k.status===200)r==null||r(),n.value=!1,a({message:e("login.successMessage"),color:"success"});else throw new Error(k.message||"Unknown error")}catch(k){console.error(k),a({message:e("errors.saveFailed"),color:"danger"})}};return(i,u)=>{const N=resolveComponent("VaIcon");return openBlock(),createElementBlock("main",_hoisted_1$1,[createVNode(unref(VaButton),{icon:"star",round:"",preset:"primary",onClick:h}),createVNode(unref(VaModal),{modelValue:n.value,"onUpdate:modelValue":u[0]||(u[0]=y=>n.value=y),"ok-text":unref(e)("modals.apply"),"cancel-text":unref(e)("modals.cancel"),onOk:I,onClose:u[1]||(u[1]=y=>n.value=!1),"close-button":"","max-width":"1000px"},{default:withCtx(()=>[createBaseVNode("h3",_hoisted_2$1,toDisplayString(unref(e)("modals.editFactory")),1),p.value.length?(openBlock(),createBlock(unref(DxDataGrid),{key:0,"data-source":p.value,"key-expr":"rowId","selected-row-keys":v.value,onSelectionChanged:C,"repaint-changes-only":!0,"show-borders":"","row-alternation-enabled":"","column-auto-width":"","word-wrap-enabled":"",pager:d},{paramCell:withCtx(({data:y})=>[createBaseVNode("div",_hoisted_3$1,[createBaseVNode("div",_hoisted_4$1,[v.value.includes(y.data.rowId)?(openBlock(),createElementBlock("span",_hoisted_5,"✅")):createCommentVNode("",!0),createBaseVNode("span",null,toDisplayString(y.data.paramName),1)]),createBaseVNode("div",_hoisted_6,[createVNode(unref(VaButton),{round:"",color:"info",class:"m-1",style:{"--va-button-height":"30px","--va-button-padding":"0",width:"30px",minWidth:"30px",borderRadius:"9999px"},onClick:$=>S(y.data,l.params.data.NumberPage)},{default:withCtx(()=>[createVNode(N,{name:"calculate",size:"16px"})]),_:2},1032,["onClick"]),createVNode(unref(VaButton),{round:"",color:"primary",class:"m-1",style:{"--va-button-height":"30px","--va-button-padding":"0",width:"30px",minWidth:"30px",borderRadius:"9999px"},onClick:$=>x(y.data,l.params.data.NumberPage)},{default:withCtx(()=>[createVNode(N,{name:"edit",size:"16px"})]),_:2},1032,["onClick"]),createVNode(unref(VaButton),{round:"",color:"danger",class:"m-1",style:{"--va-button-height":"30px","--va-button-padding":"0",width:"30px",minWidth:"30px",borderRadius:"9999px"},onClick:$=>g(y.data)},{default:withCtx(()=>[createVNode(N,{name:"delete",size:"16px"})]),_:2},1032,["onClick"])])])]),default:withCtx(()=>[createVNode(unref(DxColumn),{"data-field":"sexName",caption:unref(e)("form.structureName"),"group-index":0},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"pageName",caption:unref(e)("form.numberpage"),"group-index":1},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"groupName",caption:unref(e)("menu.groups"),"group-index":2},null,8,["caption"]),createVNode(unref(DxColumn),{"data-field":"paramName",caption:unref(e)("form.name"),"cell-template":"paramCell","min-width":320,"allow-sorting":!1},null,8,["caption"])]),_:1},8,["data-source","selected-row-keys"])):createCommentVNode("",!0)]),_:1},8,["modelValue","ok-text","cancel-text"]),c.value?(openBlock(),createBlock(FormulaModalEdit,{key:0,modelValue:c.value,"onUpdate:modelValue":u[2]||(u[2]=y=>c.value=y),parameter:B.value,formula:m.value,onSave:i.handleFormulaSave,onClose:i.handleFormulaClose},null,8,["modelValue","parameter","formula","onSave","onClose"])):createCommentVNode("",!0),b.value?(openBlock(),createBlock(FormulaModal,{key:1,modelValue:b.value,"onUpdate:modelValue":u[3]||(u[3]=y=>b.value=y),parameter:B.value,formula:m.value,onSave:i.handleFormulaSave,onClose:i.handleFormulaClose},null,8,["modelValue","parameter","formula","onSave","onClose"])):createCommentVNode("",!0)])}}},ParamsControl=_export_sfc(_sfc_main$1,[["__scopeId","data-v-d2c985f3"]]),_hoisted_1={class:"grid grid-rows-[55px,1fr]"},_hoisted_2={class:"flex justify-between"},_hoisted_3={class:"va-h3"},_hoisted_4={class:"flex-grow"},_sfc_main={__name:"NumberPage",props:{id:Number},setup(o){const{init:e}=useToast(),a=useStore(),{locale:l,t:r}=useI18n(),n=o,p=ref([]),v=ref(null),d=ref(!1),b=ref([]),c=reactive({StructureID:n.id,Name:"",NameRus:"",NumberPage:"",Comment:""}),B=computed(()=>a.state.user.roles[17]),m=s=>{var f,_;return((_=(f=B.value)==null?void 0:f.pivot)==null?void 0:_[s])==="1"},S=s=>n.id===22,x=computed(()=>m("create")),h=computed(()=>m("update")),g=computed(()=>m("delete"));computed(()=>S);function T(s){v.value.applyTransaction({remove:[s]})}function D(s,f){s.setData(f)}provide("ondeleted",T),provide("onupdated",D);const C=computed(()=>{const s=[{headerName:r("table.headerRow"),valueGetter:"node.rowIndex + 1"},{headerName:r("table.structure"),field:N(),flex:1},{headerName:r("table.name"),field:i(),flex:1},{headerName:r("table.numberpage"),field:"NumberPage"},{headerName:r("table.comment"),field:u()}];return n.id==22&&s.push({cellClass:["px-0"],headerName:"",field:"",width:70,cellRenderer:ParamsControl}),n.id==22&&s.push({cellClass:["px-0"],headerName:"",field:"",width:70,cellRenderer:_sfc_main$4}),h.value&&s.push({cellClass:["px-0"],headerName:"",field:"",width:70,cellRenderer:_sfc_main$5}),g.value&&s.push({cellClass:["px-0"],headerName:"",field:"",width:70,cellRenderer:_sfc_main$6}),s}),I={sortable:!0,filter:!0},i=()=>l.value==="uz"?"Name":"NameRus",u=()=>l.value==="uz"?"ShortName":"ShortNameRus",N=()=>l.value==="uz"?"SName":"NameRus",y=async()=>{try{const s=await axios.get(`/getRowPage/${n.id}`);p.value=Array.isArray(s.data)?s.data:s.data.items}catch(s){console.error("Error fetching data:",s)}},$=async()=>{try{const s=await axios.get("/structure");b.value=s.data.map(f=>({value:f.id,text:l.value==="uz"?f.Name:f.NameRus}))}catch(s){console.error("Error fetching graphics data:",s)}},k=async()=>{try{const{data:s}=await axios.post("/pages",c);s.status===200?(d.value=!1,c.StructureID="",c.Name="",c.NameRus="",c.NumberPage="",c.Comment="",await y(),e({message:r("login.successMessage"),color:"success"})):console.error("Error saving data:",s.message)}catch(s){console.error("Error saving data:",s)}};return onMounted(()=>{const s=localStorage.getItem("locale");s&&(l.value=s),y(),$()}),computed(()=>l.value==="uz"?"Русский":"O‘zbek"),(s,f)=>{const _=resolveComponent("VaTextarea"),P=resolveComponent("VaModal"),w=resolveComponent("ag-grid-vue");return openBlock(),createElementBlock("div",_hoisted_1,[createBaseVNode("main",null,[createBaseVNode("div",_hoisted_2,[f[7]||(f[7]=createBaseVNode("span",{class:"flex w-full"},null,-1)),x.value?(openBlock(),createBlock(unref(VaButton),{key:0,onClick:f[0]||(f[0]=V=>(d.value=!0,$)),class:"w-14 h-12 mt-1 mr-1",icon:"add"})):createCommentVNode("",!0)]),createVNode(P,{modelValue:d.value,"onUpdate:modelValue":f[5]||(f[5]=V=>d.value=V),"ok-text":unref(r)("buttons.save"),"cancel-text":unref(r)("buttons.cancel"),onOk:k,"close-button":""},{default:withCtx(()=>[createBaseVNode("h3",_hoisted_3,toDisplayString(unref(r)("modals.addPageTitle")),1),createBaseVNode("div",null,[createVNode(unref(VaForm),{ref:"formRef",class:"flex flex-col items-baseline gap-1"},{default:withCtx(()=>[createVNode(unref(VaInput),{class:"w-full",modelValue:c.NumberPage,"onUpdate:modelValue":f[1]||(f[1]=V=>c.NumberPage=V),type:"number",rules:[V=>V&&V.length>0||unref(r)("validation.requiredField")],label:unref(r)("form.numberpage")},null,8,["modelValue","rules","label"]),createVNode(unref(VaInput),{class:"w-full",modelValue:c.Name,"onUpdate:modelValue":f[2]||(f[2]=V=>c.Name=V),rules:[V=>V&&V.length>0||unref(r)("validation.requiredField")],label:unref(r)("form.name")},null,8,["modelValue","rules","label"]),createVNode(unref(VaInput),{class:"w-full",modelValue:c.NameRus,"onUpdate:modelValue":f[3]||(f[3]=V=>c.NameRus=V),rules:[V=>V&&V.length>0||unref(r)("validation.requiredField")],label:unref(r)("form.nameRus")},null,8,["modelValue","rules","label"]),createVNode(_,{class:"w-full",modelValue:c.Comment,"onUpdate:modelValue":f[4]||(f[4]=V=>c.Comment=V),"max-length":"125",label:unref(r)("form.comment")},null,8,["modelValue","label"])]),_:1},512)])]),_:1},8,["modelValue","ok-text","cancel-text"])]),createBaseVNode("main",_hoisted_4,[createVNode(w,{rowData:p.value,columnDefs:C.value,defaultColDef:I,animateRows:"true",class:"ag-theme-material h-full",onGridReady:f[6]||(f[6]=V=>v.value=V.api)},null,8,["rowData","columnDefs"])])])}}};export{_sfc_main as default};
