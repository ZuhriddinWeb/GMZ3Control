import{b as we,r as y,o as Ce,L as O,f as G,g as A,h as V,i as w,j as le,G as W,l as se,I as xe,J as ke,F as Ve,x as Ne,t as z,a6 as $e,n as M,P as ue}from"./app-A8jI9ma8.js";import{j as _e}from"./jsuites-SNr_sQO5.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const Se={class:"grid grid-rows-[55px,1fr]"},Ae={class:"flex-grow mt-10"},Te={key:0,class:"fixed inset-0 z-50 bg-black/40 flex items-center justify-center"},De={class:"bg-white rounded-xl p-6 w-[360px] text-center shadow-lg"},Fe={class:"w-full h-2 bg-gray-200 rounded overflow-hidden"},Ee={class:"mt-2 text-sm text-gray-600"},Be={key:0,class:"mt-3 text-red-600 text-sm"},Re={__name:"Documents",setup(Pe){const U=we(),g=y(new Date),H=y(null),b=y([]),T=y([]),h=y(null);let l=null;const D=y(!1),x=y(0),N=y("");let F=null;function ce(t){return new Promise(e=>setTimeout(e,t))}function ie(t,e){const o=[];for(let a=0;a<t.length;a+=e)o.push(t.slice(a,a+e));return o}(async()=>{try{const{data:t}=await M.get("/getRowPage/22");T.value=Array.isArray(t)?t:t.items||[],T.value.length&&!h.value&&(h.value=T.value[0].NumberPage,await E(h.value,g.value))}catch(t){console.error("getRowPage error",t)}})();const E=async(t,e)=>{try{const{data:o}=await M.get(`/selectResultBlogs/${t}/${$(e)}`);b.value=o}catch(o){console.error("selectResultBlogs error",o)}},de=async t=>{if(Number(t)===303){U.push({name:"gmz3-report",query:{date:$(g.value)}});return}else if(Number(t)===301){U.push({name:"gmz3-report301",query:{date:$(g.value)}});return}h.value=t,await E(h.value,g.value)};function L(){if(!b.value||typeof b.value!="object")return"";const t=Object.keys(b.value||{});if(!t.length)return"";const e=b.value[t[0]];if(!e)return"";const o=Object.keys(e);if(!o.length)return"";const a=e[o[0]];if(!a)return"";const n=Object.keys(a);if(!n.length)return"";const r=a[n[0]];return!r||!r.length?"":r[0].group_name||""}const Q=L();l&&Q&&l.setValue("A3",Q);const fe={A1:"border-left:2px solid #000;border-right:1px solid #fff;border-top:1px solid #000;border-bottom:1px solid #000;w-200;",A2:"background:yellow",B2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",C2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",D2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",E2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",F2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",G2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",H2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",I2:"border-right:none;border-left:none;background:yellow;font-weight: bold;",A3:"border-right:none;border-left:none;font-weight: bold;",B3:"border-right:none;border-left:none;font-weight: bold;",C3:"border-right:none;border-left:none;font-weight: bold;",A4:"font-weight: bold;",B4:"font-weight: bold;",C4:"color:red;font-weight: bold;"};function $(t){if(!t)return"";const e=new Date(t),o=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),n=e.getFullYear();return`${o}.${a}.${n}`}Ce(()=>{E(g.value);const t=[[$(g.value),...Array(18).fill("")],Array(300).fill("")];function e(a){let n="",r=a;for(;r>=0;)n=String.fromCharCode(r%26+65)+n,r=Math.floor(r/26)-1;return n}const o=Array.from({length:300},(a,n)=>({title:e(n),width:n===0?150:100}));l=_e(H.value,{data:t,style:fe,columns:o,minDimensions:[150,500],merge:[{row:0,col:0,rowspan:1,colspan:14},{row:1,col:0,rowspan:1,colspan:14}],onchange:(a,n,r,s,c)=>{v(r)}}),l.setValue("A1",$(g.value)),l.setValue("C2","OTK"),l.setValue("D2",""),l.setValue("E2","laboratoriyasi"),l.setValue("G2","tahlili")});function ge(t){if(!t)return"";const e=t.split(":");return e[0]+":"+e[1]}function v(t){let e="",o=t;for(;o>=0;)e=String.fromCharCode(o%26+65)+e,o=Math.floor(o/26)-1;return e}function he(t,e,o,a,n,r="#d10000"){const s=e+a-1,c=o+n-1;let d={};for(let u=e;u<=s;u++)d[`${v(o)}${u+1}`]=`border-left: 2px solid ${r};`,d[`${v(c)}${u+1}`]=`border-right: 2px solid ${r};`;for(let u=o;u<=c;u++){const f=v(u);d[`${f}${e+1}`]=`border-top: 2px solid ${r};`,d[`${f}${s+1}`]=`border-bottom: 2px solid ${r};`}t.setStyle(d)}function K(t){const e=new Date(t),o=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),n=e.getFullYear();return`${o}.${a}.${n}`}function me(t){const e=String(t).toUpperCase().match(/^([A-Z]+)(\d+)$/);if(!e)return null;const o=e[1],a=parseInt(e[2],10)-1;let n=0;for(let r=0;r<o.length;r++)n=n*26+(o.charCodeAt(r)-64);return{x:n-1,y:a}}function be(){if(!l||!l.getData)return[];const t=l.getData();let e=-1,o=-1;for(let n=0;n<t.length;n++){const r=t[n]||[];for(let s=0;s<r.length;s++){const c=r[s];c!==""&&c!==null&&c!==void 0&&(n>e&&(e=n),s>o&&(o=s))}}if(e<0||o<0)return[];const a=[];for(let n=0;n<=e;n++)for(let r=0;r<=o;r++){const s=l.getValueFromCoords(r,n);if(s===""||s===null||s===void 0)continue;const c=`${v(r)}${n+1}`,d=Number(String(s).replace(",","."));a.push({cell:c,value:Number.isFinite(d)?d:null})}return a}async function Y(t,e){var c;const o=be();if(!o.length){D.value=!1,x.value=100;return}D.value=!0,x.value=0,N.value="",F={numberPage:t,dateObj:e};const a=o.length,r=ie(o,200);let s=0;for(let d=0;d<r.length;d++){const u=r[d];try{await M.post("/sheet/values/bulk",{numberPage:Number(t),date:K(e),items:u}),s+=u.length,x.value=Math.min(100,Math.round(s/a*100)),await ue()}catch(f){console.error("bulk save error",((c=f==null?void 0:f.response)==null?void 0:c.data)||f),N.value='Saqlashda xatolik. "Qayta urinish" tugmasini bosing.';return}}x.value=100,await ce(150),D.value=!1}async function pe(){F&&await Y(F.numberPage,F.dateObj)}function ve(t){return cellsToCacheByPage[t]||cellsToCacheByPage.default}async function ye(t,e,o){if(!l||!Array.isArray(o)||!o.length)return;const a=[];for(const n of o){const r=me(n);if(!r)continue;const s=l.getValueFromCoords(r.x,r.y),c=Number(s);a.push({cell:n,value:isFinite(c)?c:null})}a.length&&await M.post("/sheet/values/bulk",{numberPage:Number(t),date:K(e),items:a})}return setTimeout(()=>{const t=Number(h.value);if(!t)return;const e=ve(t);ye(t,g.value,e).catch(o=>console.error("cacheSheetValues error",o))},0),O(g,t=>{h.value&&E(h.value,t)}),O(b,()=>{console.log("Qabul qilingan rowData:",b.value);let t=L();console.log("Aniqlangan groupName:",t),l&&t&&l.setValue("A3",t)}),O(b,async()=>{const t=Object.keys(b.value||{});if(!l||!t.length)return;let e=2,o=0,a=0;t.forEach(n=>{var d;const r=b.value[n],s=Object.keys(r);let c=0;s.forEach(u=>{var te,oe;const f=r[u],B=Object.keys(f),J=new Set;B.forEach(i=>{(f[i]||[]).forEach(m=>J.add(m.parameter_name))});const q=Array.from(J),Z=Array.from(new Set(B.map(i=>{var m;return((m=(f[i]||[])[0])==null?void 0:m.time_name)||""}))).sort(),R=q.length+1,X=Z.length+3;c=Math.max(c,X),l.setValueFromCoords(o,e,((oe=(te=f[B[0]])==null?void 0:te[0])==null?void 0:oe.group_name)||""),l.setValueFromCoords(o,e+1,`${u}-Smena`);const P={};for(let i=0;i<R;i++){const p=`${v(o+i)}${e+1}`;P[p]="background: #c7efc4; font-weight: bold;";const m=`${v(o+i)}${e+2}`;P[m]="background: #cfe2f3; font-weight: bold;";const _=`${v(o+i)}${e+3}`;P[_]="background: #c9b2d6; font-weight: bold;"}setTimeout(()=>l.setStyle(P),10),l.setValueFromCoords(o,e+2,"Vaqt"),q.forEach((i,p)=>{l.setValueFromCoords(o+1+p,e+2,i)});const ee=new Map;q.forEach((i,p)=>ee.set(i,p)),Z.forEach((i,p)=>{const m=e+3+p;l.setValueFromCoords(o,m,ge(i));const _=l.getCellFromCoords(o,m);_&&(_.style.backgroundColor="#bbfcc1",_.style.fontWeight="bold");const re=[];B.forEach(C=>{var S;const j=f[C]||[];((S=j[0])==null?void 0:S.time_name)===i&&re.push(...j)}),re.forEach(C=>{const j=C.parameter_name,S=ee.get(j);if(S===void 0)return;const ne=o+1+S,I=Number(C.Value);l.setValueFromCoords(ne,m,isNaN(I)?C.Value:I);const ae=Number(C.Min),k=l.getCellFromCoords(ne,m);k&&!isNaN(I)&&!isNaN(ae)&&I<ae&&(k.style.backgroundColor="yellow",k.style.color="red",k.style.fontWeight="bold"),C.WithFormula==="1"&&k&&(k.style.border="1px dashed #444")})}),setTimeout(()=>he(l,e,o,X,R,"#d10000"),10),a+=1,a%2===0?(e+=c+2,o=0):o+=R+2}),a%2!==0&&(e+=c+2,o=0,a=0),ue();try{const u=Number(h.value);u&&Y(u,g.value)}catch(u){console.error("cacheWholeSheet error",((d=u==null?void 0:u.response)==null?void 0:d.data)||u)}})}),(t,e)=>{const o=G("VaDateInput"),a=G("VaTab"),n=G("VaTabs");return V(),A("div",Se,[e[3]||(e[3]=w("main",null,null,-1)),w("main",Ae,[le(o,{modelValue:g.value,"onUpdate:modelValue":e[0]||(e[0]=r=>g.value=r),class:"mb-10",onchange:"fetchData(value)"},null,8,["modelValue"]),le(n,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=r=>h.value=r),class:"mb-6"},{default:se(()=>[(V(!0),A(xe,null,ke(T.value,r=>(V(),Ve(a,{key:r.NumberPage,name:r.NumberPage,onClick:s=>de(r.NumberPage)},{default:se(()=>[Ne(z(r.Name),1)]),_:2},1032,["name","onClick"]))),128))]),_:1},8,["modelValue"]),w("div",{ref_key:"sheetEl",ref:H,style:{width:"100vw",height:"100vh"}},null,512),D.value?(V(),A("div",Te,[w("div",De,[e[2]||(e[2]=w("div",{class:"text-lg font-semibold mb-3"},"Keshga yozilmoqdaâ€¦",-1)),w("div",Fe,[w("div",{class:"h-2 rounded",style:$e({width:x.value+"%",background:"#3b82f6"})},null,4)]),w("div",Ee,z(x.value)+"%",1),N.value?(V(),A("div",Be,z(N.value),1)):W("",!0),N.value?(V(),A("button",{key:1,class:"mt-4 px-4 py-2 rounded bg-blue-600 text-white",onClick:pe}," Qayta urinish ")):W("",!0)])])):W("",!0)])])}}};export{Re as default};
