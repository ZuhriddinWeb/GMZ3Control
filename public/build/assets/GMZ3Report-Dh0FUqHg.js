import{u as G,r as h,o as P,K as C,g as Z,h as J,i as k,j as E,l as T,x as U,k as F,z as W,aj as Y,n as m}from"./app-NUfPaPq9.js";import{j as z}from"./jsuites-C5GWK6re.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const L={class:"p-3 pt-28"},q={class:"flex items-center gap-3 mb-3"},B=303,ae={__name:"GMZ3Report",setup(X){const{init:V}=G(),A=h(null),i=h(new Date);let t=null;const x=h({});let b=!1;const w=h([]),v=a=>{const e=new Date(a);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function M(){try{const{data:a}=await m.get("/static"),e=Array.isArray(a)?a:a.items||[];w.value=e}catch(a){console.error(a),V({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function I(a){const e=new Date(a),o=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),s=e.getFullYear();return`${o}.${n}.${s}`}function S(a){let e="",o=a;for(;o>=0;)e=String.fromCharCode(o%26+65)+e,o=Math.floor(o/26)-1;return e}function $(a){const e=a.match(/^([A-Z]+)(\d+)$/),o=+e[2]-1;let n=0;for(const s of e[1])n=n*26+(s.charCodeAt(0)-64);return{x:n-1,y:o}}function g(a){const[e,o]=a.split(":"),n=$(e),s=$(o);return{row:Math.min(n.y,s.y),col:Math.min(n.x,s.x),rowspan:Math.abs(n.y-s.y)+1,colspan:Math.abs(n.x-s.x)+1}}async function p(){const a=[],e=new Set;for(const r of w.value){const l=(r==null?void 0:r.ParameterID)??(r==null?void 0:r.id)??(r==null?void 0:r.Uuid);e.has(l)||(e.add(l),a.push({name:(r==null?void 0:r.PName)||(r==null?void 0:r.name)||l,unit:(r==null?void 0:r.UName)||"tn."}))}const o=150,n=Math.max(150,7+a.length+2),s=Array.from({length:n},()=>Array(o).fill(""));t&&(t.destroy(),t=null),t=z(A.value,{data:s,columns:Array.from({length:o},(r,l)=>({title:S(l),width:l===0?520:l===1?120:110})),minDimensions:[o,n],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[g("A1:F1"),g("A2:F2"),g("B4:B5"),g("C4:E4")],onchange:async(r,l,f,u,y)=>{if(b)return;const N=Number(f),K=Number(u)+1,O=`${S(N)}${K}`;if(typeof y=="string"&&y.trim().startsWith("="))try{await j(O,y.trim())}catch(R){console.error(R),V({message:"Formula xatolik",color:"danger"})}}}),t.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),t.setValue("A2",`${I(i.value)} y.`),t.setValue("A3","—"),t.setValue("A4","Ko'rsatgichlar nomi."),t.setValue("B4","o'lchov birligi"),t.setValue("C4","Kunlik"),t.setValue("C5","reja"),t.setValue("D4","Kunlik"),t.setValue("D5","fakt/20:08"),t.setValue("E4","Kunlik"),t.setValue("E5","fakt/08:20"),t.setValue("F4","Kunlik"),t.setValue("F5","fakt jami"),t.setValue("G4",""),t.setValue("G5","%"),t.setValue("H4","Oylik"),t.setValue("H5","reja"),t.setValue("I4","Oylik"),t.setValue("I5","fakt"),t.setValue("J4","Kunlik"),t.setValue("J5","%"),t.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const c={};["A","B","C","D","E","F"].forEach(r=>c[`${r}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(r=>c[`${r}5`]="border:1px solid #bdbdbd;"),t.setStyle(c);let d=7;for(const r of a){t.setValue(`A${d}`,r.name),t.setValue(`B${d}`,r.unit);const l={};l[`A${d}`]="border:1px solid #dddddd;padding-left:6px;",l[`B${d}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(f=>{l[`${f}${d}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),t.setStyle(l),t.setHeight(d-1,26),d++}t.setHeight(0,34),t.setHeight(1,28),t.setHeight(3,28),t.setHeight(4,24),await H()}async function _(a,e,o){const{data:n}=await m.get("/sheet/value",{params:{numberPage:a,cell:e,date:v(o)}});return Number((n==null?void 0:n.value)??0)}async function D(a,e){let o=String(a).trim();const n=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,s=/'?(\d+)'?\!([A-Z]+\d+)/g,c=[];o.replace(n,(l,f,u)=>(c.push({page:+f,cell:u}),"")),o.replace(s,(l,f,u)=>(c.push({page:+f,cell:u}),""));const d=await Promise.all(c.map(l=>_(l.page,l.cell,e)));let r=0;return o=o.replace(n,()=>String(d[r++])),o=o.replace(s,()=>String(d[r++])),o.startsWith("=")||(o="="+o),o}async function j(a,e){x.value[a]=e,await m.post("/sheet/formula",{numberPage:B,cell:a,expr:e,scope:"permanent"});const o=await D(e,i.value);b=!0,t.setValue(a,o),b=!1;const n={};n[a]="border:1px dashed #444;font-weight:600;",t.setStyle(n)}async function H(){const{data:a}=await m.get("/sheet/formula",{params:{numberPage:B,date:v(i.value)}});((a==null?void 0:a.items)||a||[]).forEach(e=>{x.value[e.cell]=e.expr});for(const[e,o]of Object.entries(x.value))try{const n=await D(o,i.value);b=!0,t.setValue(e,n),b=!1;const s={};s[e]="border:1px dashed #444;font-weight:600;",t.setStyle(s)}catch(n){console.error("Formula error",e,o,n)}}return P(async()=>{await M(),p()}),C(i,p),C(w,p),(a,e)=>(J(),Z("div",L,[k("div",q,[E(F(W),{preset:"secondary",onClick:e[0]||(e[0]=o=>a.$router.back())},{default:T(()=>e[2]||(e[2]=[U("← Orqaga",-1)])),_:1,__:[2]}),E(F(Y),{modelValue:i.value,"onUpdate:modelValue":[e[1]||(e[1]=o=>i.value=o),p]},null,8,["modelValue"]),e[3]||(e[3]=k("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),k("div",{ref_key:"sheetEl",ref:A,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{ae as default};
