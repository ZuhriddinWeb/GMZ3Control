import{c as ee,r as n,d as ae,x as te,I as le,o as re,J as ne,f as D,g as se,h as oe,i as V,k as T,j as de,m as v}from"./app-8468be71.js";/* empty css                   */import{f as y}from"./format-45c98358.js";const ce={class:"grid grid-rows-[55px,1fr]"},ie=V("main",null,null,-1),ue={class:"flex flex-col"},me={class:"m-2"},he="yyyy-MM-dd",fe=8*60,ve=19*60+59,_e={__name:"ParametrValue",setup(ge){const{t:l,locale:M}=ee(),S=n([]),o=n(null),w=n({}),x=n([]),g=n(new Date);n(null),n(null);const c=n(null),O=store.state.user.id,E=n([]),i=ae({Change:""}),N=n([{headerName:l("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center"},{headerName:l("table.change"),field:"Change",width:80,headerClass:"header-center"},{headerName:l("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center"},{headerName:l("table.parameters"),field:te(()=>M.value==="ru"?"PNameRus":"PName"),flex:1,headerClass:"header-center"},{headerName:l("table.graphictimes"),headerClass:"header-center",children:[{headerName:l("table.startingTime"),field:"STime",width:120,valueFormatter:e=>y(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center"},{headerName:l("table.endingTime"),field:"ETime",width:120,valueFormatter:e=>y(new Date(`1970-01-01T${e.value}`),"HH:mm"),headerClass:"header-center"}]},{headerName:l("table.interval"),headerClass:"header-center",children:[{headerName:l("table.min"),field:"Min",width:100,headerClass:"header-center"},{headerName:l("table.max"),field:"Max",width:100,headerClass:"header-center"}]},{headerName:l("table.value"),field:"Value",width:150,editable:!0,cellEditor:"agNumberCellEditor",cellClassRules:{"cell-green":e=>e.data&&e.data.Value===w.value[e.data.id],"cell-yellow":e=>e.data&&e.data.Value!==w.value[e.data.id]&&w.value[e.data.id]===void 0},cellStyle:{"font-size":"16px","text-align":"center"},headerClass:"header-center"},{headerName:l("table.comment"),field:"Comment",flex:1,editable:!0,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]),$=async()=>{try{const e=await v.get("/changes");x.value=e.data.map(a=>({value:a.Change,text:a.Change}))}catch(e){console.error("Error fetching graphics data:",e)}},B={sortable:!0,filter:!0,resizable:!0},H=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",k={columnDefs:N.value,getRowClass:H,headerHeight:43},A=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},L=()=>{const e=A();return e>=fe&&e<=ve?1:2};i.Change=L();const u=async()=>{try{const e=i.Change,a=y(g.value,he),[r,f]=await v.all([v.get(`/get-params-for-user/${store.state.user.structure_id}/${e}/${a}`),v.get(`/vparams/${store.state.user.structure_id}`)]),d=Array.isArray(r.data)?r.data:[],s=d.map(t=>`${t.ParametersID}_${t.GTid}`),W=E.value.map(t=>`${t.ParametersID}_${t.GTid}`),G=new Set(s),P=new Set(W),X=[...G].filter(t=>!P.has(t)),Y=[...P].filter(t=>!G.has(t)),b=[...X,...Y].map(t=>d.find(p=>t===`${p.ParametersID}_${p.GTid}`)).filter(t=>t!==void 0),Z=f.data;b.forEach((t,p)=>{const R=Z.find(F=>F.TimeID===t.GTid&&F.ParametersID===t.ParametersID);R&&(b[p]={...t,...R})}),o.value.applyTransaction({add:b,addIndex:0}),E.value=d}catch(e){console.error("Error fetching data:",e)}},U=async e=>{const{data:a,colDef:r,newValue:f,oldValue:d}=e;if(f!==d)try{await z(a);const s=e.rowIndex;o.value&&o.value.ensureIndexVisible(s,"bottom")}catch(s){console.error("Error saving data",s)}},z=async e=>{try{const a=await v.post("/vparams",{...e,userId:O});return j(),u(),a}catch(a){console.error("Error saving data",a)}},j=()=>{o.value&&o.value.clearFocusedCell()},J=()=>{C.value&&o.value&&(o.value.stopEditing(),C.value=!1,u())};let m=null,h=null,C=n(!1);const q=e=>{const{column:a}=e;if(a){const r=a.getColId();r==="Value"||r==="Comment"?(_(),C.value=!0,c.value&&clearTimeout(c.value),c.value=setTimeout(J,3e4)):I()}},K=e=>{const{column:a}=e;if(a){const r=a.getColId();(r==="Value"||r==="Comment")&&(_(),C.value=!1,c.value&&(clearTimeout(c.value),c.value=null))}},I=()=>{m||(m=setInterval(u,5e3)),h||(h=setInterval($,5e3))},_=()=>{m&&(clearInterval(m),m=null),h&&(clearInterval(h),h=null)},Q=e=>{o.value=e.api,e.api.addEventListener("cellFocused",q),e.api.addEventListener("cellBlurred",K),I()};return le([()=>i.Change,()=>g.value],u),re(()=>{u(),$(),I()}),ne(()=>{_()}),(e,a)=>{const r=D("VaDateInput"),f=D("VaSelect"),d=D("ag-grid-vue");return se(),oe("div",ce,[ie,V("main",ue,[V("div",me,[T(r,{modelValue:g.value,"onUpdate:modelValue":a[0]||(a[0]=s=>g.value=s),class:"mr-2",label:"Day"},null,8,["modelValue"]),T(f,{modelValue:i.Change,"onUpdate:modelValue":a[1]||(a[1]=s=>i.Change=s),"value-by":"value",label:de(l)("menu.changes"),options:x.value,clearable:""},null,8,["modelValue","label","options"])]),T(d,{rowData:S.value,columnDefs:N.value,defaultColDef:B,gridOptions:k,animateRows:"true",class:"ag-theme-material h-full",onGridReady:Q,onCellValueChanged:U},null,8,["rowData","columnDefs"])])])}}};export{_e as default};
