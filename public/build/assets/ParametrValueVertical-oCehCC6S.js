import{a as Ve,b as Ie,c as De,r as n,s as x,d as H,K as C,o as xe,L as Ee,f as O,g as z,h as E,i as N,F as W,G as Fe,j as g,l as A,k as V,m as Te,z as j,I as ke,J as Se,x as Re,t as Ae,M as _e,n as f}from"./app-DnsPrLPm.js";/* empty css                   */import{_ as Me}from"./EditValue-BURLzhrs.js";import{V as Pe}from"./VueShiftCalendar-DDZ0Bu5m.js";import{f as I}from"./format-D9pTN3Kd.js";const $e={class:"grid grid-rows-[55px,1fr]"},Le={class:"flex flex-col"},Be={class:"m-2 flex pt-3"},Ge={class:"flex justify-end"},Ke=8*60,Ue=19*60+59,je={__name:"ParametrValueVertical",props:{id:Number},setup(J){const d=Ve(),F=J,Q=Ie(),{t:o,locale:X}=De(),T=n([]),i=n(null),v=n({}),Y=n([]),u=n({smena:null,day:null}),_=x(()=>u.value.day?`${u.value.day} - ${u.value.smena}`:"");n(null);const M=n(null);n(null);const P=n(null);n(null);const h=n(null),Z=d.state.user.id;d.state.user.structure_id;const l=n("1");n([]);const ee=n([]),m=n([]),$=n({}),ae=H({ParametersID:"",Change:"",Name:"",ShortName:"",Comment:"",GTime:"",Value:"",BlogsID:d.state.user.structure_id,SourceID:"",userId:d.state.user.id});C(()=>d.state.user.roles,e=>{Array.isArray(e)&&e.length>14&&($.value=e[14])},{immediate:!0});const L=e=>{var a,t;return((t=(a=$.value)==null?void 0:a.pivot)==null?void 0:t[e])==="1"},B=x(()=>L("create"));x(()=>L("view"));const te=H({id:"",Comment:"",Value:"",userId:d.state.user.id}),G=x(()=>[{headerName:o("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=v.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,s;return a.data&&a.data.Value!==((t=v.value)==null?void 0:t[a.data.id])&&((s=v.value)==null?void 0:s[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"}},{headerName:o("table.change"),field:"Change",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.parameters"),field:X.value==="ru"?"PNameRus":"PName",flex:1,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.graphictimes"),headerClass:"header-center",children:[{headerName:o("table.startingTime"),field:"STime",width:120,valueFormatter:a=>I(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.endingTime"),field:"ETime",width:120,valueFormatter:a=>I(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:o("table.interval"),headerClass:"header-center",children:[{headerName:o("table.min"),field:"Min",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:o("table.max"),field:"Max",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:o("table.value"),field:"Value",width:150,editable:a=>B.value&&a.data.WithFormula!=="1",suppressNavigable:!1,cellEditor:"agNumberCellEditor",cellEditorPopup:!1,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=v.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,s;return a.data&&a.data.Value!==((t=v.value)==null?void 0:t[a.data.id])&&((s=v.value)==null?void 0:s[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"},cellStyle:()=>({"font-size":"16px","text-align":"center"}),headerClass:"header-center"},{headerName:o("table.comment"),field:"Comment",flex:1,editable:()=>B.value,suppressNavigable:!1,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]);C(m,e=>{e.length>0&&(l.value=e[0].NumberPage)},{immediate:!0}),C(u,e=>{p(l.value)},{deep:!0});const le=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(l.value)>1?l.value=String(parseInt(l.value)-1):l.value=String(m.value.length):parseInt(l.value)<m.value.length?l.value=String(parseInt(l.value)+1):l.value="1")},se=e=>{(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight")&&(e.preventDefault(),document.activeElement.classList.contains("ag-cell")&&i.navigateToNextCell({key:e.key}))},re=()=>{window.addEventListener("keydown",e=>{e.key===" "&&ne(e),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&se(e)})},ne=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(l.value)>1?l.value=String(parseInt(l.value)-1):l.value=String(m.value.length):parseInt(l.value)<m.value.length?l.value=String(parseInt(l.value)+1):l.value="1")};function ue(){const e=P.value;document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}const K=async()=>{try{const e=await f.get("/changes"),a=await f.get(`/pages-select/${F.id}`);m.value=a.data;const t=await f.get(`/paramWithId/${F.id}`);Y.value=e.data.map(s=>({value:s.Change,text:s.Change})),ee.value=t.data.map(s=>({value:s.Pid,text:s.PName}))}catch(e){console.error("Error fetching graphics data:",e)}},oe={sortable:!0,filter:!0,resizable:!0},ie=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",de={columnDefs:G.value,suppressScrollOnNewData:!0,getRowClass:ie,headerHeight:27,rowHeight:30,navigateToNextCell:e=>{const{key:a}=e.event;return a==="ArrowUp"||a==="ArrowDown"||a==="ArrowLeft"||a==="ArrowRight"?!0:e.previousCellDef}},ce=e=>{},me=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},fe=()=>{const e=me();return e>=Ke&&e<=Ue?1:2},ve=()=>{Q.push("/vparamsget")};ae.Change=fe();async function p(e){try{const a=u.value.day,t=u.value.smena,[s,r]=await f.all([f.get(`/get-params-for-user/${F.id}/${t}/${a}/${e}`),f.get(`/vparams-value/${d.state.user.structure_id}/${a}/${t}`)]),c=Array.isArray(s.data)?s.data:[],R=Array.isArray(r.data)?r.data:[];c.forEach((b,Ne)=>{const U=R.find(q=>q.TimeStr==b.GTName&&q.ParametersID==b.ParametersID);U&&(c[Ne]={...b,...U})}),T.value=Array.isArray(c)?c:[]}catch(a){console.error("Error fetching data:",a),T.value=[]}}const he=async e=>{const{data:a,colDef:t,newValue:s,oldValue:r}=e;if(s!==r)try{await ge(a,l.value);const c=e.rowIndex,R=i.value.getDisplayedRowCount();if(i.value&&i.value.ensureIndexVisible(c,"bottom"),c<R-1){i.value.stopEditing();const b=t.field==="Value"?"Value":"Comment";i.value.setFocusedCell(c+1,b)}}catch(c){console.error("Error saving data",c)}},ge=async(e,a)=>{const t=u.value.smena,s=u.value.day;try{const r=await f.post("/vparams",{...e,userId:Z,change:t,daySelect:s});return pe(),await p(a),r}catch(r){console.error("Error saving data",r)}},pe=()=>{i.value&&i.value.clearFocusedCell()},ye=()=>{D.value&&i.value&&(i.value.stopEditing(),D.value=!1)};let y=null,w=null,D=n(!1);const we=e=>{const{column:a}=e;if(a){const t=a.getColId();t==="Value"||t==="Comment"?(S(),D.value=!0,h.value&&clearTimeout(h.value),h.value=setTimeout(ye,6e4)):k()}},be=e=>{const{column:a}=e;if(a){const t=a.getColId();(t==="Value"||t==="Comment")&&(S(),D.value=!1,h.value&&(clearTimeout(h.value),h.value=null))}},k=()=>{y||(d.state.newValue=d.state.newValue||1,y=setInterval(()=>p(d.state.newValue),6e4)),w||(w=setInterval(K,6e4))},S=()=>{y&&(clearInterval(y),y=null),w&&(clearInterval(w),w=null)},Ce=e=>{console.log(e),i.value=e.api,e.api.addEventListener("cellFocused",we),e.api.addEventListener("cellBlurred",be),k()};return C(l,e=>{p(e)}),xe(()=>{const e=new Date,a=e.getHours(),t=e.getMinutes();if(a>=8&&a<20||a===19&&t<=59)u.value.smena=1,u.value.day=I(e,"yyyy-MM-dd");else if(u.value.smena=2,a<8){const s=new Date(e);s.setDate(e.getDate()-1),u.value.day=I(s,"yyyy-MM-dd")}else u.value.day=I(e,"yyyy-MM-dd");p(l.value),K(),k(),re()}),C(m,e=>{e.length>0&&(l.value=e[0].NumberPage)},{immediate:!0}),Ee(()=>{S()}),(e,a)=>{const t=O("VaTab"),s=O("ag-grid-vue");return E(),z("div",$e,[a[3]||(a[3]=N("main",null,null,-1)),N("main",Le,[N("div",Be,[g(V(Pe),{modelValue:u.value,"onUpdate:modelValue":a[1]||(a[1]=r=>u.value=r),"with-slot":!0},{default:A(()=>[g(V(Te),{modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=r=>_.value=r),label:"Smena",readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),N("div",Ge,[g(V(j),{onClick:ue,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"fullscreen"}),g(V(j),{onClick:ve,class:"btn btn-primary items-center justify-center mt-3 ml-3",icon:"grade"})])]),N("div",{ref_key:"gridContainer",ref:P,class:"ag-grid-container h-full"},[g(V(_e),{modelValue:l.value,"onUpdate:modelValue":a[2]||(a[2]=r=>l.value=r),stateful:"",grow:"",onKeydown:le,tabindex:"0"},{tabs:A(()=>[(E(!0),z(ke,null,Se(m.value,r=>(E(),W(t,{key:r.NumberPage,name:r.NumberPage},{default:A(()=>[Re(Ae(r.Name),1)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),g(s,{rowData:T.value,columnDefs:G.value,defaultColDef:oe,gridOptions:de,animateRows:"true",class:"ag-theme-material h-full",onGridReady:Ce,onCellValueChanged:he},null,8,["rowData","columnDefs"])],512),M.value?(E(),W(Me,{key:0,showModalEdit:M.value,resultEdit:te,onUpdate:ce},null,8,["showModalEdit","resultEdit"])):Fe("",!0)])])}}};export{je as default};
