import{a as Ae,b as _e,c as Pe,r as o,s as A,d as Z,K as E,o as $e,L as Me,f as ee,g as ae,h as _,i as D,F as te,G as Le,j as p,l as T,k as y,m as Be,x as G,z as P,I as Ge,J as qe,t as Ke,M as Oe,n as v}from"./app-CXTPu4f3.js";/* empty css                   */import{_ as Ue}from"./EditValue-oIR4adpw.js";import{u as q,w as ze}from"./xlsx-RWMVbf22.js";import{V as He}from"./VueShiftCalendar-Cjv9jrZ2.js";import{f as F}from"./format-D9pTN3Kd.js";const je={class:"grid grid-rows-[55px,1fr]"},We={class:"flex flex-col"},Xe={class:"m-2 flex pt-3"},Je={class:"flex justify-end"},Qe=8*60,Ye=19*60+59,ra={__name:"ParametrValueVertical",props:{id:Number},setup(le){const c=Ae(),k=le,se=_e(),{t:d,locale:K}=Pe(),$=o([]),m=o(null),w=o({}),re=o([]),n=o({smena:null,day:null}),O=A(()=>n.value.day?`${n.value.day} - ${n.value.smena}`:"");o(null);const U=o(null);o(null);const z=o(null);o(null);const b=o(null),ne=c.state.user.id;c.state.user.structure_id;const s=o("1");o([]);const oe=o([]),f=o([]),H=o({}),ue=Z({ParametersID:"",Change:"",Name:"",ShortName:"",Comment:"",GTime:"",Value:"",BlogsID:c.state.user.structure_id,SourceID:"",userId:c.state.user.id});E(()=>c.state.user.roles,e=>{Array.isArray(e)&&e.length>14&&(H.value=e[14])},{immediate:!0});const j=e=>{var a,t;return((t=(a=H.value)==null?void 0:a.pivot)==null?void 0:t[e])==="1"},ie=async()=>{var l,r;if(!f.value.length)return;const e=q.book_new();for(const u of f.value)try{const h=n.value.day,g=n.value.smena,[R,I]=await v.all([v.get(`/get-params-for-user/${k.id}/${g}/${h}/${u.NumberPage}`),v.get(`/vparams-value/${c.state.user.structure_id}/${h}/${g}`)]),C=Array.isArray(R.data)?R.data:[],ke=Array.isArray(I.data)?I.data:[];C.forEach((i,B)=>{const Q=ke.find(Y=>Y.TimeStr===i.GTName&&Y.ParametersID===i.ParametersID);Q&&(C[B]={...i,...Q})});const Se=C.map((i,B)=>({"â„–":B+1,Smena:i.Change,"Tartib raqami":i.OrderNumber,Parametrlar:K.value==="ru"?i.PNameRus:i.PName,"Boshlanish soati":i.STime,"Tugash soati":i.ETime,Min:i.Min,Max:i.Max,Qiymat:i.Value,Izoh:i.Comment})),Re=q.json_to_sheet(Se);q.book_append_sheet(e,Re,u.Name.substring(0,31))}catch(h){console.error(`Xatolik sahifa "${u.Name}" uchun:`,h)}const a=((l=n.value)==null?void 0:l.day)??"unknown",t=((r=n.value)==null?void 0:r.smena)??"X";ze(e,`Export-${a}-smena${t}.xlsx`)},W=A(()=>j("create"));A(()=>j("view"));const de=Z({id:"",Comment:"",Value:"",userId:c.state.user.id}),X=A(()=>[{headerName:d("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=w.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=w.value)==null?void 0:t[a.data.id])&&((l=w.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"}},{headerName:d("table.change"),field:"Change",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.parameters"),field:K.value==="ru"?"PNameRus":"PName",flex:1,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.graphictimes"),headerClass:"header-center",children:[{headerName:d("table.startingTime"),field:"STime",width:120,valueFormatter:a=>F(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.endingTime"),field:"ETime",width:120,valueFormatter:a=>F(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.interval"),headerClass:"header-center",children:[{headerName:d("table.min"),field:"Min",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.max"),field:"Max",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.value"),field:"Value",width:150,editable:a=>W.value&&a.data.WithFormula!=="1",suppressNavigable:!1,cellEditor:"agNumberCellEditor",cellEditorPopup:!1,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=w.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=w.value)==null?void 0:t[a.data.id])&&((l=w.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"},cellStyle:()=>({"font-size":"16px","text-align":"center"}),headerClass:"header-center"},{headerName:d("table.comment"),field:"Comment",flex:1,editable:()=>W.value,suppressNavigable:!1,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]);E(f,e=>{e.length>0&&(s.value=e[0].NumberPage)},{immediate:!0}),E(n,e=>{N(s.value)},{deep:!0});const ce=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(f.value.length):parseInt(s.value)<f.value.length?s.value=String(parseInt(s.value)+1):s.value="1")},me=e=>{(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight")&&(e.preventDefault(),document.activeElement.classList.contains("ag-cell")&&m.navigateToNextCell({key:e.key}))},fe=()=>{window.addEventListener("keydown",e=>{e.key===" "&&ve(e),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&me(e)})},ve=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(f.value.length):parseInt(s.value)<f.value.length?s.value=String(parseInt(s.value)+1):s.value="1")};function he(){const e=z.value;document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}const J=async()=>{try{const e=await v.get("/changes"),a=await v.get(`/pages-select/${k.id}`);f.value=a.data;const t=await v.get(`/paramWithId/${k.id}`);re.value=e.data.map(l=>({value:l.Change,text:l.Change})),oe.value=t.data.map(l=>({value:l.Pid,text:l.PName}))}catch(e){console.error("Error fetching graphics data:",e)}},ge={sortable:!0,filter:!0,resizable:!0},pe=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",ye={columnDefs:X.value,suppressScrollOnNewData:!0,getRowClass:pe,headerHeight:27,rowHeight:30,navigateToNextCell:e=>{const{key:a}=e.event;return a==="ArrowUp"||a==="ArrowDown"||a==="ArrowLeft"||a==="ArrowRight"?!0:e.previousCellDef}},we=e=>{},be=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},Ce=()=>{const e=be();return e>=Qe&&e<=Ye?1:2},Ne=()=>{se.push("/vparamsget")};ue.Change=Ce();async function N(e){try{const a=n.value.day,t=n.value.smena,[l,r]=await v.all([v.get(`/get-params-for-user/${k.id}/${t}/${a}/${e}`),v.get(`/vparams-value/${c.state.user.structure_id}/${a}/${t}`)]),u=Array.isArray(l.data)?l.data:[],h=Array.isArray(r.data)?r.data:[];u.forEach((g,R)=>{const I=h.find(C=>C.TimeStr==g.GTName&&C.ParametersID==g.ParametersID);I&&(u[R]={...g,...I})}),$.value=Array.isArray(u)?u:[]}catch(a){console.error("Error fetching data:",a),$.value=[]}}const Ve=async e=>{const{data:a,colDef:t,newValue:l,oldValue:r}=e;if(l!==r)try{await xe(a,s.value);const u=e.rowIndex,h=m.value.getDisplayedRowCount();if(m.value&&m.value.ensureIndexVisible(u,"bottom"),u<h-1){m.value.stopEditing();const g=t.field==="Value"?"Value":"Comment";m.value.setFocusedCell(u+1,g)}}catch(u){console.error("Error saving data",u)}},xe=async(e,a)=>{const t=n.value.smena,l=n.value.day;try{const r=await v.post("/vparams",{...e,userId:ne,change:t,daySelect:l});return Ie(),await N(a),r}catch(r){console.error("Error saving data",r)}},Ie=()=>{m.value&&m.value.clearFocusedCell()},Ee=()=>{S.value&&m.value&&(m.value.stopEditing(),S.value=!1)};let V=null,x=null,S=o(!1);const De=e=>{const{column:a}=e;if(a){const t=a.getColId();t==="Value"||t==="Comment"?(L(),S.value=!0,b.value&&clearTimeout(b.value),b.value=setTimeout(Ee,6e4)):M()}},Te=e=>{const{column:a}=e;if(a){const t=a.getColId();(t==="Value"||t==="Comment")&&(L(),S.value=!1,b.value&&(clearTimeout(b.value),b.value=null))}},M=()=>{V||(c.state.newValue=c.state.newValue||1,V=setInterval(()=>N(c.state.newValue),6e4)),x||(x=setInterval(J,6e4))},L=()=>{V&&(clearInterval(V),V=null),x&&(clearInterval(x),x=null)},Fe=e=>{console.log(e),m.value=e.api,e.api.addEventListener("cellFocused",De),e.api.addEventListener("cellBlurred",Te),M()};return E(s,e=>{N(e)}),$e(()=>{const e=new Date,a=e.getHours(),t=e.getMinutes();if(a>=8&&a<20||a===19&&t<=59)n.value.smena=1,n.value.day=F(e,"yyyy-MM-dd");else if(n.value.smena=2,a<8){const l=new Date(e);l.setDate(e.getDate()-1),n.value.day=F(l,"yyyy-MM-dd")}else n.value.day=F(e,"yyyy-MM-dd");N(s.value),J(),M(),fe()}),E(f,e=>{e.length>0&&(s.value=e[0].NumberPage)},{immediate:!0}),Me(()=>{L()}),(e,a)=>{const t=ee("VaTab"),l=ee("ag-grid-vue");return _(),ae("div",je,[a[5]||(a[5]=D("main",null,null,-1)),D("main",We,[D("div",Xe,[p(y(He),{modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=r=>n.value=r),"with-slot":!0},{default:T(()=>[p(y(Be),{modelValue:O.value,"onUpdate:modelValue":a[0]||(a[0]=r=>O.value=r),label:"Smena",readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),D("div",Je,[p(y(P),{onClick:ie,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"file_download"},{default:T(()=>a[3]||(a[3]=[G(" Export Excel ")])),_:1}),p(y(P),{onClick:e.printTable,icon:"print",class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10"},{default:T(()=>a[4]||(a[4]=[G("Pechat")])),_:1},8,["onClick"]),p(y(P),{onClick:he,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"fullscreen"}),p(y(P),{onClick:Ne,class:"btn btn-primary items-center justify-center mt-3 ml-3",icon:"grade"})])]),D("div",{ref_key:"gridContainer",ref:z,class:"ag-grid-container h-full"},[p(y(Oe),{modelValue:s.value,"onUpdate:modelValue":a[2]||(a[2]=r=>s.value=r),stateful:"",grow:"",onKeydown:ce,tabindex:"0"},{tabs:T(()=>[(_(!0),ae(Ge,null,qe(f.value,r=>(_(),te(t,{key:r.NumberPage,name:r.NumberPage},{default:T(()=>[G(Ke(r.Name),1)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),p(l,{rowData:$.value,columnDefs:X.value,defaultColDef:ge,gridOptions:ye,animateRows:"true",class:"ag-theme-material h-full",onGridReady:Fe,onCellValueChanged:Ve},null,8,["rowData","columnDefs"])],512),U.value?(_(),te(Ue,{key:0,showModalEdit:U.value,resultEdit:de,onUpdate:we},null,8,["showModalEdit","resultEdit"])):Le("",!0)])])}}};export{ra as default};
