import{a as Ae,b as _e,c as Pe,r as o,s as S,d as Y,K as Z,o as $e,L as Me,f as ee,g as ae,h as R,i as V,F as te,G as Le,j as p,l as E,k as y,m as Be,x as B,z as A,I as Ge,J as qe,t as Ke,M as Oe,n as f}from"./app-BM3QMFa0.js";/* empty css                   */import{_ as Ue}from"./EditValue-Da8X7EDD.js";import{u as G,w as ze}from"./xlsx-RWMVbf22.js";import{V as He}from"./VueShiftCalendar-Cdymcq4j.js";import{f as D}from"./format-D9pTN3Kd.js";const je={class:"grid grid-rows-[55px,1fr]"},We={class:"flex flex-col"},Xe={class:"m-2 flex pt-3"},Je={class:"flex justify-end"},Qe=8*60,Ye=19*60+59,ra={__name:"ParametrValueVertical",props:{id:Number},setup(le){const v=Ae(),T=le,se=_e(),{t:d,locale:q}=Pe(),_=o([]),c=o(null),b=o({}),re=o([]),n=o({smena:null,day:null}),K=S(()=>n.value.day?`${n.value.day} - ${n.value.smena}`:"");o(null);const O=o(null);o(null);const U=o(null);o(null);const w=o(null),ne=v.state.user.id;v.state.user.structure_id;const s=o("1");o([]);const oe=o([]),m=o([]),z=o({}),ue=Y({ParametersID:"",Change:"",Name:"",ShortName:"",Comment:"",GTime:"",Value:"",BlogsID:v.state.user.structure_id,SourceID:"",userId:v.state.user.id});Z(()=>v.state.user.roles,e=>{Array.isArray(e)&&e.length>14&&(z.value=e[14])},{immediate:!0});const H=e=>{var a,t;return((t=(a=z.value)==null?void 0:a.pivot)==null?void 0:t[e])==="1"},ie=async()=>{var l,r;if(!m.value.length)return;const e=G.book_new();for(const u of m.value)try{const h=n.value.day,g=n.value.smena,[k,I]=await f.all([f.get(`/get-params-for-user/${T.id}/${g}/${h}/${u.NumberPage}`),f.get(`/vparams-value/${v.state.user.structure_id}/${h}/${g}`)]),C=Array.isArray(k.data)?k.data:[],ke=Array.isArray(I.data)?I.data:[];C.forEach((i,L)=>{const J=ke.find(Q=>Q.TimeStr===i.GTName&&Q.ParametersID===i.ParametersID);J&&(C[L]={...i,...J})});const Se=C.map((i,L)=>({"â„–":L+1,Smena:i.Change,"Tartib raqami":i.OrderNumber,Parametrlar:q.value==="ru"?i.PNameRus:i.PName,"Boshlanish soati":i.STime,"Tugash soati":i.ETime,Min:i.Min,Max:i.Max,Qiymat:i.Value,Izoh:i.Comment})),Re=G.json_to_sheet(Se);G.book_append_sheet(e,Re,u.Name.substring(0,31))}catch(h){console.error(`Xatolik sahifa "${u.Name}" uchun:`,h)}const a=((l=n.value)==null?void 0:l.day)??"unknown",t=((r=n.value)==null?void 0:r.smena)??"X";ze(e,`Export-${a}-smena${t}.xlsx`)},j=S(()=>H("create"));S(()=>H("view"));const de=Y({id:"",Comment:"",Value:"",userId:v.state.user.id}),W=S(()=>[{headerName:d("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=b.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=b.value)==null?void 0:t[a.data.id])&&((l=b.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"}},{headerName:d("table.change"),field:"Change",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.parameters"),field:q.value==="ru"?"PNameRus":"PName",flex:1,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.graphictimes"),headerClass:"header-center",children:[{headerName:d("table.startingTime"),field:"STime",width:120,valueFormatter:a=>D(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.endingTime"),field:"ETime",width:120,valueFormatter:a=>D(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.interval"),headerClass:"header-center",children:[{headerName:d("table.min"),field:"Min",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.max"),field:"Max",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.value"),field:"Value",width:150,editable:a=>j.value&&a.data.WithFormula!=="1",suppressNavigable:!1,cellEditor:"agNumberCellEditor",cellEditorPopup:!1,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=b.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=b.value)==null?void 0:t[a.data.id])&&((l=b.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"},cellStyle:()=>({"font-size":"16px","text-align":"center"}),headerClass:"header-center"},{headerName:d("table.comment"),field:"Comment",flex:1,editable:()=>j.value,suppressNavigable:!1,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]),ce=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(m.value.length):parseInt(s.value)<m.value.length?s.value=String(parseInt(s.value)+1):s.value="1")},me=e=>{(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight")&&(e.preventDefault(),document.activeElement.classList.contains("ag-cell")&&c.navigateToNextCell({key:e.key}))},fe=()=>{window.addEventListener("keydown",e=>{e.key===" "&&ve(e),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&me(e)})},ve=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(m.value.length):parseInt(s.value)<m.value.length?s.value=String(parseInt(s.value)+1):s.value="1")};function he(){const e=U.value;document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}const X=async()=>{try{const e=await f.get("/changes"),a=await f.get(`/pages-select/${T.id}`);m.value=a.data;const t=await f.get(`/paramWithId/${T.id}`);re.value=e.data.map(l=>({value:l.Change,text:l.Change})),oe.value=t.data.map(l=>({value:l.Pid,text:l.PName}))}catch(e){console.error("Error fetching graphics data:",e)}},ge={sortable:!0,filter:!0,resizable:!0},pe=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",ye={columnDefs:W.value,suppressScrollOnNewData:!0,getRowClass:pe,headerHeight:27,rowHeight:30,navigateToNextCell:e=>{const{key:a}=e.event;return a==="ArrowUp"||a==="ArrowDown"||a==="ArrowLeft"||a==="ArrowRight"?!0:e.previousCellDef}},be=e=>{},we=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},Ce=()=>{const e=we();return e>=Qe&&e<=Ye?1:2},Ne=()=>{se.push("/vparamsget")};ue.Change=Ce();async function P(e){try{const a=n.value.day,t=n.value.smena,[l,r]=await f.all([f.get(`/get-params-for-user/${T.id}/${t}/${a}/${e}`),f.get(`/vparams-value/${v.state.user.structure_id}/${a}/${t}`)]),u=Array.isArray(l.data)?l.data:[],h=Array.isArray(r.data)?r.data:[];u.forEach((g,k)=>{const I=h.find(C=>C.TimeStr==g.GTName&&C.ParametersID==g.ParametersID);I&&(u[k]={...g,...I})}),_.value=Array.isArray(u)?u:[]}catch(a){console.error("Error fetching data:",a),_.value=[]}}Z([()=>n.value.day,()=>n.value.smena,()=>s.value],([e,a,t],[l,r,u])=>{e&&a&&t&&(e!==l||a!==r||t!==u)&&P(t)},{immediate:!0});const xe=async e=>{const{data:a,colDef:t,newValue:l,oldValue:r}=e;if(l!==r)try{await Ie(a,s.value);const u=e.rowIndex,h=c.value.getDisplayedRowCount();if(c.value&&c.value.ensureIndexVisible(u,"bottom"),u<h-1){c.value.stopEditing();const g=t.field==="Value"?"Value":"Comment";c.value.setFocusedCell(u+1,g)}}catch(u){console.error("Error saving data",u)}},Ie=async(e,a)=>{const t=n.value.smena,l=n.value.day;try{const r=await f.post("/vparams",{...e,userId:ne,change:t,daySelect:l});return Ve(),await P(a),r}catch(r){console.error("Error saving data",r)}},Ve=()=>{c.value&&c.value.clearFocusedCell()},Ee=()=>{F.value&&c.value&&(c.value.stopEditing(),F.value=!1)};let N=null,x=null,F=o(!1);const De=e=>{const{column:a}=e;if(a){const t=a.getColId();t==="Value"||t==="Comment"?(M(),F.value=!0,w.value&&clearTimeout(w.value),w.value=setTimeout(Ee,6e4)):$()}},Te=e=>{const{column:a}=e;if(a){const t=a.getColId();(t==="Value"||t==="Comment")&&(M(),F.value=!1,w.value&&(clearTimeout(w.value),w.value=null))}},$=()=>{N||(N=setInterval(()=>{s.value&&P(s.value)},6e4)),x||(x=setInterval(X,6e4))},M=()=>{N&&(clearInterval(N),N=null),x&&(clearInterval(x),x=null)},Fe=e=>{console.log(e),c.value=e.api,e.api.addEventListener("cellFocused",De),e.api.addEventListener("cellBlurred",Te),$()};return $e(()=>{const e=new Date,a=e.getHours(),t=e.getMinutes();if(a>=8&&a<20||a===19&&t<=59)n.value.smena=1,n.value.day=D(e,"yyyy-MM-dd");else if(n.value.smena=2,a<8){const l=new Date(e);l.setDate(e.getDate()-1),n.value.day=D(l,"yyyy-MM-dd")}else n.value.day=D(e,"yyyy-MM-dd");X().then(()=>{m.value.length>0&&(s.value=m.value[0].NumberPage)}),$(),fe()}),Me(()=>{M()}),(e,a)=>{const t=ee("VaTab"),l=ee("ag-grid-vue");return R(),ae("div",je,[a[5]||(a[5]=V("main",null,null,-1)),V("main",We,[V("div",Xe,[p(y(He),{modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=r=>n.value=r),"with-slot":!0},{default:E(()=>[p(y(Be),{modelValue:K.value,"onUpdate:modelValue":a[0]||(a[0]=r=>K.value=r),label:"Smena",readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),V("div",Je,[p(y(A),{onClick:ie,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"file_download"},{default:E(()=>a[3]||(a[3]=[B(" Export Excel ")])),_:1}),p(y(A),{onClick:e.printTable,icon:"print",class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10"},{default:E(()=>a[4]||(a[4]=[B("Pechat")])),_:1},8,["onClick"]),p(y(A),{onClick:he,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"fullscreen"}),p(y(A),{onClick:Ne,class:"btn btn-primary items-center justify-center mt-3 ml-3",icon:"grade"})])]),V("div",{ref_key:"gridContainer",ref:U,class:"ag-grid-container h-full"},[p(y(Oe),{modelValue:s.value,"onUpdate:modelValue":a[2]||(a[2]=r=>s.value=r),stateful:"",grow:"",onKeydown:ce,tabindex:"0"},{tabs:E(()=>[(R(!0),ae(Ge,null,qe(m.value,r=>(R(),te(t,{key:r.NumberPage,name:r.NumberPage},{default:E(()=>[B(Ke(r.Name),1)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),p(l,{rowData:_.value,columnDefs:W.value,defaultColDef:ge,gridOptions:ye,animateRows:"true",class:"ag-theme-material h-full",onGridReady:Fe,onCellValueChanged:xe},null,8,["rowData","columnDefs"])],512),O.value?(R(),te(Ue,{key:0,showModalEdit:O.value,resultEdit:de,onUpdate:be},null,8,["showModalEdit","resultEdit"])):Le("",!0)])])}}};export{ra as default};
