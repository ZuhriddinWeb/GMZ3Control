import{u as Oe,r as S,L as ee,o as Ve,g as me,h as ge,i as Z,j as G,G as Be,aj as Ee,k as U,m as Le,l as ye,x as he,z as be,t as Re,ak as ze,n as B}from"./app-Cp5kX0cG.js";import{j as Te}from"./jsuites-BrM-0xoV.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const He={class:"p-3 pt-28"},Ze={class:"flex items-center gap-3 mb-3"},Ge={class:"flex items-center gap-2 mb-2"},Ue={key:0,class:"text-gray-500 text-sm"},L=303,Je={__name:"GMZ3Report",setup(je){const{init:C}=Oe(),j=S(null),v=S(new Date);let g=null;const k=S([]),K=S(new Map),te=S(new Map),re=S(new Map),I=S(new Map),q=S(new Map),W=S({});let N=!1;const $=S(new Map);let Y=!1;const D=S(null),E=S(""),M=S([]),oe=t=>{const e=new Date(t);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};function we(){const t=new Map,e=new Map;for(const n of M.value||[]){const r=String(n.ParameterID||n.parameter_id||n.id||"").toUpperCase(),o=String(n.PName||n.Name||"").trim();!r||!o||(t.set(r,o),e.set(o.toLowerCase(),r))}te.value=t,re.value=e}function Se(t){return String(t||"").replace(/P\(\s*([0-9A-F-]{8,})\s*(,\s*"(.*?)")?\s*\)/gi,(e,n,r,o)=>`P("${te.value.get(String(n).toUpperCase())||n}"${o?`,"${o}"`:""})`)}function ne(t){return String(t||"").replace(/P\(\s*"(.*?)"\s*(,\s*"(.*?)")?\s*\)/gi,(e,n,r,o)=>{const s=re.value.get(String(n).trim().toLowerCase());return s?`P(${s}${o?`,"${o}"`:""})`:`P("${n}"${o?`,"${o}"`:""})`})}ee(M,we,{immediate:!0});async function ae(){const t=D.value,e=(E.value||"").trim();if(!t||!e.startsWith("=")){C({message:'Formula "=" bilan boshlanishi kerak',color:"warning"});return}try{const n=ne(e);await pe(t,n),await new Promise(r=>requestAnimationFrame(r)),await T(t,{toast:!0}),C({message:"Formula yangilandi",color:"success"})}catch(n){console.error(n),C({message:"Formula saqlanmadi",color:"danger"})}}async function ve(){try{const{data:t}=await B.get(`/static-with-numberpage/${L}`,{params:{date:X(v.value)}});M.value=Array.isArray(t)?t:t.items||[]}catch(t){console.error(t),C({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function xe(){const t=new Map;for(const[e,n]of $.value.entries())(n==null?void 0:n.parameterId)!=null&&t.set(String(n.parameterId),Number(e));K.value=t}function Ie(t){const e=new Date(t),n=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear();return`${n}.${r}.${o}`}function A(t){let e="",n=t;for(;n>=0;)e=String.fromCharCode(n%26+65)+e,n=Math.floor(n/26)-1;return e}function se(t){const e=t.match(/^([A-Z]+)(\d+)$/),n=+e[2]-1;let r=0;for(const o of e[1])r=r*26+(o.charCodeAt(0)-64);return{x:r-1,y:n}}function J(t){const[e,n]=t.split(":"),r=se(e),o=se(n);return{row:Math.min(r.y,o.y),col:Math.min(r.x,o.x),rowspan:Math.abs(r.y-o.y)+1,colspan:Math.abs(r.x-o.x)+1}}async function $e(){try{const{data:t}=await B.get("/periodType");k.value=Array.isArray(t)?t:t.items||[]}catch(t){console.error(t),C({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function le(t,e){const n=new Date(e),r=n.getFullYear(),o=n.getMonth(),s=n.getDate(),d=l=>`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,m=t.trim().toLowerCase();if(m==="kun"){const l=new Date(r,o,s);return{start:d(l),end:d(l)}}if(m==="hafta"){const l=(n.getDay()+6)%7,p=new Date(r,o,s-l),b=new Date(p);return b.setDate(p.getDate()+6),{start:d(p),end:d(b)}}if(m==="oy"){const l=new Date(r,o,1),p=new Date(r,o+1,0);return{start:d(l),end:d(p)}}if(m==="kvartal"){const l=Math.floor(o/3),p=new Date(r,l*3,1),b=new Date(r,l*3+3,0);return{start:d(p),end:d(b)}}if(m==="yil"){const l=new Date(r,0,1),p=new Date(r,12,0);return{start:d(l),end:d(p)}}const a=new Date(r,o,s);return{start:d(a),end:d(a)}}function _e(){const e=(Array.isArray(k.value)?k.value:[]).map(o=>({id:Number(o.id),name:String(o.name||"").trim(),order:Number(o.OrderNumber??o.orderNumber??o.order_number??o.order??9999)}));e.sort((o,s)=>o.order-s.order||o.id-s.id);const n=new Set,r=[];for(const o of e){const s=o.name.toLowerCase();!s||n.has(s)||(n.add(s),r.push({id:o.id,label:o.name}))}return r}function Ae(t){const e=I.value.get(Number(t));return e?e.id:null}async function R(){Y=!0,$.value.clear(),$.value=new Map;const t=ke(M.value),e=t.reduce((u,f)=>u+f.groups.reduce((h,w)=>h+w.params.length,0),0),n=t.reduce((u,f)=>u+f.groups.filter(h=>!!h.gName).length,0),r=t.length*2,o=7+e+n+r+5,s=150,d=Math.max(o,300),m=Array.from({length:d},()=>Array(s).fill(""));g&&(g.destroy(),g=null),g=Te(j.value,{data:m,columns:Array.from({length:s},(u,f)=>({title:A(f),width:f===0?520:f===1?120:110})),minDimensions:[s,d],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[J("A1:F1"),J("A2:F2"),J("B4:B5")],onselection:(u,f,h,w,_)=>{if(f!==w||h!==_)return;const F=`${A(f)}${h+1}`;D.value=F;const O=W.value[F]||"";E.value=Se(O)},onchange:async(u,f,h,w,_)=>{if(N||Y)return;const F=Number(w)+1,O=Number(h),x=`${A(O)}${F}`;if(!(!$.value.get(F)||!Ae(O)))try{typeof _=="string"&&_.trim().startsWith("=")?(await pe(x,_.trim()),await new Promise(Q=>requestAnimationFrame(Q)),await T(x,{toast:!0}),D.value===x&&(E.value=_.trim())):await T(x,{toast:!0})}catch(Q){console.error(Q),C({message:"Saqlashda xatolik",color:"danger"})}}}),g.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),g.setValue("A2",`${Ie(v.value)} y.`),g.setValue("A3","—"),g.setValue("A4","Ko'rsatgichlar nomi."),g.setValue("B4","o'lchov birligi");const a=_e();I.value.clear(),q.value.clear();let l=2;const p={},b={};for(const u of a){const f=A(l);g.setValue(`${f}4`,u.label),g.setValue(`${f}5`,""),p[`${f}4`]="background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",b[`${f}5`]="background:#fff;border:0;text-align:center;",I.value.set(l,{id:u.id,label:u.label}),q.value.set(u.id,l),l+=1}g.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"}),g.setStyle(p),g.setStyle(b);const i={};["A","B","C","D","E","F"].forEach(u=>i[`${u}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(u=>i[`${u}5`]="border:1px solid #bdbdbd;"),g.setStyle(i);function c(u,f){try{typeof g.setMerge=="function"&&g.setMerge(`A${u}`,10,1)}catch{}const h={};for(let w=0;w<=9;w++)h[`${A(w)}${u}`]=f;g.setStyle(h)}let y=7;for(const u of t){g.setValue(`A${y}`,u.fsName),c(y,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),g.setHeight(y-1,28),y++;for(const f of u.groups){f.gName&&(g.setValue(`A${y}`,f.gName),Fe(y,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),g.setHeight(y-1,26),y++);for(const h of f.params){$.value.set(y,{fsId:h.fsId,groupId:h.groupId,parameterId:h.parameterId}),$.value.set(y,{fsId:h.fsId,groupId:h.groupId,parameterId:h.parameterId}),g.setValue(`A${y}`,h.name),g.setValue(`B${y}`,h.unit);const w={};w[`A${y}`]="border:1px solid #dddddd;padding-left:6px;",w[`B${y}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(_=>{w[`${_}${y}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),g.setStyle(w),g.setHeight(y-1,24),y++}xe()}y++}g.setHeight(0,34),g.setHeight(1,28),g.setHeight(3,28),g.setHeight(4,24),await Ce(),await qe(),await new Promise(u=>requestAnimationFrame(u)),Me([1,2,4,5]),Y=!1}async function Ne(t,e,n){const{data:r}=await B.get("/sheet/value",{params:{numberPage:t,cell:e,date:oe(n)}});return Number((r==null?void 0:r.value)??0)}function X(t){const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function P(t){let e=0;for(const n of t)e=e*26+(n.charCodeAt(0)-64);return e-1}function ie(t){return String(t||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim()}function ce(t,e=null){if(t==null||String(t).trim()==="")return e;const r=String(t).trim().split("_")[0];if(/^\d+$/.test(r))return Number(r);const o=ie(r),d=(Array.isArray(k.value)?k.value:[]).find(m=>ie(m.name)===o);return d?Number(d.id):e}async function Ce(){const t=M.value||[];if(!t.length)return;const e=N;N=!0;const n=new Map;for(const[o,s]of I.value.entries())n.set(s.id,le(s.label,v.value));const r=new Map;for(const[o,s]of $.value.entries())s!=null&&s.parameterId&&r.set(String(s.parameterId),o);for(const o of t){const s=String(o.ParameterID||o.parameter_id||""),d=r.get(s);if(!d)continue;const m=Number(o.period_type_id),a=q.value.get(m);if(a==null)continue;const l=n.get(m),p=String(o.period_start_date||""),b=String(o.period_end_date||p||"");if(l&&p===l.start&&b===l.end){const i=A(a);g.setValue(`${i}${d}`,o.value)}}N=e}function ke(t){const e=a=>{const l=String(a??"").trim().toLowerCase();if(l===""||l==="null"||l==="undefined")return null;const p=Number(l);return Number.isFinite(p)?p:null};let n=0;const r=new Map,o=new Set;for(const a of t||[]){const l=n++,p=(a==null?void 0:a.FactoryStructureID)??null,b=(a==null?void 0:a.FSName)||(p!=null?`Struktura #${p}`:"Struktura"),i=e(a==null?void 0:a.OrderNumberSex);let c=(a==null?void 0:a.GroupID)??null;const y=a==null?void 0:a.GName,u=!!String(y??"").trim();c!=null&&!u&&(c=null);const f=u?y:null,h=e(a==null?void 0:a.OrderNumberGroup),w=(a==null?void 0:a.ParameterID)??(a==null?void 0:a.id)??(a==null?void 0:a.Uuid);if(w&&o.has(`${p}:${c}:${w}`))continue;w&&o.add(`${p}:${c}:${w}`);const _=(a==null?void 0:a.PName)||(a==null?void 0:a.Name)||`Param ${w}`,F=(a==null?void 0:a.UName)||"",O=e(a==null?void 0:a.OrderNumber);r.has(p)||r.set(p,{fsId:p,fsName:b,fsOrder:i,seq:l,groups:new Map});const x=r.get(p);x.fsOrder==null&&i!=null&&(x.fsOrder=i),x.seq=Math.min(x.seq,l);const H=c==null?"zzz_nogroup":`g_${c}`;x.groups.has(H)||x.groups.set(H,{groupId:c,gName:f,gOrder:h,seq:l,params:[]});const V=x.groups.get(H);V.gOrder==null&&h!=null&&(V.gOrder=h),V.seq=Math.min(V.seq,l),V.params.push({name:_,unit:F,fsId:p,groupId:c,parameterId:w,pOrder:O,seq:l})}let s=Array.from(r.values());const d=s.filter(a=>a.fsOrder!=null).sort((a,l)=>a.fsOrder-l.fsOrder||a.seq-l.seq),m=s.filter(a=>a.fsOrder==null).sort((a,l)=>a.seq-l.seq);return s=[...d,...m],s.forEach(a=>{const l=Array.from(a.groups.values()),p=l.filter(c=>c.groupId!=null&&c.gOrder!=null).sort((c,y)=>c.gOrder-y.gOrder||c.seq-y.seq),b=l.filter(c=>c.groupId!=null&&c.gOrder==null).sort((c,y)=>c.seq-y.seq),i=l.filter(c=>c.groupId==null).sort((c,y)=>c.seq-y.seq);a.groups=[...p,...b,...i],a.groups.forEach(c=>{const y=c.params.filter(f=>f.pOrder!=null).sort((f,h)=>f.pOrder-h.pOrder||f.seq-h.seq),u=c.params.filter(f=>f.pOrder==null).sort((f,h)=>f.seq-h.seq);c.params=[...y,...u]})}),s}function Fe(t,e){for(let r=1;r<=9;r++)g.setValueFromCoords(r,t-1,"");const n={};for(let r=0;r<=9;r++)n[`${A(r)}${t}`]=e;g.setStyle(n)}async function ue(t,e,{currentCell:n}={}){var p;let r=String(t).trim(),o=null;if(n){const b=P(String(((p=n.match(/^[A-Z]+/))==null?void 0:p[0])||"")),i=I.value.get(b);i&&(o=i.id)}r=r.replace(/P\(\s*([0-9A-F-]{8,})\s*(?:,\s*"(.*?)")?\s*\)/gi,(b,i,c)=>{const y=K.value.get(String(i).toUpperCase()),u=ce(c,o),f=q.value.get(u),h=f!=null?A(f):null;return y&&h?`${h}${y}`:"0"});const s=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,d=/'?(\d+)'?\!([A-Z]+\d+)/g,m=[];r.replace(s,(b,i,c)=>{m.push({page:+i,cell:c})}),r.replace(d,(b,i,c)=>{m.push({page:+i,cell:c})});const a=m.length?await Promise.all(m.map(b=>Ne(b.page,b.cell,e))):[];let l=0;return r=r.replace(s,()=>String(Number.isFinite(a[l])?a[l++]:0)),r=r.replace(d,()=>String(Number.isFinite(a[l])?a[l++]:0)),r.startsWith("=")||(r="="+r),r}function de(t){return String(t||"").replace(/\b([A-Z]+)(\d+)\b/g,(e,n,r)=>{const o=Number(r),s=$.value.get(o);if(!(s!=null&&s.parameterId))return e;const d=P(n),m=I.value.get(d);return m?`P(${s.parameterId},"${m.label}")`:e})}async function pe(t,e){var p,b;const n=Number(((p=t.match(/\d+/))==null?void 0:p[0])||0),r=String(((b=t.match(/^[A-Z]+/))==null?void 0:b[0])||""),o=$.value.get(n);if(!(o!=null&&o.parameterId))return;const s=P(r),d=I.value.get(s);if(!d)return;let m=ne(e);m=fe(m,{currentCell:t});const a=de(m);W.value[t]=a,await B.post("/sheet/formula",{numberPage:L,number_page:L,param_id:o.parameterId,period_type_id:d.id,period_label:d.label,cell:t,expr:a,expr_stable:a,expr_raw:e,scope:"permanent",date:X(v.value),for_date:null});const l=await ue(a,v.value,{currentCell:t});N=!0,g.setValue(t,l),N=!1,await new Promise(i=>requestAnimationFrame(i)),g.setStyle({[t]:"border:1px dashed #444;font-weight:600;"})}async function qe(){const{data:t}=await B.get("/sheet/formula",{params:{numberPage:L,date:oe(v.value)}}),e=(t==null?void 0:t.items)||t||[];for(const n of e){let r=null,o=null;if(n.param_id&&n.period_type_id!=null&&(r=K.value.get(String(n.param_id)),o=q.value.get(Number(n.period_type_id))),(r==null||o==null)&&n.cell){const l=String(n.cell).match(/^([A-Z]+)(\d+)$/);l&&(o=P(l[1]),r=Number(l[2]))}if(!r||o==null)continue;const s=`${A(o)}${r}`,d=n.expr_stable||n.expr||"",m=fe(d,{currentCell:s}),a=de(m);W.value[s]=a;try{const l=await ue(a,v.value,{currentCell:s});N=!0,g.setValue(s,l),N=!1,g.setStyle({[s]:"border:1px dashed #444;font-weight:600;"}),await T(s)}catch(l){console.error("Formula error",s,a,l)}}}function De(t,{currentCell:e}={}){var o,s;let n=null;if(e){const d=String(((o=e.match(/^[A-Z]+/))==null?void 0:o[0])||""),m=P(d),a=I.value.get(m);a&&(n=a.id)}const r=ce(t,n);if(r!=null){const d=q.value.get(r);if(d!=null)return((s=I.value.get(d))==null?void 0:s.label)||"";const m=(k.value||[]).find(a=>Number(a.id)===Number(r));return((m==null?void 0:m.name)||"").trim()}return""}function fe(t,{currentCell:e}={}){return String(t||"").replace(/P\(\s*([0-9A-F-]{8,})\s*(?:,\s*"(.*?)")?\s*\)/gi,(n,r,o)=>{const s=De(o,{currentCell:e});return s?`P(${r},"${s}")`:`P(${r})`})}let z=null;function Me(t=[1,2,4,5]){var b;z&&(z(),z=null);const e=(b=j.value)==null?void 0:b.querySelector(".jexcel_content"),n=e==null?void 0:e.querySelector("tbody");if(!e||!n)return;const r=1e3,o=[],s=e.querySelector("thead tr")||e.querySelector(".jexcel_headers tr")||e.querySelector(".jexcel_headers"),d=s?Array.from(s.children):[],m=s&&(s.getBoundingClientRect().height||s.offsetHeight)||28;s&&d.forEach(i=>{const c={position:i.style.position,top:i.style.top,z:i.style.zIndex,bg:i.style.backgroundColor,boxShadow:i.style.boxShadow};o.push(()=>{i.style.position=c.position,i.style.top=c.top,i.style.zIndex=c.z,i.style.backgroundColor=c.bg,i.style.boxShadow=c.boxShadow}),i.style.position="sticky",i.style.top="0px",i.style.zIndex=String(r+t.length+1),i.style.backgroundColor="#eaf2fb",i.style.boxShadow="0 1px 0 rgba(0,0,0,.08)"});let a=m;const l=t.map(i=>n.children[i-1]).filter(Boolean);l.forEach((i,c)=>{const y=i.getBoundingClientRect().height||i.offsetHeight;Array.from(i.children).forEach(u=>{const f={position:u.style.position,top:u.style.top,z:u.style.zIndex,bg:u.style.backgroundColor,boxShadow:u.style.boxShadow};o.push(()=>{u.style.position=f.position,u.style.top=f.top,u.style.zIndex=f.z,u.style.backgroundColor=f.bg,u.style.boxShadow=f.boxShadow}),u.style.position="sticky",u.style.top=`${a}px`,u.style.zIndex=String(r+c),u.style.backgroundColor="#eef7ff",u.style.boxShadow="0 1px 0 rgba(0,0,0,.08)"}),a+=y});const p=()=>{const i=e.scrollTop>0;[...d,...l.flatMap(c=>Array.from(c.children))].forEach(c=>{c.style.boxShadow=i?"0 2px 4px rgba(0,0,0,.06)":"0 1px 0 rgba(0,0,0,.08)"})};e.addEventListener("scroll",p),z=()=>{e.removeEventListener("scroll",p),o.forEach(i=>i())}}async function T(t,{toast:e=!1}={}){const n=t.match(/^([A-Z]+)(\d+)$/);if(!n)return;const r=n[1],o=Number(n[2]),s=P(r),d=o-1,m=$.value.get(o);if(!m)return;const a=I.value.get(s);if(!a)return;let l=g.getValueFromCoords(s,d,!1);(l==null||l==="")&&(l=g.getValueFromCoords(s,d,!0));const p=Pe(l);if(!Number.isFinite(p))return;const{start:b,end:i}=le(a.label,v.value);await B.post("/static-params/upsert",{number_page:L,factory_structure_id:m.fsId,parameter_id:m.parameterId,group_id:m.groupId,period_type_id:a.id,period_start_date:b,period_end_date:i,value:p,comment:null,for_date:X(v.value)}),e&&C({message:"Maʼlumot saqlandi",color:"success"})}function Pe(t){if(typeof t=="number")return t;if(t==null)return null;let e=String(t).trim().replace(/\u00A0/g,"");const n=e.lastIndexOf("."),r=e.lastIndexOf(","),o=Math.max(n,r)===-1?"":n>r?".":",";e=e.replace(/\s+/g,""),o===","&&(e=e.replace(/\./g,"")),o==="."&&(e=e.replace(/,/g,"")),o&&(e=e.replace(o,"."));const s=Number(e);return Number.isFinite(s)?s:null}return Ve(async()=>{await Promise.all([ve(),$e()]),R()}),ee(v,R),ee([M,k],R),(t,e)=>(ge(),me("div",He,[Z("div",Ze,[Z("div",Ge,[G(U(Le),{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=n=>E.value=n),class:"max-w-[700px] w-full",placeholder:"",onKeyup:Ee(ae,["enter"])},null,8,["modelValue"]),G(U(be),{size:"small",onClick:ae,disabled:!D.value},{default:ye(()=>e[3]||(e[3]=[he(" Formula’ni saqla ",-1)])),_:1,__:[3]},8,["disabled"]),D.value?(ge(),me("span",Ue,"Katak: "+Re(D.value),1)):Be("",!0)]),G(U(be),{preset:"secondary",onClick:e[1]||(e[1]=n=>t.$router.back())},{default:ye(()=>e[4]||(e[4]=[he("← Orqaga",-1)])),_:1,__:[4]}),G(U(ze),{modelValue:v.value,"onUpdate:modelValue":[e[2]||(e[2]=n=>v.value=n),R],teleport:!0,"teleport-target":"body",placement:"bottom-start",offset:[0,8]},null,8,["modelValue"]),e[5]||(e[5]=Z("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),Z("div",{ref_key:"sheetEl",ref:j,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{Je as default};
