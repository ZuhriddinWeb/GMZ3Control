import{u as Fe,r as S,L as ee,o as Oe,g as ue,h as de,i as Z,j as G,G as Pe,aj as Ve,k as U,m as Be,l as pe,x as fe,z as me,t as Ee,ak as Le,n as P}from"./app-A8jI9ma8.js";import{j as Re}from"./jsuites-SNr_sQO5.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const ze={class:"p-3 pt-28"},Te={class:"flex items-center gap-3 mb-3"},He={class:"flex items-center gap-2 mb-2"},Ze={key:0,class:"text-gray-500 text-sm"},L=303,We={__name:"GMZ3Report",setup(Ge){const{init:C}=Fe(),j=S(null),v=S(new Date);let g=null;const q=S([]),K=S(new Map),te=S(new Map),re=S(new Map),A=S(new Map),V=S(new Map),W=S({});let N=!1;const I=S(new Map);let Y=!1;const D=S(null),B=S(""),M=S([]),oe=t=>{const e=new Date(t);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};function ge(){const t=new Map,e=new Map;for(const a of M.value||[]){const r=String(a.ParameterID||a.parameter_id||a.id||"").toUpperCase(),o=String(a.PName||a.Name||"").trim();!r||!o||(t.set(r,o),e.set(o.toLowerCase(),r))}te.value=t,re.value=e}function ye(t){return String(t||"").replace(/P\(\s*([0-9A-F-]{8,})\s*(,\s*"(.*?)")?\s*\)/gi,(e,a,r,o)=>`P("${te.value.get(String(a).toUpperCase())||a}"${o?`,"${o}"`:""})`)}function he(t){return String(t||"").replace(/P\(\s*"(.*?)"\s*(,\s*"(.*?)")?\s*\)/gi,(e,a,r,o)=>{const s=re.value.get(String(a).trim().toLowerCase());return s?`P(${s}${o?`,"${o}"`:""})`:`P("${a}"${o?`,"${o}"`:""})`})}ee(M,ge,{immediate:!0});async function ae(){const t=D.value,e=(B.value||"").trim();if(!t||!e.startsWith("=")){C({message:'Formula "=" bilan boshlanishi kerak',color:"warning"});return}try{const a=he(e);await ce(t,a),await new Promise(r=>requestAnimationFrame(r)),await T(t,{toast:!0}),C({message:"Formula yangilandi",color:"success"})}catch(a){console.error(a),C({message:"Formula saqlanmadi",color:"danger"})}}async function be(){try{const{data:t}=await P.get(`/static-with-numberpage/${L}`,{params:{date:X(v.value)}});M.value=Array.isArray(t)?t:t.items||[]}catch(t){console.error(t),C({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function we(){const t=new Map;for(const[e,a]of I.value.entries())(a==null?void 0:a.parameterId)!=null&&t.set(String(a.parameterId),Number(e));K.value=t}function Se(t){const e=new Date(t),a=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear();return`${a}.${r}.${o}`}function _(t){let e="",a=t;for(;a>=0;)e=String.fromCharCode(a%26+65)+e,a=Math.floor(a/26)-1;return e}function ne(t){const e=t.match(/^([A-Z]+)(\d+)$/),a=+e[2]-1;let r=0;for(const o of e[1])r=r*26+(o.charCodeAt(0)-64);return{x:r-1,y:a}}function J(t){const[e,a]=t.split(":"),r=ne(e),o=ne(a);return{row:Math.min(r.y,o.y),col:Math.min(r.x,o.x),rowspan:Math.abs(r.y-o.y)+1,colspan:Math.abs(r.x-o.x)+1}}async function ve(){try{const{data:t}=await P.get("/periodType");q.value=Array.isArray(t)?t:t.items||[]}catch(t){console.error(t),C({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function se(t,e){const a=new Date(e),r=a.getFullYear(),o=a.getMonth(),s=a.getDate(),p=l=>`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,m=t.trim().toLowerCase();if(m==="kun"){const l=new Date(r,o,s);return{start:p(l),end:p(l)}}if(m==="hafta"){const l=(a.getDay()+6)%7,i=new Date(r,o,s-l),b=new Date(i);return b.setDate(i.getDate()+6),{start:p(i),end:p(b)}}if(m==="oy"){const l=new Date(r,o,1),i=new Date(r,o+1,0);return{start:p(l),end:p(i)}}if(m==="kvartal"){const l=Math.floor(o/3),i=new Date(r,l*3,1),b=new Date(r,l*3+3,0);return{start:p(i),end:p(b)}}if(m==="yil"){const l=new Date(r,0,1),i=new Date(r,12,0);return{start:p(l),end:p(i)}}const n=new Date(r,o,s);return{start:p(n),end:p(n)}}function xe(){const e=(Array.isArray(q.value)?q.value:[]).map(o=>({id:Number(o.id),name:String(o.name||"").trim(),order:Number(o.OrderNumber??o.orderNumber??o.order_number??o.order??9999)}));e.sort((o,s)=>o.order-s.order||o.id-s.id);const a=new Set,r=[];for(const o of e){const s=o.name.toLowerCase();!s||a.has(s)||(a.add(s),r.push({id:o.id,label:o.name}))}return r}function Ie(t){const e=A.value.get(Number(t));return e?e.id:null}async function R(){Y=!0,I.value.clear(),I.value=new Map;const t=Ne(M.value),e=t.reduce((u,f)=>u+f.groups.reduce((h,w)=>h+w.params.length,0),0),a=t.reduce((u,f)=>u+f.groups.filter(h=>!!h.gName).length,0),r=t.length*2,o=7+e+a+r+5,s=150,p=Math.max(o,300),m=Array.from({length:p},()=>Array(s).fill(""));g&&(g.destroy(),g=null),g=Re(j.value,{data:m,columns:Array.from({length:s},(u,f)=>({title:_(f),width:f===0?520:f===1?120:110})),minDimensions:[s,p],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[J("A1:F1"),J("A2:F2"),J("B4:B5")],onselection:(u,f,h,w,$)=>{if(f!==w||h!==$)return;const k=`${_(f)}${h+1}`;D.value=k;const F=W.value[k]||"";B.value=ye(F)},onchange:async(u,f,h,w,$)=>{if(N||Y)return;const k=Number(w)+1,F=Number(h),x=`${_(F)}${k}`;if(!(!I.value.get(k)||!Ie(F)))try{typeof $=="string"&&$.trim().startsWith("=")?(await ce(x,$.trim()),await new Promise(Q=>requestAnimationFrame(Q)),await T(x,{toast:!0}),D.value===x&&(B.value=$.trim())):await T(x,{toast:!0})}catch(Q){console.error(Q),C({message:"Saqlashda xatolik",color:"danger"})}}}),g.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),g.setValue("A2",`${Se(v.value)} y.`),g.setValue("A3","—"),g.setValue("A4","Ko'rsatgichlar nomi."),g.setValue("B4","o'lchov birligi");const n=xe();A.value.clear(),V.value.clear();let l=2;const i={},b={};for(const u of n){const f=_(l);g.setValue(`${f}4`,u.label),g.setValue(`${f}5`,""),i[`${f}4`]="background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",b[`${f}5`]="background:#fff;border:0;text-align:center;",A.value.set(l,{id:u.id,label:u.label}),V.value.set(u.id,l),l+=1}g.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"}),g.setStyle(i),g.setStyle(b);const c={};["A","B","C","D","E","F"].forEach(u=>c[`${u}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(u=>c[`${u}5`]="border:1px solid #bdbdbd;"),g.setStyle(c);function d(u,f){try{typeof g.setMerge=="function"&&g.setMerge(`A${u}`,10,1)}catch{}const h={};for(let w=0;w<=9;w++)h[`${_(w)}${u}`]=f;g.setStyle(h)}let y=7;for(const u of t){g.setValue(`A${y}`,u.fsName),d(y,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),g.setHeight(y-1,28),y++;for(const f of u.groups){f.gName&&(g.setValue(`A${y}`,f.gName),Ce(y,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),g.setHeight(y-1,26),y++);for(const h of f.params){I.value.set(y,{fsId:h.fsId,groupId:h.groupId,parameterId:h.parameterId}),I.value.set(y,{fsId:h.fsId,groupId:h.groupId,parameterId:h.parameterId}),g.setValue(`A${y}`,h.name),g.setValue(`B${y}`,h.unit);const w={};w[`A${y}`]="border:1px solid #dddddd;padding-left:6px;",w[`B${y}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach($=>{w[`${$}${y}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),g.setStyle(w),g.setHeight(y-1,24),y++}we()}y++}g.setHeight(0,34),g.setHeight(1,28),g.setHeight(3,28),g.setHeight(4,24),await Ae(),await qe(),await new Promise(u=>requestAnimationFrame(u)),De([1,2,4,5]),Y=!1}async function $e(t,e,a){const{data:r}=await P.get("/sheet/value",{params:{numberPage:t,cell:e,date:oe(a)}});return Number((r==null?void 0:r.value)??0)}function X(t){const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function E(t){let e=0;for(const a of t)e=e*26+(a.charCodeAt(0)-64);return e-1}function le(t){return String(t||"").toLowerCase().replace(/[^\p{L}\p{N}]+/gu,"").trim()}function _e(t,e=null){if(t==null||String(t).trim()==="")return e;const r=String(t).trim().split("_")[0];if(/^\d+$/.test(r))return Number(r);const o=le(r),p=(Array.isArray(q.value)?q.value:[]).find(m=>le(m.name)===o);return p?Number(p.id):e}async function Ae(){const t=M.value||[];if(!t.length)return;const e=N;N=!0;const a=new Map;for(const[o,s]of A.value.entries())a.set(s.id,se(s.label,v.value));const r=new Map;for(const[o,s]of I.value.entries())s!=null&&s.parameterId&&r.set(String(s.parameterId),o);for(const o of t){const s=String(o.ParameterID||o.parameter_id||""),p=r.get(s);if(!p)continue;const m=Number(o.period_type_id),n=V.value.get(m);if(n==null)continue;const l=a.get(m),i=String(o.period_start_date||""),b=String(o.period_end_date||i||"");if(l&&i===l.start&&b===l.end){const c=_(n);g.setValue(`${c}${p}`,o.value)}}N=e}function Ne(t){const e=n=>{const l=String(n??"").trim().toLowerCase();if(l===""||l==="null"||l==="undefined")return null;const i=Number(l);return Number.isFinite(i)?i:null};let a=0;const r=new Map,o=new Set;for(const n of t||[]){const l=a++,i=(n==null?void 0:n.FactoryStructureID)??null,b=(n==null?void 0:n.FSName)||(i!=null?`Struktura #${i}`:"Struktura"),c=e(n==null?void 0:n.OrderNumberSex);let d=(n==null?void 0:n.GroupID)??null;const y=n==null?void 0:n.GName,u=!!String(y??"").trim();d!=null&&!u&&(d=null);const f=u?y:null,h=e(n==null?void 0:n.OrderNumberGroup),w=(n==null?void 0:n.ParameterID)??(n==null?void 0:n.id)??(n==null?void 0:n.Uuid);if(w&&o.has(`${i}:${d}:${w}`))continue;w&&o.add(`${i}:${d}:${w}`);const $=(n==null?void 0:n.PName)||(n==null?void 0:n.Name)||`Param ${w}`,k=(n==null?void 0:n.UName)||"",F=e(n==null?void 0:n.OrderNumber);r.has(i)||r.set(i,{fsId:i,fsName:b,fsOrder:c,seq:l,groups:new Map});const x=r.get(i);x.fsOrder==null&&c!=null&&(x.fsOrder=c),x.seq=Math.min(x.seq,l);const H=d==null?"zzz_nogroup":`g_${d}`;x.groups.has(H)||x.groups.set(H,{groupId:d,gName:f,gOrder:h,seq:l,params:[]});const O=x.groups.get(H);O.gOrder==null&&h!=null&&(O.gOrder=h),O.seq=Math.min(O.seq,l),O.params.push({name:$,unit:k,fsId:i,groupId:d,parameterId:w,pOrder:F,seq:l})}let s=Array.from(r.values());const p=s.filter(n=>n.fsOrder!=null).sort((n,l)=>n.fsOrder-l.fsOrder||n.seq-l.seq),m=s.filter(n=>n.fsOrder==null).sort((n,l)=>n.seq-l.seq);return s=[...p,...m],s.forEach(n=>{const l=Array.from(n.groups.values()),i=l.filter(d=>d.groupId!=null&&d.gOrder!=null).sort((d,y)=>d.gOrder-y.gOrder||d.seq-y.seq),b=l.filter(d=>d.groupId!=null&&d.gOrder==null).sort((d,y)=>d.seq-y.seq),c=l.filter(d=>d.groupId==null).sort((d,y)=>d.seq-y.seq);n.groups=[...i,...b,...c],n.groups.forEach(d=>{const y=d.params.filter(f=>f.pOrder!=null).sort((f,h)=>f.pOrder-h.pOrder||f.seq-h.seq),u=d.params.filter(f=>f.pOrder==null).sort((f,h)=>f.seq-h.seq);d.params=[...y,...u]})}),s}function Ce(t,e){for(let r=1;r<=9;r++)g.setValueFromCoords(r,t-1,"");const a={};for(let r=0;r<=9;r++)a[`${_(r)}${t}`]=e;g.setStyle(a)}async function ie(t,e,{currentCell:a}={}){let r=String(t).trim(),o=null;if(a){const i=a.match(/^([A-Z]+)\d+$/);if(i){const b=E(i[1]),c=A.value.get(b);c&&(o=c.id)}}r=r.replace(/P\(\s*([0-9A-F-]{8,})\s*(?:,\s*"(.*?)")?\s*\)/gi,(i,b,c)=>{const d=K.value.get(String(b).toUpperCase()),y=_e(c,o),u=V.value.get(y),f=u!=null?_(u):null;return d&&f?`${f}${d}`:"0"});const s=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,p=/'?(\d+)'?\!([A-Z]+\d+)/g,m=[];r.replace(s,(i,b,c)=>(m.push({page:+b,cell:c}),"")),r.replace(p,(i,b,c)=>(m.push({page:+b,cell:c}),""));const n=await Promise.all(m.map(i=>$e(i.page,i.cell,e)));let l=0;return r=r.replace(s,()=>String(n[l++])),r=r.replace(p,()=>String(n[l++])),r.startsWith("=")||(r="="+r),r}function ke(t){return String(t||"").replace(/\b([A-Z]+)(\d+)\b/g,(e,a,r)=>{const o=Number(r),s=I.value.get(o);if(!(s!=null&&s.parameterId))return e;const p=E(a),m=A.value.get(p);return m?`P(${s.parameterId},"${m.label}")`:e})}async function ce(t,e){var l,i;const a=Number(((l=t.match(/\d+/))==null?void 0:l[0])||0),r=String(((i=t.match(/^[A-Z]+/))==null?void 0:i[0])||""),o=I.value.get(a);if(!(o!=null&&o.parameterId))return;const s=E(r),p=A.value.get(s);if(!p)return;const m=ke(e);W.value[t]=m,await P.post("/sheet/formula",{numberPage:L,number_page:L,param_id:o.parameterId,period_type_id:p.id,period_label:p.label,cell:t,expr:m,expr_stable:m,expr_raw:e,scope:"permanent",date:X(v.value),for_date:null});const n=await ie(m,v.value,{currentCell:t});N=!0,g.setValue(t,n),N=!1,await new Promise(b=>requestAnimationFrame(b)),g.setStyle({[t]:"border:1px dashed #444;font-weight:600;"})}async function qe(){const{data:t}=await P.get("/sheet/formula",{params:{numberPage:L,date:oe(v.value)}}),e=(t==null?void 0:t.items)||t||[];for(const a of e){let r=null,o=null;if(a.param_id&&a.period_type_id!=null&&(r=K.value.get(String(a.param_id)),o=V.value.get(Number(a.period_type_id))),(r==null||o==null)&&a.cell){const m=String(a.cell).match(/^([A-Z]+)(\d+)$/);m&&(o=E(m[1]),r=Number(m[2]))}if(!r||o==null)continue;const s=`${_(o)}${r}`,p=a.expr_stable||a.expr||"";W.value[s]=p;try{const m=await ie(p,v.value,{currentCell:s});N=!0,g.setValue(s,m),N=!1,g.setStyle({[s]:"border:1px dashed #444;font-weight:600;"}),await T(s)}catch(m){console.error("Formula error",s,p,m)}}}let z=null;function De(t=[1,2,4,5]){var b;z&&(z(),z=null);const e=(b=j.value)==null?void 0:b.querySelector(".jexcel_content"),a=e==null?void 0:e.querySelector("tbody");if(!e||!a)return;const r=1e3,o=[],s=e.querySelector("thead tr")||e.querySelector(".jexcel_headers tr")||e.querySelector(".jexcel_headers"),p=s?Array.from(s.children):[],m=s&&(s.getBoundingClientRect().height||s.offsetHeight)||28;s&&p.forEach(c=>{const d={position:c.style.position,top:c.style.top,z:c.style.zIndex,bg:c.style.backgroundColor,boxShadow:c.style.boxShadow};o.push(()=>{c.style.position=d.position,c.style.top=d.top,c.style.zIndex=d.z,c.style.backgroundColor=d.bg,c.style.boxShadow=d.boxShadow}),c.style.position="sticky",c.style.top="0px",c.style.zIndex=String(r+t.length+1),c.style.backgroundColor="#eaf2fb",c.style.boxShadow="0 1px 0 rgba(0,0,0,.08)"});let n=m;const l=t.map(c=>a.children[c-1]).filter(Boolean);l.forEach((c,d)=>{const y=c.getBoundingClientRect().height||c.offsetHeight;Array.from(c.children).forEach(u=>{const f={position:u.style.position,top:u.style.top,z:u.style.zIndex,bg:u.style.backgroundColor,boxShadow:u.style.boxShadow};o.push(()=>{u.style.position=f.position,u.style.top=f.top,u.style.zIndex=f.z,u.style.backgroundColor=f.bg,u.style.boxShadow=f.boxShadow}),u.style.position="sticky",u.style.top=`${n}px`,u.style.zIndex=String(r+d),u.style.backgroundColor="#eef7ff",u.style.boxShadow="0 1px 0 rgba(0,0,0,.08)"}),n+=y});const i=()=>{const c=e.scrollTop>0;[...p,...l.flatMap(d=>Array.from(d.children))].forEach(d=>{d.style.boxShadow=c?"0 2px 4px rgba(0,0,0,.06)":"0 1px 0 rgba(0,0,0,.08)"})};e.addEventListener("scroll",i),z=()=>{e.removeEventListener("scroll",i),o.forEach(c=>c())}}async function T(t,{toast:e=!1}={}){const a=t.match(/^([A-Z]+)(\d+)$/);if(!a)return;const r=a[1],o=Number(a[2]),s=E(r),p=o-1,m=I.value.get(o);if(!m)return;const n=A.value.get(s);if(!n)return;let l=g.getValueFromCoords(s,p,!1);(l==null||l==="")&&(l=g.getValueFromCoords(s,p,!0));const i=Me(l);if(i===null)return;const{start:b,end:c}=se(n.label,v.value);await P.post("/static-params/upsert",{number_page:L,factory_structure_id:m.fsId,parameter_id:m.parameterId,group_id:m.groupId,period_type_id:n.id,period_start_date:b,period_end_date:c,value:i,comment:null,for_date:X(v.value)}),e&&C({message:"Maʼlumot saqlandi",color:"success"})}function Me(t){if(typeof t=="number")return t;if(t==null)return null;let e=String(t).trim().replace(/\u00A0/g,"");const a=e.lastIndexOf("."),r=e.lastIndexOf(","),o=Math.max(a,r)===-1?"":a>r?".":",";e=e.replace(/\s+/g,""),o===","&&(e=e.replace(/\./g,"")),o==="."&&(e=e.replace(/,/g,"")),o&&(e=e.replace(o,"."));const s=Number(e);return Number.isFinite(s)?s:null}return Oe(async()=>{await Promise.all([be(),ve()]),R()}),ee(v,R),ee([M,q],R),(t,e)=>(de(),ue("div",ze,[Z("div",Te,[Z("div",He,[G(U(Be),{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=a=>B.value=a),class:"max-w-[700px] w-full",placeholder:"",onKeyup:Ve(ae,["enter"])},null,8,["modelValue"]),G(U(me),{size:"small",onClick:ae,disabled:!D.value},{default:pe(()=>e[3]||(e[3]=[fe(" Formula’ni saqla ",-1)])),_:1,__:[3]},8,["disabled"]),D.value?(de(),ue("span",Ze,"Katak: "+Ee(D.value),1)):Pe("",!0)]),G(U(me),{preset:"secondary",onClick:e[1]||(e[1]=a=>t.$router.back())},{default:pe(()=>e[4]||(e[4]=[fe("← Orqaga",-1)])),_:1,__:[4]}),G(U(Le),{modelValue:v.value,"onUpdate:modelValue":[e[2]||(e[2]=a=>v.value=a),R],teleport:!0,"teleport-target":"body",placement:"bottom-start",offset:[0,8]},null,8,["modelValue"]),e[5]||(e[5]=Z("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),Z("div",{ref_key:"sheetEl",ref:j,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{We as default};
