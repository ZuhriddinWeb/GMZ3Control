import{u as ce,r as V,o as fe,L as Y,g as ge,h as pe,i as G,j as U,l as me,x as be,k as X,z as he,aj as ye,n as O}from"./app-W1L24GQ1.js";import{j as we}from"./jsuites-DCmpAWeq.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const ke={class:"p-3 pt-28"},_e={class:"flex items-center gap-3 mb-3"},D=303,$e={__name:"GMZ3Report",setup(Ie){const{init:M}=ce(),T=V(null),w=V(new Date);let a=null;const q=V([]),P=V({});let S=!1;const v=V(new Map);let L=!1;const A=V([]),K=r=>{const e=new Date(r);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function Q(){try{const{data:r}=await O.get(`/static-with-numberpage/${D}`),e=Array.isArray(r)?r:r.items||[];A.value=e}catch(r){console.error(r),M({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function ee(r){const e=new Date(r),o=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),i=e.getFullYear();return`${o}.${n}.${i}`}function N(r){let e="",o=r;for(;o>=0;)e=String.fromCharCode(o%26+65)+e,o=Math.floor(o/26)-1;return e}function j(r){const e=r.match(/^([A-Z]+)(\d+)$/),o=+e[2]-1;let n=0;for(const i of e[1])n=n*26+(i.charCodeAt(0)-64);return{x:n-1,y:o}}function E(r){const[e,o]=r.split(":"),n=j(e),i=j(o);return{row:Math.min(n.y,i.y),col:Math.min(n.x,i.x),rowspan:Math.abs(n.y-i.y)+1,colspan:Math.abs(n.x-i.x)+1}}async function te(){try{const{data:r}=await O.get("/periodType");q.value=Array.isArray(r)?r:r.items||[]}catch(r){console.error(r),M({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function re(){const r=new Map((q.value||[]).map(d=>[String(d.id),String(d.name||"").trim()])),e=[...new Set((A.value||[]).map(d=>d==null?void 0:d.period_type_id).filter(d=>d!=null).map(String))],o=d=>{const m=String(d||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(m)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(m)?"Oylik":d?d.charAt(0).toUpperCase()+d.slice(1):""},n=d=>{const m=e.find(t=>new RegExp(d,"i").test(r.get(t)||""));return m?o(r.get(m)):null};let i=n("kun|sutk"),l=n("oy|mes");if(!i&&e.includes("1")&&(i="Kunlik"),!l&&e.includes("2")&&(l="Oylik"),!i||!l){const d=[...e].sort((m,t)=>Number(m)-Number(t));if(!i&&d[0]&&(i=o(r.get(d[0])||"Kunlik")),!l){const m=d.find(t=>t!==d[0])||d[0];l=o(r.get(m)||"Oylik")}}return i===l&&(i==="Kunlik"?l="Oylik":l==="Oylik"?i="Kunlik":(i="Kunlik",l="Oylik")),{dailyLabel:i,monthlyLabel:l}}async function B(){L=!0,v.value.clear(),v.value=new Map;const r=ae(A.value),e=r.reduce((s,f)=>s+f.groups.reduce((b,g)=>b+g.params.length,0),0),o=r.reduce((s,f)=>s+f.groups.filter(b=>!!b.gName).length,0),n=r.length*2,i=7+e+o+n+5,l=150,d=Math.max(i,300),m=Array.from({length:d},()=>Array(l).fill(""));a&&(a.destroy(),a=null),a=we(T.value,{data:m,columns:Array.from({length:l},(s,f)=>({title:N(f),width:f===0?520:f===1?120:110})),minDimensions:[l,d],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[E("A1:F1"),E("A2:F2"),E("B4:B5"),E("C4:E4")],onchange:async(s,f,b,g,h)=>{if(S||L)return;const y=Number(g)+1,_=Number(b),I=`${N(_)}${y}`;if(!(!v.value.get(y)||!z(_)))try{typeof h=="string"&&h.trim().startsWith("=")?(await de(I,h.trim()),await new Promise($=>requestAnimationFrame($)),await R(I,{toast:!0})):await R(I,{toast:!0})}catch($){console.error($),M({message:"Saqlashda xatolik",color:"danger"})}}}),a.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),a.setValue("A2",`${ee(w.value)} y.`),a.setValue("A3","—"),a.setValue("A4","Ko'rsatgichlar nomi."),a.setValue("B4","o'lchov birligi");const{dailyLabel:t,monthlyLabel:u}=re();console.log(t,u),a.setValue("C4",t),a.setValue("C5","reja"),a.setValue("D4",t),a.setValue("D5","fakt/20:08"),a.setValue("E4",t),a.setValue("E5","fakt/08:20"),a.setValue("F4",t),a.setValue("F5","fakt jami"),a.setValue("G4",""),a.setValue("G5","%"),a.setValue("H4",u),a.setValue("H5","reja"),a.setValue("I4",u),a.setValue("I5","fakt"),a.setValue("J4",u),a.setValue("J5","%"),a.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const p={};["A","B","C","D","E","F"].forEach(s=>p[`${s}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(s=>p[`${s}5`]="border:1px solid #bdbdbd;"),a.setStyle(p);function k(s,f){try{typeof a.setMerge=="function"&&a.setMerge(`A${s}`,10,1)}catch{}const b={};for(let g=0;g<=9;g++)b[`${N(g)}${s}`]=f;a.setStyle(b)}let c=7;for(const s of r){a.setValue(`A${c}`,s.fsName),k(c,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),a.setHeight(c-1,28),c++;for(const f of s.groups){f.gName&&(a.setValue(`A${c}`,f.gName),se(c,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),a.setHeight(c-1,26),c++);for(const b of f.params){v.value.set(c,{fsId:b.fsId,groupId:b.groupId,parameterId:b.parameterId}),v.value.set(c,{fsId:b.fsId,groupId:b.groupId,parameterId:b.parameterId}),a.setValue(`A${c}`,b.name),a.setValue(`B${c}`,b.unit);const g={};g[`A${c}`]="border:1px solid #dddddd;padding-left:6px;",g[`B${c}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(h=>{g[`${h}${c}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),a.setStyle(g),a.setHeight(c-1,24),c++}}c++}a.setHeight(0,34),a.setHeight(1,28),a.setHeight(3,28),a.setHeight(4,24),await oe(),await ue(),L=!1}async function ne(r,e,o){const{data:n}=await O.get("/sheet/value",{params:{numberPage:r,cell:e,date:K(o)}});return Number((n==null?void 0:n.value)??0)}function J(){const r=new Map((q.value||[]).map(l=>[String(l.id),String(l.name||"").trim().toLowerCase()])),e=[...new Set((A.value||[]).map(l=>l==null?void 0:l.period_type_id).filter(l=>l!=null).map(String))],o=l=>e.find(d=>l.some(m=>(r.get(d)||"").includes(m)));let n=o(["kun","sutk"])||(e.includes("1")?"1":null),i=o(["oy","mes"])||(e.includes("2")?"2":null);return!n&&e.length&&(n=e[0]),!i&&e.length&&(i=e.find(l=>l!==n)||e[0]),{dailyId:Number(n),monthlyId:Number(i)}}function C(r){const e=new Date(r);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function Z(r){const e=new Date(r),o=new Date(e.getFullYear(),e.getMonth(),1),n=new Date(e.getFullYear(),e.getMonth()+1,0);return{start:C(o),end:C(n)}}function z(r){const e=N(r);return["C","D","E","F","G"].includes(e)?"daily":["H","I","J"].includes(e)?"monthly":null}async function oe(){const r=A.value||[];if(!r.length)return;const{dailyId:e,monthlyId:o}=J(),n=C(w.value),{start:i,end:l}=Z(w.value),d=new Map;for(const[t,u]of v.value.entries())d.set(String(u.parameterId),t);const m=S;S=!0;for(const t of r){const u=String(t.ParameterID||""),p=d.get(u);if(!p)continue;const k=Number(t.period_type_id),c=String(t.period_start_date||""),s=String(t.period_end_date||c||"");if(!(k===e&&c===n&&s===n)&&!(k===o&&c===i&&s===l))continue;const g=t.Comment||(k===e?"daily_plan":"monthly_plan"),h=ie(g);h&&a.setValue(`${h}${p}`,t.value)}S=m}function ae(r){const e=t=>{const u=String(t??"").trim().toLowerCase();if(u===""||u==="null"||u==="undefined")return null;const p=Number(u);return Number.isFinite(p)?p:null};let o=0;const n=new Map,i=new Set;for(const t of r||[]){const u=o++,p=(t==null?void 0:t.FactoryStructureID)??null,k=(t==null?void 0:t.FSName)||(p!=null?`Struktura #${p}`:"Struktura"),c=e(t==null?void 0:t.OrderNumberSex);let s=(t==null?void 0:t.GroupID)??null;const f=t==null?void 0:t.GName,b=!!String(f??"").trim();s!=null&&!b&&(s=null);const g=b?f:null,h=e(t==null?void 0:t.OrderNumberGroup),y=(t==null?void 0:t.ParameterID)??(t==null?void 0:t.id)??(t==null?void 0:t.Uuid);if(y&&i.has(`${p}:${s}:${y}`))continue;y&&i.add(`${p}:${s}:${y}`);const _=(t==null?void 0:t.PName)||(t==null?void 0:t.Name)||`Param ${y}`,I=(t==null?void 0:t.UName)||"",H=e(t==null?void 0:t.OrderNumber);n.has(p)||n.set(p,{fsId:p,fsName:k,fsOrder:c,seq:u,groups:new Map});const x=n.get(p);x.fsOrder==null&&c!=null&&(x.fsOrder=c),x.seq=Math.min(x.seq,u);const $=s==null?"zzz_nogroup":`g_${s}`;x.groups.has($)||x.groups.set($,{groupId:s,gName:g,gOrder:h,seq:u,params:[]});const F=x.groups.get($);F.gOrder==null&&h!=null&&(F.gOrder=h),F.seq=Math.min(F.seq,u),F.params.push({name:_,unit:I,fsId:p,groupId:s,parameterId:y,pOrder:H,seq:u})}let l=Array.from(n.values());const d=l.filter(t=>t.fsOrder!=null).sort((t,u)=>t.fsOrder-u.fsOrder||t.seq-u.seq),m=l.filter(t=>t.fsOrder==null).sort((t,u)=>t.seq-u.seq);return l=[...d,...m],l.forEach(t=>{const u=Array.from(t.groups.values()),p=u.filter(s=>s.groupId!=null&&s.gOrder!=null).sort((s,f)=>s.gOrder-f.gOrder||s.seq-f.seq),k=u.filter(s=>s.groupId!=null&&s.gOrder==null).sort((s,f)=>s.seq-f.seq),c=u.filter(s=>s.groupId==null).sort((s,f)=>s.seq-f.seq);t.groups=[...p,...k,...c],t.groups.forEach(s=>{const f=s.params.filter(g=>g.pOrder!=null).sort((g,h)=>g.pOrder-h.pOrder||g.seq-h.seq),b=s.params.filter(g=>g.pOrder==null).sort((g,h)=>g.seq-h.seq);s.params=[...f,...b]})}),l}function se(r,e){for(let n=1;n<=9;n++)a.setValueFromCoords(n,r-1,"");const o={};for(let n=0;n<=9;n++)o[`${N(n)}${r}`]=e;a.setStyle(o)}async function W(r,e){let o=String(r).trim();const n=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,i=/'?(\d+)'?\!([A-Z]+\d+)/g,l=[];o.replace(n,(t,u,p)=>(l.push({page:+u,cell:p}),"")),o.replace(i,(t,u,p)=>(l.push({page:+u,cell:p}),""));const d=await Promise.all(l.map(t=>ne(t.page,t.cell,e)));let m=0;return o=o.replace(n,()=>String(d[m++])),o=o.replace(i,()=>String(d[m++])),o.startsWith("=")||(o="="+o),o}function le(r){switch(r){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function ie(r){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[r]||null}async function de(r,e){P.value[r]=e;const o=r.match(/\d+/),n=o?Number(o[0]):null,i=n?v.value.get(n):null;await O.post("/sheet/formula",{numberPage:D,number_page:D,param_id:(i==null?void 0:i.parameterId)||null,cell:r,expr:e,scope:"permanent",date:C(w.value),for_date:null});const l=await W(e,w.value);S=!0,a.setValue(r,l),S=!1,await new Promise(m=>requestAnimationFrame(m));const d={};d[r]="border:1px dashed #444;font-weight:600;",a.setStyle(d)}async function ue(){const{data:r}=await O.get("/sheet/formula",{params:{numberPage:D,date:K(w.value)}});((r==null?void 0:r.items)||r||[]).forEach(e=>{P.value[e.cell]=e.expr});for(const[e,o]of Object.entries(P.value))try{const n=await W(o,w.value);S=!0,a.setValue(e,n),S=!1;const i={};i[e]="border:1px dashed #444;font-weight:600;",a.setStyle(i),await R(e)}catch(n){console.error("Formula error",e,o,n)}}async function R(r,{toast:e=!1}={}){const o=r.match(/^([A-Z]+)(\d+)$/);if(!o)return;const n=o[1],i=Number(o[2]),l=(_=>{let I=0;for(const H of _)I=I*26+(H.charCodeAt(0)-64);return I-1})(n),d=i-1,m=v.value.get(i);if(!m)return;const{dailyId:t,monthlyId:u}=J(),p=z(l),k=p==="daily"?t:u;let c=a.getValueFromCoords(l,d,!0);typeof c=="string"&&(c=c.replace(",","."));const s=parseFloat(c),f=Number.isFinite(s)?s:null;if(f===null)return;let b,g;if(p==="daily"){const _=C(w.value);b=_,g=_}else{const{start:_,end:I}=Z(w.value);b=_,g=I}const h=le(n),y=await O.post("/static-params/upsert",{number_page:D,factory_structure_id:m.fsId,parameter_id:m.parameterId,group_id:m.groupId,period_type_id:k,period_start_date:b,period_end_date:g,value:f,comment:h});e&&y&&y.status>=200&&y.status<300&&M({message:"Maʼlumot saqlandi",color:"success"})}return fe(async()=>{await Promise.all([Q(),te()]),B()}),Y(w,B),Y([A,q],B),(r,e)=>(pe(),ge("div",ke,[G("div",_e,[U(X(he),{preset:"secondary",onClick:e[0]||(e[0]=o=>r.$router.back())},{default:me(()=>e[2]||(e[2]=[be("← Orqaga",-1)])),_:1,__:[2]}),U(X(ye),{modelValue:w.value,"onUpdate:modelValue":[e[1]||(e[1]=o=>w.value=o),B]},null,8,["modelValue"]),e[3]||(e[3]=G("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),G("div",{ref_key:"sheetEl",ref:T,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{$e as default};
