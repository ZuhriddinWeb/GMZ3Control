import{u as ie,r as v,o as de,L as Y,g as ue,h as ce,i as G,j as q,l as fe,x as ge,k as U,z as me,aj as pe,n as $}from"./app-B5o22c3C.js";import{j as be}from"./jsuites-BLPiwKmg.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const ye={class:"p-3 pt-28"},he={class:"flex items-center gap-3 mb-3"},V=303,xe={__name:"GMZ3Report",setup(we){const{init:N}=ie(),K=v(null),k=v(new Date);let o=null;const M=v([]),P=v({});let S=!1;const x=v(new Map);let E=!1;const O=v([]),L=n=>{const t=new Date(n);return`${String(t.getDate()).padStart(2,"0")}.${String(t.getMonth()+1).padStart(2,"0")}.${t.getFullYear()}`};async function W(){try{const{data:n}=await $.get(`/static-with-numberpage/${V}`),t=Array.isArray(n)?n:n.items||[];O.value=t}catch(n){console.error(n),N({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function X(n){const t=new Date(n),r=String(t.getDate()).padStart(2,"0"),l=String(t.getMonth()+1).padStart(2,"0"),s=t.getFullYear();return`${r}.${l}.${s}`}function C(n){let t="",r=n;for(;r>=0;)t=String.fromCharCode(r%26+65)+t,r=Math.floor(r/26)-1;return t}function R(n){const t=n.match(/^([A-Z]+)(\d+)$/),r=+t[2]-1;let l=0;for(const s of t[1])l=l*26+(s.charCodeAt(0)-64);return{x:l-1,y:r}}function D(n){const[t,r]=n.split(":"),l=R(t),s=R(r);return{row:Math.min(l.y,s.y),col:Math.min(l.x,s.x),rowspan:Math.abs(l.y-s.y)+1,colspan:Math.abs(l.x-s.x)+1}}async function Q(){try{const{data:n}=await $.get("/periodType");M.value=Array.isArray(n)?n:n.items||[]}catch(n){console.error(n),N({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function ee(){const n=new Map((M.value||[]).map(e=>[String(e.id),String(e.name||"").trim()])),t=[...new Set((O.value||[]).map(e=>e==null?void 0:e.period_type_id).filter(e=>e!=null).map(String))],r=e=>{const a=String(e||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(a)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(a)?"Oylik":e?e.charAt(0).toUpperCase()+e.slice(1):""},l=e=>{const a=t.find(i=>new RegExp(e,"i").test(n.get(i)||""));return a?r(n.get(a)):null};let s=l("kun|sutk"),d=l("oy|mes");if(!s&&t.includes("1")&&(s="Kunlik"),!d&&t.includes("2")&&(d="Oylik"),!s||!d){const e=[...t].sort((a,i)=>Number(a)-Number(i));if(!s&&e[0]&&(s=r(n.get(e[0])||"Kunlik")),!d){const a=e.find(i=>i!==e[0])||e[0];d=r(n.get(a)||"Oylik")}}return s===d&&(s==="Kunlik"?d="Oylik":d==="Oylik"?s="Kunlik":(s="Kunlik",d="Oylik")),{dailyLabel:s,monthlyLabel:d}}async function F(){E=!0,x.value.clear(),x.value=new Map;const n=re(O.value),t=n.reduce((g,b)=>g+b.groups.reduce((p,m)=>p+m.params.length,0),0),r=n.reduce((g,b)=>g+b.groups.filter(p=>!!p.gName).length,0),l=n.length*2,s=7+t+r+l+5,d=150,e=Math.max(s,300),a=Array.from({length:e},()=>Array(d).fill(""));o&&(o.destroy(),o=null),o=be(K.value,{data:a,columns:Array.from({length:d},(g,b)=>({title:C(b),width:b===0?520:b===1?120:110})),minDimensions:[d,e],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[D("A1:F1"),D("A2:F2"),D("B4:B5"),D("C4:E4")],onchange:async(g,b,p,m,h)=>{if(S||E)return;const I=Number(m)+1,w=Number(p),_=`${C(w)}${I}`;if(!(!x.value.get(I)||!J(w)))try{typeof h=="string"&&h.trim().startsWith("=")?(await le(_,h.trim()),await new Promise(H=>requestAnimationFrame(H)),await B(_,{toast:!0})):await B(_,{toast:!0})}catch(H){console.error(H),N({message:"Saqlashda xatolik",color:"danger"})}}}),o.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),o.setValue("A2",`${X(k.value)} y.`),o.setValue("A3","—"),o.setValue("A4","Ko'rsatgichlar nomi."),o.setValue("B4","o'lchov birligi");const{dailyLabel:i,monthlyLabel:u}=ee();console.log(i,u),o.setValue("C4",i),o.setValue("C5","reja"),o.setValue("D4",i),o.setValue("D5","fakt/20:08"),o.setValue("E4",i),o.setValue("E5","fakt/08:20"),o.setValue("F4",i),o.setValue("F5","fakt jami"),o.setValue("G4",""),o.setValue("G5","%"),o.setValue("H4",u),o.setValue("H5","reja"),o.setValue("I4",u),o.setValue("I5","fakt"),o.setValue("J4",u),o.setValue("J5","%"),o.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const c={};["A","B","C","D","E","F"].forEach(g=>c[`${g}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(g=>c[`${g}5`]="border:1px solid #bdbdbd;"),o.setStyle(c);function y(g,b){try{typeof o.setMerge=="function"&&o.setMerge(`A${g}`,10,1)}catch{}const p={};for(let m=0;m<=9;m++)p[`${C(m)}${g}`]=b;o.setStyle(p)}let f=7;for(const g of n){o.setValue(`A${f}`,g.fsName),y(f,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),o.setHeight(f-1,28),f++;for(const b of g.groups){b.gName&&(o.setValue(`A${f}`,b.gName),y(f,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),o.setHeight(f-1,26),f++);for(const p of b.params){x.value.set(f,{fsId:p.fsId,groupId:p.groupId,parameterId:p.parameterId}),x.value.set(f,{fsId:p.fsId,groupId:p.groupId,parameterId:p.parameterId}),o.setValue(`A${f}`,p.name),o.setValue(`B${f}`,p.unit);const m={};m[`A${f}`]="border:1px solid #dddddd;padding-left:6px;",m[`B${f}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(h=>{m[`${h}${f}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),o.setStyle(m),o.setHeight(f-1,24),f++}}f++}o.setHeight(0,34),o.setHeight(1,28),o.setHeight(3,28),o.setHeight(4,24),await ne(),await se(),E=!1}async function te(n,t,r){const{data:l}=await $.get("/sheet/value",{params:{numberPage:n,cell:t,date:L(r)}});return Number((l==null?void 0:l.value)??0)}function T(){const n=new Map((M.value||[]).map(d=>[String(d.id),String(d.name||"").trim().toLowerCase()])),t=[...new Set((O.value||[]).map(d=>d==null?void 0:d.period_type_id).filter(d=>d!=null).map(String))],r=d=>t.find(e=>d.some(a=>(n.get(e)||"").includes(a)));let l=r(["kun","sutk"])||(t.includes("1")?"1":null),s=r(["oy","mes"])||(t.includes("2")?"2":null);return!l&&t.length&&(l=t[0]),!s&&t.length&&(s=t.find(d=>d!==l)||t[0]),{dailyId:Number(l),monthlyId:Number(s)}}function A(n){const t=new Date(n);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function j(n){const t=new Date(n),r=new Date(t.getFullYear(),t.getMonth(),1),l=new Date(t.getFullYear(),t.getMonth()+1,0);return{start:A(r),end:A(l)}}function J(n){const t=C(n);return["C","D","E","F","G"].includes(t)?"daily":["H","I","J"].includes(t)?"monthly":null}async function ne(){const n=O.value||[];if(!n.length)return;const{dailyId:t,monthlyId:r}=T(),l=A(k.value),{start:s,end:d}=j(k.value),e=new Map;for(const[i,u]of x.value.entries())e.set(String(u.parameterId),i);const a=S;S=!0;for(const i of n){const u=String(i.ParameterID||""),c=e.get(u);if(!c)continue;const y=Number(i.period_type_id),f=String(i.period_start_date||""),g=String(i.period_end_date||f||"");if(!(y===t&&f===l&&g===l)&&!(y===r&&f===s&&g===d))continue;const m=i.Comment||(y===t?"daily_plan":"monthly_plan"),h=oe(m);h&&o.setValue(`${h}${c}`,i.value)}S=a}function re(n){const t=e=>{const a=Number(String(e).trim());return Number.isFinite(a)?a:null},r=(e,a)=>{const i=Math.max(e.length,a.length);for(let u=0;u<i;u++){const c=e[u],y=a[u];if(c!==y)return typeof c=="number"&&typeof y=="number"?c-y:String(c).localeCompare(String(y),void 0,{numeric:!0})}return 0},l=new Map,s=new Set;for(const e of n||[]){const a=(e==null?void 0:e.FactoryStructureID)??null,i=(e==null?void 0:e.FSName)||(a!=null?`Struktura #${a}`:"Struktura"),u=t(e==null?void 0:e.OrderNumberSex),c=(e==null?void 0:e.GroupID)??null,y=c!=null?(e==null?void 0:e.GName)||`Guruh #${c}`:null,f=t(e==null?void 0:e.OrderNumberGroup),g=(e==null?void 0:e.ParameterID)??(e==null?void 0:e.id)??(e==null?void 0:e.Uuid);if(g&&s.has(`${a}:${c}:${g}`))continue;g&&s.add(`${a}:${c}:${g}`);const b=(e==null?void 0:e.PName)||(e==null?void 0:e.Name)||`Param ${g}`,p=(e==null?void 0:e.UName)||"tn.",m=t(e==null?void 0:e.OrderNumber);l.has(a)||l.set(a,{fsId:a,fsName:i,fsOrder:null,minParamOrder:1/0,groups:new Map});const h=l.get(a);u!=null&&(h.fsOrder=h.fsOrder==null?u:Math.min(h.fsOrder,u)),m!=null&&(h.minParamOrder=Math.min(h.minParamOrder,m));const I=c==null?"zzz_nogroup":`g_${c}`;h.groups.has(I)||h.groups.set(I,{groupId:c,gName:y,gOrder:null,minParamOrder:1/0,params:[]});const w=h.groups.get(I);f!=null&&(w.gOrder=w.gOrder==null?f:Math.min(w.gOrder,f)),m!=null&&(w.minParamOrder=Math.min(w.minParamOrder,m)),w.params.push({name:b,unit:p,fsId:a,groupId:c,parameterId:g,pOrder:m})}const d=Array.from(l.values());return d.sort((e,a)=>{const i=[e.fsOrder==null?1:0,e.fsOrder==null?1/0:e.fsOrder,e.minParamOrder,e.fsName],u=[a.fsOrder==null?1:0,a.fsOrder==null?1/0:a.fsOrder,a.minParamOrder,a.fsName];return r(i,u)}),d.forEach(e=>{const a=Array.from(e.groups.values());a.sort((i,u)=>{const c=[i.groupId==null?1:0,i.gOrder==null?1:0,i.gOrder==null?1/0:i.gOrder,i.minParamOrder,i.gName??i.groupId??""],y=[u.groupId==null?1:0,u.gOrder==null?1:0,u.gOrder==null?1/0:u.gOrder,u.minParamOrder,u.gName??u.groupId??""];return r(c,y)}),a.forEach(i=>{i.params.sort((u,c)=>{const y=[u.pOrder==null?1:0,u.pOrder==null?1/0:u.pOrder,u.name],f=[c.pOrder==null?1:0,c.pOrder==null?1/0:c.pOrder,c.name];return r(y,f)})}),e.groups=a}),d}async function Z(n,t){let r=String(n).trim();const l=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,s=/'?(\d+)'?\!([A-Z]+\d+)/g,d=[];r.replace(l,(i,u,c)=>(d.push({page:+u,cell:c}),"")),r.replace(s,(i,u,c)=>(d.push({page:+u,cell:c}),""));const e=await Promise.all(d.map(i=>te(i.page,i.cell,t)));let a=0;return r=r.replace(l,()=>String(e[a++])),r=r.replace(s,()=>String(e[a++])),r.startsWith("=")||(r="="+r),r}function ae(n){switch(n){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function oe(n){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[n]||null}async function le(n,t){P.value[n]=t;const r=n.match(/\d+/),l=r?Number(r[0]):null,s=l?x.value.get(l):null;await $.post("/sheet/formula",{numberPage:V,number_page:V,param_id:(s==null?void 0:s.parameterId)||null,cell:n,expr:t,scope:"permanent",date:A(k.value),for_date:null});const d=await Z(t,k.value);S=!0,o.setValue(n,d),S=!1,await new Promise(a=>requestAnimationFrame(a));const e={};e[n]="border:1px dashed #444;font-weight:600;",o.setStyle(e)}async function se(){const{data:n}=await $.get("/sheet/formula",{params:{numberPage:V,date:L(k.value)}});((n==null?void 0:n.items)||n||[]).forEach(t=>{P.value[t.cell]=t.expr});for(const[t,r]of Object.entries(P.value))try{const l=await Z(r,k.value);S=!0,o.setValue(t,l),S=!1;const s={};s[t]="border:1px dashed #444;font-weight:600;",o.setStyle(s),await B(t)}catch(l){console.error("Formula error",t,r,l)}}async function B(n,{toast:t=!1}={}){const r=n.match(/^([A-Z]+)(\d+)$/);if(!r)return;const l=r[1],s=Number(r[2]),d=(w=>{let _=0;for(const z of w)_=_*26+(z.charCodeAt(0)-64);return _-1})(l),e=s-1,a=x.value.get(s);if(!a)return;const{dailyId:i,monthlyId:u}=T(),c=J(d),y=c==="daily"?i:u;let f=o.getValueFromCoords(d,e,!0);typeof f=="string"&&(f=f.replace(",","."));const g=parseFloat(f),b=Number.isFinite(g)?g:null;if(b===null)return;let p,m;if(c==="daily"){const w=A(k.value);p=w,m=w}else{const{start:w,end:_}=j(k.value);p=w,m=_}const h=ae(l),I=await $.post("/static-params/upsert",{number_page:V,factory_structure_id:a.fsId,parameter_id:a.parameterId,group_id:a.groupId,period_type_id:y,period_start_date:p,period_end_date:m,value:b,comment:h});t&&I&&I.status>=200&&I.status<300&&N({message:"Maʼlumot saqlandi",color:"success"})}return de(async()=>{await Promise.all([W(),Q()]),F()}),Y(k,F),Y([O,M],F),(n,t)=>(ce(),ue("div",ye,[G("div",he,[q(U(me),{preset:"secondary",onClick:t[0]||(t[0]=r=>n.$router.back())},{default:fe(()=>t[2]||(t[2]=[ge("← Orqaga",-1)])),_:1,__:[2]}),q(U(pe),{modelValue:k.value,"onUpdate:modelValue":[t[1]||(t[1]=r=>k.value=r),F]},null,8,["modelValue"]),t[3]||(t[3]=G("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),G("div",{ref_key:"sheetEl",ref:K,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{xe as default};
