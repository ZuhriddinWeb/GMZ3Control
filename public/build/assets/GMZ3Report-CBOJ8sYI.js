import{u as de,r as A,o as ue,L as q,g as ce,h as fe,i as O,j as U,l as ge,x as pe,k as W,z as me,aj as be,n as V}from"./app-C_2dUSXa.js";import{j as he}from"./jsuites-Bk7_5e_6.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const ye={class:"p-3 pt-28"},we={class:"flex items-center gap-3 mb-3"},C=303,$e={__name:"GMZ3Report",setup(Ie){const{init:F}=de(),R=A(null),h=A(new Date);let o=null;const D=A([]),B=A({});let _=!1;const S=A(new Map);let P=!1;const v=A([]),T=n=>{const e=new Date(n);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function X(){try{const{data:n}=await V.get(`/static-with-numberpage/${C}`),e=Array.isArray(n)?n:n.items||[];v.value=e}catch(n){console.error(n),F({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function Q(n){const e=new Date(n),r=String(e.getDate()).padStart(2,"0"),l=String(e.getMonth()+1).padStart(2,"0"),t=e.getFullYear();return`${r}.${l}.${t}`}function M(n){let e="",r=n;for(;r>=0;)e=String.fromCharCode(r%26+65)+e,r=Math.floor(r/26)-1;return e}function K(n){const e=n.match(/^([A-Z]+)(\d+)$/),r=+e[2]-1;let l=0;for(const t of e[1])l=l*26+(t.charCodeAt(0)-64);return{x:l-1,y:r}}function E(n){const[e,r]=n.split(":"),l=K(e),t=K(r);return{row:Math.min(l.y,t.y),col:Math.min(l.x,t.x),rowspan:Math.abs(l.y-t.y)+1,colspan:Math.abs(l.x-t.x)+1}}async function ee(){try{const{data:n}=await V.get("/periodType");D.value=Array.isArray(n)?n:n.items||[]}catch(n){console.error(n),F({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function te(){const n=new Map((D.value||[]).map(s=>[String(s.id),String(s.name||"").trim()])),e=[...new Set((v.value||[]).map(s=>s==null?void 0:s.period_type_id).filter(s=>s!=null).map(String))],r=s=>{const i=String(s||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(i)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(i)?"Oylik":s?s.charAt(0).toUpperCase()+s.slice(1):""},l=s=>{const i=e.find(d=>new RegExp(s,"i").test(n.get(d)||""));return i?r(n.get(i)):null};let t=l("kun|sutk"),a=l("oy|mes");if(!t&&e.includes("1")&&(t="Kunlik"),!a&&e.includes("2")&&(a="Oylik"),!t||!a){const s=[...e].sort((i,d)=>Number(i)-Number(d));if(!t&&s[0]&&(t=r(n.get(s[0])||"Kunlik")),!a){const i=s.find(d=>d!==s[0])||s[0];a=r(n.get(i)||"Oylik")}}return t===a&&(t==="Kunlik"?a="Oylik":a==="Oylik"?t="Kunlik":(t="Kunlik",a="Oylik")),{dailyLabel:t,monthlyLabel:a}}const H=(n,e=Number.POSITIVE_INFINITY)=>{const r=Number(n);return Number.isFinite(r)?r:e};async function x(){P=!0,S.value.clear(),S.value=new Map;const n=re(v.value),e=n.reduce((c,g)=>c+g.groups.reduce((p,m)=>p+m.params.length,0),0),r=n.reduce((c,g)=>c+g.groups.filter(p=>!!p.gName).length,0),l=n.length*2,t=7+e+r+l+5,a=150,s=Math.max(t,300),i=Array.from({length:s},()=>Array(a).fill(""));o&&(o.destroy(),o=null),o=he(R.value,{data:i,columns:Array.from({length:a},(c,g)=>({title:M(g),width:g===0?520:g===1?120:110})),minDimensions:[a,s],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[E("A1:F1"),E("A2:F2"),E("B4:B5"),E("C4:E4")],onchange:async(c,g,p,m,w)=>{if(_||P)return;const $=Number(m)+1,I=Number(p),k=`${M(I)}${$}`;if(!(!S.value.get($)||!Y(I)))try{typeof w=="string"&&w.trim().startsWith("=")?(await le(k,w.trim()),await new Promise(G=>requestAnimationFrame(G)),await L(k,{toast:!0})):await L(k,{toast:!0})}catch(G){console.error(G),F({message:"Saqlashda xatolik",color:"danger"})}}}),o.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),o.setValue("A2",`${Q(h.value)} y.`),o.setValue("A3","—"),o.setValue("A4","Ko'rsatgichlar nomi."),o.setValue("B4","o'lchov birligi");const{dailyLabel:d,monthlyLabel:f}=te();console.log(d,f),o.setValue("C4",d),o.setValue("C5","reja"),o.setValue("D4",d),o.setValue("D5","fakt/20:08"),o.setValue("E4",d),o.setValue("E5","fakt/08:20"),o.setValue("F4",d),o.setValue("F5","fakt jami"),o.setValue("G4",""),o.setValue("G5","%"),o.setValue("H4",f),o.setValue("H5","reja"),o.setValue("I4",f),o.setValue("I5","fakt"),o.setValue("J4",f),o.setValue("J5","%"),o.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const b={};["A","B","C","D","E","F"].forEach(c=>b[`${c}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(c=>b[`${c}5`]="border:1px solid #bdbdbd;"),o.setStyle(b);function y(c,g){try{typeof o.setMerge=="function"&&o.setMerge(`A${c}`,10,1)}catch{}const p={};for(let m=0;m<=9;m++)p[`${M(m)}${c}`]=g;o.setStyle(p)}let u=7;for(const c of n){o.setValue(`A${u}`,c.fsName),y(u,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),o.setHeight(u-1,28),u++;for(const g of c.groups){g.gName&&(o.setValue(`A${u}`,g.gName),y(u,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),o.setHeight(u-1,26),u++);for(const p of g.params){S.value.set(u,{fsId:p.fsId,groupId:p.groupId,parameterId:p.parameterId}),S.value.set(u,{fsId:p.fsId,groupId:p.groupId,parameterId:p.parameterId}),o.setValue(`A${u}`,p.name),o.setValue(`B${u}`,p.unit);const m={};m[`A${u}`]="border:1px solid #dddddd;padding-left:6px;",m[`B${u}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(w=>{m[`${w}${u}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),o.setStyle(m),o.setHeight(u-1,24),u++}}u++}o.setHeight(0,34),o.setHeight(1,28),o.setHeight(3,28),o.setHeight(4,24),await ae(),await ie(),P=!1}async function ne(n,e,r){const{data:l}=await V.get("/sheet/value",{params:{numberPage:n,cell:e,date:T(r)}});return Number((l==null?void 0:l.value)??0)}function j(){const n=new Map((D.value||[]).map(a=>[String(a.id),String(a.name||"").trim().toLowerCase()])),e=[...new Set((v.value||[]).map(a=>a==null?void 0:a.period_type_id).filter(a=>a!=null).map(String))],r=a=>e.find(s=>a.some(i=>(n.get(s)||"").includes(i)));let l=r(["kun","sutk"])||(e.includes("1")?"1":null),t=r(["oy","mes"])||(e.includes("2")?"2":null);return!l&&e.length&&(l=e[0]),!t&&e.length&&(t=e.find(a=>a!==l)||e[0]),{dailyId:Number(l),monthlyId:Number(t)}}function N(n){const e=new Date(n);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function J(n){const e=new Date(n),r=new Date(e.getFullYear(),e.getMonth(),1),l=new Date(e.getFullYear(),e.getMonth()+1,0);return{start:N(r),end:N(l)}}function Y(n){const e=M(n);return["C","D","E","F","G"].includes(e)?"daily":["H","I","J"].includes(e)?"monthly":null}async function ae(){const n=v.value||[];if(!n.length)return;const{dailyId:e,monthlyId:r}=j(),l=N(h.value),{start:t,end:a}=J(h.value),s=new Map;for(const[d,f]of S.value.entries())s.set(String(f.parameterId),d);const i=_;_=!0;for(const d of n){const f=String(d.ParameterID||""),b=s.get(f);if(!b)continue;const y=Number(d.period_type_id),u=String(d.period_start_date||""),c=String(d.period_end_date||u||"");if(!(y===e&&u===l&&c===l)&&!(y===r&&u===t&&c===a))continue;const m=d.Comment||(y===e?"daily_plan":"monthly_plan"),w=se(m);w&&o.setValue(`${w}${b}`,d.value)}_=i}function re(n){const e=new Map,r=new Set;n.forEach(t=>{const a=(t==null?void 0:t.FactoryStructureID)??null,s=(t==null?void 0:t.FSName)||(a!=null?`Struktura #${a}`:"Struktura"),i=(t==null?void 0:t.GroupID)??null,d=i!=null?(t==null?void 0:t.GName)||`Guruh #${i}`:null,f=(t==null?void 0:t.ParameterID)??(t==null?void 0:t.id)??(t==null?void 0:t.Uuid);if(f&&r.has(`${a}:${i}:${f}`))return;f&&r.add(`${a}:${i}:${f}`);const b=(t==null?void 0:t.PName)||(t==null?void 0:t.Name)||`Param ${f}`,y=(t==null?void 0:t.UName)||"tn.",u=H(t==null?void 0:t.OrderNumber);e.has(a)||e.set(a,{fsId:a,fsName:s,groups:new Map});const c=e.get(a),g=i==null?"zzz_nogroup":`g_${i}`;c.groups.has(g)||c.groups.set(g,{groupId:i,gName:d,params:[]}),c.groups.get(g).params.push({name:b,unit:y,fsId:a,groupId:i,parameterId:f,order:u})});const l=Array.from(e.values()).sort((t,a)=>String(t.fsId).localeCompare(String(a.fsId),void 0,{numeric:!0}));return l.forEach(t=>{t.groups=Array.from(t.groups.values()).sort((a,s)=>{const i=a.groupId==null,d=s.groupId==null;if(i&&!d)return 1;if(!i&&d)return-1;const f=a.gName??a.groupId??"",b=s.gName??s.groupId??"";return String(f).localeCompare(String(b),void 0,{numeric:!0})}),t.groups.forEach(a=>{a.params.sort((s,i)=>{const d=H(s.order)-H(i.order);return d!==0?d:String(s.name).localeCompare(String(i.name),void 0,{numeric:!0})})})}),l}async function Z(n,e){let r=String(n).trim();const l=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,t=/'?(\d+)'?\!([A-Z]+\d+)/g,a=[];r.replace(l,(d,f,b)=>(a.push({page:+f,cell:b}),"")),r.replace(t,(d,f,b)=>(a.push({page:+f,cell:b}),""));const s=await Promise.all(a.map(d=>ne(d.page,d.cell,e)));let i=0;return r=r.replace(l,()=>String(s[i++])),r=r.replace(t,()=>String(s[i++])),r.startsWith("=")||(r="="+r),r}function oe(n){switch(n){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function se(n){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[n]||null}async function le(n,e){B.value[n]=e;const r=n.match(/\d+/),l=r?Number(r[0]):null,t=l?S.value.get(l):null;await V.post("/sheet/formula",{numberPage:C,number_page:C,param_id:(t==null?void 0:t.parameterId)||null,cell:n,expr:e,scope:"permanent",date:N(h.value),for_date:null});const a=await Z(e,h.value);_=!0,o.setValue(n,a),_=!1,await new Promise(i=>requestAnimationFrame(i));const s={};s[n]="border:1px dashed #444;font-weight:600;",o.setStyle(s)}async function ie(){const{data:n}=await V.get("/sheet/formula",{params:{numberPage:C,date:T(h.value)}});((n==null?void 0:n.items)||n||[]).forEach(e=>{B.value[e.cell]=e.expr});for(const[e,r]of Object.entries(B.value))try{const l=await Z(r,h.value);_=!0,o.setValue(e,l),_=!1;const t={};t[e]="border:1px dashed #444;font-weight:600;",o.setStyle(t),await L(e)}catch(l){console.error("Formula error",e,r,l)}}async function L(n,{toast:e=!1}={}){const r=n.match(/^([A-Z]+)(\d+)$/);if(!r)return;const l=r[1],t=Number(r[2]),a=(I=>{let k=0;for(const z of I)k=k*26+(z.charCodeAt(0)-64);return k-1})(l),s=t-1,i=S.value.get(t);if(!i)return;const{dailyId:d,monthlyId:f}=j(),b=Y(a),y=b==="daily"?d:f;let u=o.getValueFromCoords(a,s,!0);typeof u=="string"&&(u=u.replace(",","."));const c=parseFloat(u),g=Number.isFinite(c)?c:null;if(g===null)return;let p,m;if(b==="daily"){const I=N(h.value);p=I,m=I}else{const{start:I,end:k}=J(h.value);p=I,m=k}const w=oe(l),$=await V.post("/static-params/upsert",{number_page:C,factory_structure_id:i.fsId,parameter_id:i.parameterId,group_id:i.groupId,period_type_id:y,period_start_date:p,period_end_date:m,value:g,comment:w});e&&$&&$.status>=200&&$.status<300&&F({message:"Maʼlumot saqlandi",color:"success"})}return ue(async()=>{await Promise.all([X(),ee()]),x()}),q(h,x),q([v,D],x),(n,e)=>(fe(),ce("div",ye,[O("div",we,[U(W(me),{preset:"secondary",onClick:e[0]||(e[0]=r=>n.$router.back())},{default:ge(()=>e[2]||(e[2]=[pe("← Orqaga",-1)])),_:1,__:[2]}),U(W(be),{modelValue:h.value,"onUpdate:modelValue":[e[1]||(e[1]=r=>h.value=r),x]},null,8,["modelValue"]),e[3]||(e[3]=O("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),O("div",{ref_key:"sheetEl",ref:R,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{$e as default};
