import{a as _e,b as Ae,c as $e,r as o,s as R,d as Y,K as E,o as Pe,L as Me,f as Z,g as ee,h as _,i as D,F as ae,G as Le,j as p,l as A,k as C,m as Be,x as te,z as B,I as Ge,J as qe,t as Ke,M as Oe,n as v}from"./app-wpU-urBl.js";/* empty css                   */import{_ as Ue}from"./EditValue-B0Q5p2RU.js";import{u as G,w as ze}from"./xlsx-RWMVbf22.js";import{V as He}from"./VueShiftCalendar-N2BowSNk.js";import{f as T}from"./format-D9pTN3Kd.js";const je={class:"grid grid-rows-[55px,1fr]"},We={class:"flex flex-col"},Xe={class:"m-2 flex pt-3"},Je={class:"flex justify-end"},Qe=8*60,Ye=19*60+59,ra={__name:"ParametrValueVertical",props:{id:Number},setup(le){const c=_e(),F=le,se=Ae(),{t:d,locale:q}=$e(),$=o([]),m=o(null),y=o({}),re=o([]),n=o({smena:null,day:null}),K=R(()=>n.value.day?`${n.value.day} - ${n.value.smena}`:"");o(null);const O=o(null);o(null);const U=o(null);o(null);const w=o(null),ne=c.state.user.id;c.state.user.structure_id;const s=o("1");o([]);const oe=o([]),f=o([]),z=o({}),ue=Y({ParametersID:"",Change:"",Name:"",ShortName:"",Comment:"",GTime:"",Value:"",BlogsID:c.state.user.structure_id,SourceID:"",userId:c.state.user.id});E(()=>c.state.user.roles,e=>{Array.isArray(e)&&e.length>14&&(z.value=e[14])},{immediate:!0});const H=e=>{var a,t;return((t=(a=z.value)==null?void 0:a.pivot)==null?void 0:t[e])==="1"},ie=async()=>{var l,r;if(!f.value.length)return;const e=G.book_new();for(const u of f.value)try{const h=n.value.day,g=n.value.smena,[k,I]=await v.all([v.get(`/get-params-for-user/${F.id}/${g}/${h}/${u.NumberPage}`),v.get(`/vparams-value/${c.state.user.structure_id}/${h}/${g}`)]),b=Array.isArray(k.data)?k.data:[],Se=Array.isArray(I.data)?I.data:[];b.forEach((i,L)=>{const J=Se.find(Q=>Q.TimeStr===i.GTName&&Q.ParametersID===i.ParametersID);J&&(b[L]={...i,...J})});const ke=b.map((i,L)=>({"â„–":L+1,Smena:i.Change,"Tartib raqami":i.OrderNumber,Parametrlar:q.value==="ru"?i.PNameRus:i.PName,"Boshlanish soati":i.STime,"Tugash soati":i.ETime,Min:i.Min,Max:i.Max,Qiymat:i.Value,Izoh:i.Comment})),Re=G.json_to_sheet(ke);G.book_append_sheet(e,Re,u.Name.substring(0,31))}catch(h){console.error(`Xatolik sahifa "${u.Name}" uchun:`,h)}const a=((l=n.value)==null?void 0:l.day)??"unknown",t=((r=n.value)==null?void 0:r.smena)??"X";ze(e,`Export-${a}-smena${t}.xlsx`)},j=R(()=>H("create"));R(()=>H("view"));const de=Y({id:"",Comment:"",Value:"",userId:c.state.user.id}),W=R(()=>[{headerName:d("table.headerRow"),valueGetter:"node.rowIndex + 1",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=y.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=y.value)==null?void 0:t[a.data.id])&&((l=y.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"}},{headerName:d("table.change"),field:"Change",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.OrderNumber"),field:"OrderNumber",width:80,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.parameters"),field:q.value==="ru"?"PNameRus":"PName",flex:1,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.graphictimes"),headerClass:"header-center",children:[{headerName:d("table.startingTime"),field:"STime",width:120,valueFormatter:a=>T(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.endingTime"),field:"ETime",width:120,valueFormatter:a=>T(new Date(`1970-01-01T${a.value}`),"HH:mm"),headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.interval"),headerClass:"header-center",children:[{headerName:d("table.min"),field:"Min",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0},{headerName:d("table.max"),field:"Max",width:100,headerClass:"header-center",editable:!1,suppressNavigable:!0}]},{headerName:d("table.value"),field:"Value",width:150,editable:a=>j.value&&a.data.WithFormula!=="1",suppressNavigable:!1,cellEditor:"agNumberCellEditor",cellEditorPopup:!1,cellClassRules:{"cell-green":a=>{var t;return a.data&&a.data.Value===((t=y.value)==null?void 0:t[a.data.id])},"cell-yellow":a=>{var t,l;return a.data&&a.data.Value!==((t=y.value)==null?void 0:t[a.data.id])&&((l=y.value)==null?void 0:l[a.data.id])===void 0&&a.data.WithFormula!=="1"},"cell-pink":a=>a.data&&a.data.WithFormula==="1"},cellStyle:()=>({"font-size":"16px","text-align":"center"}),headerClass:"header-center"},{headerName:d("table.comment"),field:"Comment",flex:1,editable:()=>j.value,suppressNavigable:!1,cellEditor:"agLargeTextCellEditor",cellEditorPopup:!0,headerClass:"header-center"}]);E(f,e=>{e.length>0&&(s.value=e[0].NumberPage)},{immediate:!0}),E(n,e=>{N(s.value)},{deep:!0});const ce=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(f.value.length):parseInt(s.value)<f.value.length?s.value=String(parseInt(s.value)+1):s.value="1")},me=e=>{(e.key==="ArrowUp"||e.key==="ArrowDown"||e.key==="ArrowLeft"||e.key==="ArrowRight")&&(e.preventDefault(),document.activeElement.classList.contains("ag-cell")&&m.navigateToNextCell({key:e.key}))},fe=()=>{window.addEventListener("keydown",e=>{e.key===" "&&ve(e),["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&me(e)})},ve=e=>{e.key===" "&&(e.preventDefault(),e.shiftKey?parseInt(s.value)>1?s.value=String(parseInt(s.value)-1):s.value=String(f.value.length):parseInt(s.value)<f.value.length?s.value=String(parseInt(s.value)+1):s.value="1")};function he(){const e=U.value;document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}const X=async()=>{try{const e=await v.get("/changes"),a=await v.get(`/pages-select/${F.id}`);f.value=a.data;const t=await v.get(`/paramWithId/${F.id}`);re.value=e.data.map(l=>({value:l.Change,text:l.Change})),oe.value=t.data.map(l=>({value:l.Pid,text:l.PName}))}catch(e){console.error("Error fetching graphics data:",e)}},ge={sortable:!0,filter:!0,resizable:!0},pe=e=>e.data.STime&&e.data.ETime&&e.data.Value?"row-green":"",ye={columnDefs:W.value,suppressScrollOnNewData:!0,getRowClass:pe,headerHeight:27,rowHeight:30,navigateToNextCell:e=>{const{key:a}=e.event;return a==="ArrowUp"||a==="ArrowDown"||a==="ArrowLeft"||a==="ArrowRight"?!0:e.previousCellDef}},we=e=>{},be=()=>{const e=new Date;return e.getHours()*60+e.getMinutes()},Ce=()=>{const e=be();return e>=Qe&&e<=Ye?1:2},Ne=()=>{se.push("/vparamsget")};ue.Change=Ce();async function N(e){try{const a=n.value.day,t=n.value.smena,[l,r]=await v.all([v.get(`/get-params-for-user/${F.id}/${t}/${a}/${e}`),v.get(`/vparams-value/${c.state.user.structure_id}/${a}/${t}`)]),u=Array.isArray(l.data)?l.data:[],h=Array.isArray(r.data)?r.data:[];u.forEach((g,k)=>{const I=h.find(b=>b.TimeStr==g.GTName&&b.ParametersID==g.ParametersID);I&&(u[k]={...g,...I})}),$.value=Array.isArray(u)?u:[]}catch(a){console.error("Error fetching data:",a),$.value=[]}}const Ve=async e=>{const{data:a,colDef:t,newValue:l,oldValue:r}=e;if(l!==r)try{await xe(a,s.value);const u=e.rowIndex,h=m.value.getDisplayedRowCount();if(m.value&&m.value.ensureIndexVisible(u,"bottom"),u<h-1){m.value.stopEditing();const g=t.field==="Value"?"Value":"Comment";m.value.setFocusedCell(u+1,g)}}catch(u){console.error("Error saving data",u)}},xe=async(e,a)=>{const t=n.value.smena,l=n.value.day;try{const r=await v.post("/vparams",{...e,userId:ne,change:t,daySelect:l});return Ie(),await N(a),r}catch(r){console.error("Error saving data",r)}},Ie=()=>{m.value&&m.value.clearFocusedCell()},Ee=()=>{S.value&&m.value&&(m.value.stopEditing(),S.value=!1)};let V=null,x=null,S=o(!1);const De=e=>{const{column:a}=e;if(a){const t=a.getColId();t==="Value"||t==="Comment"?(M(),S.value=!0,w.value&&clearTimeout(w.value),w.value=setTimeout(Ee,6e4)):P()}},Te=e=>{const{column:a}=e;if(a){const t=a.getColId();(t==="Value"||t==="Comment")&&(M(),S.value=!1,w.value&&(clearTimeout(w.value),w.value=null))}},P=()=>{V||(c.state.newValue=c.state.newValue||1,V=setInterval(()=>N(c.state.newValue),6e4)),x||(x=setInterval(X,6e4))},M=()=>{V&&(clearInterval(V),V=null),x&&(clearInterval(x),x=null)},Fe=e=>{console.log(e),m.value=e.api,e.api.addEventListener("cellFocused",De),e.api.addEventListener("cellBlurred",Te),P()};return E(s,e=>{N(e)}),Pe(()=>{const e=new Date,a=e.getHours(),t=e.getMinutes();if(a>=8&&a<20||a===19&&t<=59)n.value.smena=1,n.value.day=T(e,"yyyy-MM-dd");else if(n.value.smena=2,a<8){const l=new Date(e);l.setDate(e.getDate()-1),n.value.day=T(l,"yyyy-MM-dd")}else n.value.day=T(e,"yyyy-MM-dd");N(s.value),X(),P(),fe()}),E(f,e=>{e.length>0&&(s.value=e[0].NumberPage)},{immediate:!0}),Me(()=>{M()}),(e,a)=>{const t=Z("VaTab"),l=Z("ag-grid-vue");return _(),ee("div",je,[a[4]||(a[4]=D("main",null,null,-1)),D("main",We,[D("div",Xe,[p(C(He),{modelValue:n.value,"onUpdate:modelValue":a[1]||(a[1]=r=>n.value=r),"with-slot":!0},{default:A(()=>[p(C(Be),{modelValue:K.value,"onUpdate:modelValue":a[0]||(a[0]=r=>K.value=r),label:"Smena",readonly:""},null,8,["modelValue"])]),_:1},8,["modelValue"]),D("div",Je,[p(C(B),{onClick:ie,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"file_download"},{default:A(()=>a[3]||(a[3]=[te(" Export Excel ")])),_:1}),p(C(B),{onClick:he,class:"btn btn-primary items-center justify-center mt-3 ml-3 w-10",icon:"fullscreen"}),p(C(B),{onClick:Ne,class:"btn btn-primary items-center justify-center mt-3 ml-3",icon:"grade"})])]),D("div",{ref_key:"gridContainer",ref:U,class:"ag-grid-container h-full"},[p(C(Oe),{modelValue:s.value,"onUpdate:modelValue":a[2]||(a[2]=r=>s.value=r),stateful:"",grow:"",onKeydown:ce,tabindex:"0"},{tabs:A(()=>[(_(!0),ee(Ge,null,qe(f.value,r=>(_(),ae(t,{key:r.NumberPage,name:r.NumberPage},{default:A(()=>[te(Ke(r.Name),1)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),p(l,{rowData:$.value,columnDefs:W.value,defaultColDef:ge,gridOptions:ye,animateRows:"true",class:"ag-theme-material h-full",onGridReady:Fe,onCellValueChanged:Ve},null,8,["rowData","columnDefs"])],512),O.value?(_(),ae(Ue,{key:0,showModalEdit:O.value,resultEdit:de,onUpdate:we},null,8,["showModalEdit","resultEdit"])):Le("",!0)])])}}};export{ra as default};
