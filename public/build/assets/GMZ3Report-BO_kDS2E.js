import{u as pe,r as V,o as ge,L as U,g as me,h as be,i as T,j as X,l as ye,x as he,k as Q,z as we,aj as ke,n as O}from"./app-B2nVOe3v.js";import{j as _e}from"./jsuites-DQSEhFye.js";import"./_commonjs-dynamic-modules-TDtrdbi3.js";const Ie={class:"p-3 pt-28"},Se={class:"flex items-center gap-3 mb-3"},D=303,Ve={__name:"GMZ3Report",setup(xe){const{init:M}=pe(),R=V(null),k=V(new Date);let s=null;const q=V([]),L=V({});let S=!1;const x=V(new Map);let G=!1;const $=V([]),j=n=>{const e=new Date(n);return`${String(e.getDate()).padStart(2,"0")}.${String(e.getMonth()+1).padStart(2,"0")}.${e.getFullYear()}`};async function ee(){try{const{data:n}=await O.get(`/static-with-numberpage/${D}`),e=Array.isArray(n)?n:n.items||[];$.value=e}catch(n){console.error(n),M({message:"Static parametrlarni yuklashda xatolik",color:"danger"})}}function te(n){const e=new Date(n),r=String(e.getDate()).padStart(2,"0"),o=String(e.getMonth()+1).padStart(2,"0"),i=e.getFullYear();return`${r}.${o}.${i}`}function C(n){let e="",r=n;for(;r>=0;)e=String.fromCharCode(r%26+65)+e,r=Math.floor(r/26)-1;return e}function K(n){const e=n.match(/^([A-Z]+)(\d+)$/),r=+e[2]-1;let o=0;for(const i of e[1])o=o*26+(i.charCodeAt(0)-64);return{x:o-1,y:r}}function E(n){const[e,r]=n.split(":"),o=K(e),i=K(r);return{row:Math.min(o.y,i.y),col:Math.min(o.x,i.x),rowspan:Math.abs(o.y-i.y)+1,colspan:Math.abs(o.x-i.x)+1}}async function ne(){try{const{data:n}=await O.get("/periodType");q.value=Array.isArray(n)?n:n.items||[]}catch(n){console.error(n),M({message:"Period turlarini yuklashda xatolik",color:"danger"})}}function re(){const n=new Map((q.value||[]).map(d=>[String(d.id),String(d.name||"").trim()])),e=[...new Set(($.value||[]).map(d=>d==null?void 0:d.period_type_id).filter(d=>d!=null).map(String))],r=d=>{const f=String(d||"").trim().toLowerCase();return["kun","kunlik","sutka","sutkalik"].includes(f)?"Kunlik":["oy","oylik","mes","mesyachniy","mesyachnyy","mesyach"].includes(f)?"Oylik":d?d.charAt(0).toUpperCase()+d.slice(1):""},o=d=>{const f=e.find(t=>new RegExp(d,"i").test(n.get(t)||""));return f?r(n.get(f)):null};let i=o("kun|sutk"),l=o("oy|mes");if(!i&&e.includes("1")&&(i="Kunlik"),!l&&e.includes("2")&&(l="Oylik"),!i||!l){const d=[...e].sort((f,t)=>Number(f)-Number(t));if(!i&&d[0]&&(i=r(n.get(d[0])||"Kunlik")),!l){const f=d.find(t=>t!==d[0])||d[0];l=r(n.get(f)||"Oylik")}}return i===l&&(i==="Kunlik"?l="Oylik":l==="Oylik"?i="Kunlik":(i="Kunlik",l="Oylik")),{dailyLabel:i,monthlyLabel:l}}async function B(){G=!0,x.value.clear(),x.value=new Map;const n=se($.value),e=n.reduce((a,g)=>a+g.groups.reduce((b,m)=>b+m.params.length,0),0),r=n.reduce((a,g)=>a+g.groups.filter(b=>!!b.gName).length,0),o=n.length*2,i=7+e+r+o+5,l=150,d=Math.max(i,300),f=Array.from({length:d},()=>Array(l).fill(""));s&&(s.destroy(),s=null),s=_e(R.value,{data:f,columns:Array.from({length:l},(a,g)=>({title:C(g),width:g===0?520:g===1?120:110})),minDimensions:[l,d],allowInsertColumn:!1,allowInsertRow:!1,allowDeleteColumn:!1,allowDeleteRow:!1,textOverflow:!0,merge:[E("A1:F1"),E("A2:F2"),E("B4:B5"),E("C4:E4")],onchange:async(a,g,b,m,y)=>{if(S||G)return;const w=Number(m)+1,_=Number(b),I=`${C(_)}${w}`;if(!(!x.value.get(w)||!W(_)))try{typeof y=="string"&&y.trim().startsWith("=")?(await ce(I,y.trim()),await new Promise(A=>requestAnimationFrame(A)),await z(I,{toast:!0})):await z(I,{toast:!0})}catch(A){console.error(A),M({message:"Saqlashda xatolik",color:"danger"})}}}),s.setValue("A1","GMZ-3 bo‘yicha asosiy ko‘rsatkichlar:"),s.setValue("A2",`${te(k.value)} y.`),s.setValue("A3","—"),s.setValue("A4","Ko'rsatgichlar nomi."),s.setValue("B4","o'lchov birligi");const{dailyLabel:t,monthlyLabel:u}=re();console.log(t,u),s.setValue("C4",t),s.setValue("C5","reja"),s.setValue("D4",t),s.setValue("D5","fakt/20:08"),s.setValue("E4",t),s.setValue("E5","fakt/08:20"),s.setValue("F4",t),s.setValue("F5","fakt jami"),s.setValue("G4",""),s.setValue("G5","%"),s.setValue("H4",u),s.setValue("H5","reja"),s.setValue("I4",u),s.setValue("I5","fakt"),s.setValue("J4",u),s.setValue("J5","%"),s.setStyle({A1:"font-weight:bold;font-size:18px;",A2:"font-weight:600;",A4:"background:#f5f5c6;font-weight:bold;border:1px solid #bdbdbd;text-align:left;",B4:"background:#e9ecef;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C4:"background:#e6f4ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",C5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",D4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",E5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",F5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",G5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",H5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",I5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J4:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;",J5:"background:#eef7ff;font-weight:bold;border:1px solid #bdbdbd;text-align:center;"});const c={};["A","B","C","D","E","F"].forEach(a=>c[`${a}4`]="border:1px solid #bdbdbd;"),["B","C","D","E"].forEach(a=>c[`${a}5`]="border:1px solid #bdbdbd;"),s.setStyle(c);function h(a,g){try{typeof s.setMerge=="function"&&s.setMerge(`A${a}`,10,1)}catch{}const b={};for(let m=0;m<=9;m++)b[`${C(m)}${a}`]=g;s.setStyle(b)}let p=7;for(const a of n){s.setValue(`A${p}`,a.fsName),h(p,"background:#f1f5f9;font-weight:700;border:1px solid #bdbdbd;text-align:left;padding-left:6px;"),s.setHeight(p-1,28),p++;for(const g of a.groups){g.gName&&(s.setValue(`A${p}`,g.gName),le(p,"background:#fff7e6;font-weight:600;border:1px solid #e0e0e0;text-align:left;padding-left:8px;"),s.setHeight(p-1,26),p++);for(const b of g.params){x.value.set(p,{fsId:b.fsId,groupId:b.groupId,parameterId:b.parameterId}),x.value.set(p,{fsId:b.fsId,groupId:b.groupId,parameterId:b.parameterId}),s.setValue(`A${p}`,b.name),s.setValue(`B${p}`,b.unit);const m={};m[`A${p}`]="border:1px solid #dddddd;padding-left:6px;",m[`B${p}`]="border:1px solid #dddddd;text-align:center;",["C","D","E"].forEach(y=>{m[`${y}${p}`]="border:1px solid #dddddd;text-align:center;color:#b60000;font-weight:600;"}),s.setStyle(m),s.setHeight(p-1,24),p++}}p++}s.setHeight(0,34),s.setHeight(1,28),s.setHeight(3,28),s.setHeight(4,24),await ae(),await ue(),await new Promise(a=>requestAnimationFrame(a)),fe([4,5]),G=!1}async function oe(n,e,r){const{data:o}=await O.get("/sheet/value",{params:{numberPage:n,cell:e,date:j(r)}});return Number((o==null?void 0:o.value)??0)}function J(){const n=new Map((q.value||[]).map(l=>[String(l.id),String(l.name||"").trim().toLowerCase()])),e=[...new Set(($.value||[]).map(l=>l==null?void 0:l.period_type_id).filter(l=>l!=null).map(String))],r=l=>e.find(d=>l.some(f=>(n.get(d)||"").includes(f)));let o=r(["kun","sutk"])||(e.includes("1")?"1":null),i=r(["oy","mes"])||(e.includes("2")?"2":null);return!o&&e.length&&(o=e[0]),!i&&e.length&&(i=e.find(l=>l!==o)||e[0]),{dailyId:Number(o),monthlyId:Number(i)}}function N(n){const e=new Date(n);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function Z(n){const e=new Date(n),r=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,0);return{start:N(r),end:N(o)}}function W(n){const e=C(n);return["C","D","E","F","G"].includes(e)?"daily":["H","I","J"].includes(e)?"monthly":null}async function ae(){const n=$.value||[];if(!n.length)return;const{dailyId:e,monthlyId:r}=J(),o=N(k.value),{start:i,end:l}=Z(k.value),d=new Map;for(const[t,u]of x.value.entries())d.set(String(u.parameterId),t);const f=S;S=!0;for(const t of n){const u=String(t.ParameterID||""),c=d.get(u);if(!c)continue;const h=Number(t.period_type_id),p=String(t.period_start_date||""),a=String(t.period_end_date||p||"");if(!(h===e&&p===o&&a===o)&&!(h===r&&p===i&&a===l))continue;const m=t.Comment||(h===e?"daily_plan":"monthly_plan"),y=de(m);y&&s.setValue(`${y}${c}`,t.value)}S=f}function se(n){const e=t=>{const u=String(t??"").trim().toLowerCase();if(u===""||u==="null"||u==="undefined")return null;const c=Number(u);return Number.isFinite(c)?c:null};let r=0;const o=new Map,i=new Set;for(const t of n||[]){const u=r++,c=(t==null?void 0:t.FactoryStructureID)??null,h=(t==null?void 0:t.FSName)||(c!=null?`Struktura #${c}`:"Struktura"),p=e(t==null?void 0:t.OrderNumberSex);let a=(t==null?void 0:t.GroupID)??null;const g=t==null?void 0:t.GName,b=!!String(g??"").trim();a!=null&&!b&&(a=null);const m=b?g:null,y=e(t==null?void 0:t.OrderNumberGroup),w=(t==null?void 0:t.ParameterID)??(t==null?void 0:t.id)??(t==null?void 0:t.Uuid);if(w&&i.has(`${c}:${a}:${w}`))continue;w&&i.add(`${c}:${a}:${w}`);const _=(t==null?void 0:t.PName)||(t==null?void 0:t.Name)||`Param ${w}`,I=(t==null?void 0:t.UName)||"",P=e(t==null?void 0:t.OrderNumber);o.has(c)||o.set(c,{fsId:c,fsName:h,fsOrder:p,seq:u,groups:new Map});const v=o.get(c);v.fsOrder==null&&p!=null&&(v.fsOrder=p),v.seq=Math.min(v.seq,u);const A=a==null?"zzz_nogroup":`g_${a}`;v.groups.has(A)||v.groups.set(A,{groupId:a,gName:m,gOrder:y,seq:u,params:[]});const F=v.groups.get(A);F.gOrder==null&&y!=null&&(F.gOrder=y),F.seq=Math.min(F.seq,u),F.params.push({name:_,unit:I,fsId:c,groupId:a,parameterId:w,pOrder:P,seq:u})}let l=Array.from(o.values());const d=l.filter(t=>t.fsOrder!=null).sort((t,u)=>t.fsOrder-u.fsOrder||t.seq-u.seq),f=l.filter(t=>t.fsOrder==null).sort((t,u)=>t.seq-u.seq);return l=[...d,...f],l.forEach(t=>{const u=Array.from(t.groups.values()),c=u.filter(a=>a.groupId!=null&&a.gOrder!=null).sort((a,g)=>a.gOrder-g.gOrder||a.seq-g.seq),h=u.filter(a=>a.groupId!=null&&a.gOrder==null).sort((a,g)=>a.seq-g.seq),p=u.filter(a=>a.groupId==null).sort((a,g)=>a.seq-g.seq);t.groups=[...c,...h,...p],t.groups.forEach(a=>{const g=a.params.filter(m=>m.pOrder!=null).sort((m,y)=>m.pOrder-y.pOrder||m.seq-y.seq),b=a.params.filter(m=>m.pOrder==null).sort((m,y)=>m.seq-y.seq);a.params=[...g,...b]})}),l}function le(n,e){for(let o=1;o<=9;o++)s.setValueFromCoords(o,n-1,"");const r={};for(let o=0;o<=9;o++)r[`${C(o)}${n}`]=e;s.setStyle(r)}async function Y(n,e){let r=String(n).trim();const o=/REF\(\s*(\d+)\s*,\s*"([A-Z]+\d+)"\s*\)/g,i=/'?(\d+)'?\!([A-Z]+\d+)/g,l=[];r.replace(o,(t,u,c)=>(l.push({page:+u,cell:c}),"")),r.replace(i,(t,u,c)=>(l.push({page:+u,cell:c}),""));const d=await Promise.all(l.map(t=>oe(t.page,t.cell,e)));let f=0;return r=r.replace(o,()=>String(d[f++])),r=r.replace(i,()=>String(d[f++])),r.startsWith("=")||(r="="+r),r}function ie(n){switch(n){case"C":return"daily_plan";case"D":return"daily_fact_20_08";case"E":return"daily_fact_08_20";case"F":return"daily_fact_total";case"G":return"daily_percent";case"H":return"monthly_plan";case"I":return"monthly_fact";case"J":return"monthly_percent";default:return null}}function de(n){return{daily_plan:"C",daily_fact_20_08:"D",daily_fact_08_20:"E",daily_fact_total:"F",daily_percent:"G",monthly_plan:"H",monthly_fact:"I",monthly_percent:"J"}[n]||null}async function ce(n,e){L.value[n]=e;const r=n.match(/\d+/),o=r?Number(r[0]):null,i=o?x.value.get(o):null;await O.post("/sheet/formula",{numberPage:D,number_page:D,param_id:(i==null?void 0:i.parameterId)||null,cell:n,expr:e,scope:"permanent",date:N(k.value),for_date:null});const l=await Y(e,k.value);S=!0,s.setValue(n,l),S=!1,await new Promise(f=>requestAnimationFrame(f));const d={};d[n]="border:1px dashed #444;font-weight:600;",s.setStyle(d)}async function ue(){const{data:n}=await O.get("/sheet/formula",{params:{numberPage:D,date:j(k.value)}});((n==null?void 0:n.items)||n||[]).forEach(e=>{L.value[e.cell]=e.expr});for(const[e,r]of Object.entries(L.value))try{const o=await Y(r,k.value);S=!0,s.setValue(e,o),S=!1;const i={};i[e]="border:1px dashed #444;font-weight:600;",s.setStyle(i),await z(e)}catch(o){console.error("Formula error",e,r,o)}}let H=null;function fe(n=[4,5]){var d;H&&(H(),H=null);const e=(d=R.value)==null?void 0:d.querySelector(".jexcel_content"),r=e==null?void 0:e.querySelector("tbody");if(!e||!r)return;const o=n.map(f=>r.children[f-1]).filter(Boolean);let i=0;const l=[];o.forEach((f,t)=>{const u=f.getBoundingClientRect().height||f.offsetHeight;Array.from(f.children).forEach(c=>{const h={position:c.style.position,top:c.style.top,zIndex:c.style.zIndex,bg:c.style.backgroundColor};l.push(()=>{c.style.position=h.position,c.style.top=h.top,c.style.zIndex=h.zIndex,c.style.backgroundColor=h.bg}),c.style.position="sticky",c.style.top=`${i}px`,c.style.zIndex=String(100+t),c.style.backgroundColor="#eef7ff"}),i+=u}),H=()=>l.forEach(f=>f())}async function z(n,{toast:e=!1}={}){const r=n.match(/^([A-Z]+)(\d+)$/);if(!r)return;const o=r[1],i=Number(r[2]),l=(_=>{let I=0;for(const P of _)I=I*26+(P.charCodeAt(0)-64);return I-1})(o),d=i-1,f=x.value.get(i);if(!f)return;const{dailyId:t,monthlyId:u}=J(),c=W(l),h=c==="daily"?t:u;let p=s.getValueFromCoords(l,d,!0);typeof p=="string"&&(p=p.replace(",","."));const a=parseFloat(p),g=Number.isFinite(a)?a:null;if(g===null)return;let b,m;if(c==="daily"){const _=N(k.value);b=_,m=_}else{const{start:_,end:I}=Z(k.value);b=_,m=I}const y=ie(o),w=await O.post("/static-params/upsert",{number_page:D,factory_structure_id:f.fsId,parameter_id:f.parameterId,group_id:f.groupId,period_type_id:h,period_start_date:b,period_end_date:m,value:g,comment:y});e&&w&&w.status>=200&&w.status<300&&M({message:"Maʼlumot saqlandi",color:"success"})}return ge(async()=>{await Promise.all([ee(),ne()]),B()}),U(k,B),U([$,q],B),(n,e)=>(be(),me("div",Ie,[T("div",Se,[X(Q(we),{preset:"secondary",onClick:e[0]||(e[0]=r=>n.$router.back())},{default:ye(()=>e[2]||(e[2]=[he("← Orqaga",-1)])),_:1,__:[2]}),X(Q(ke),{modelValue:k.value,"onUpdate:modelValue":[e[1]||(e[1]=r=>k.value=r),B]},null,8,["modelValue"]),e[3]||(e[3]=T("span",{class:"text-gray-500"},"GMZ-3 bo‘yicha asosiy ko‘rsatkichlar",-1))]),T("div",{ref_key:"sheetEl",ref:R,style:{width:"100vw",height:"85vh"}},null,512)]))}};export{Ve as default};
